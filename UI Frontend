import React, { useState, useMemo, useRef, useCallback, useEffect } from 'react';
import { auth, db } from './firebase';
import {
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
} from 'firebase/auth';
import {
  collection, addDoc, query, where, orderBy, limit,
  onSnapshot, doc, updateDoc, serverTimestamp,
} from 'firebase/firestore';

const DaylightJournal = () => {
  const [currentView, setCurrentView] = useState('home');
  const [selectedHistoryDay, setSelectedHistoryDay] = useState(null);
  const [quickNote, setQuickNote] = useState('');
  const [selectedGoal, setSelectedGoal] = useState(null);
  const [dreamSubmitted, setDreamSubmitted] = useState(false);
  const [eveningSubmitted, setEveningSubmitted] = useState(false);

  // Auth + splash
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [showSplash, setShowSplash] = useState(true);
  const [authEmail, setAuthEmail] = useState('');
  const [authPassword, setAuthPassword] = useState('');
  const [authMode, setAuthMode] = useState('signin');
  const [authError, setAuthError] = useState('');

  // Use refs to store text values without causing re-renders
  const dreamRef = useRef(null);
  const eveningRef = useRef(null);
  const [dreamText, setDreamText] = useState('');
  const [eveningText, setEveningText] = useState('');
  const [showAISuggestions, setShowAISuggestions] = useState(false);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiSuggestions, setAiSuggestions] = useState(null);

  // Goals state
  const [userGoals, setUserGoals] = useState([]);
  const [newGoalText, setNewGoalText] = useState('');
  const [aiMicroGoals, setAiMicroGoals] = useState([]);
  const [generatingGoals, setGeneratingGoals] = useState(false);

  // Real time-of-day (replaces demo toggle)
  const [demoTime] = useState(() => {
    const hour = new Date().getHours();
    if (hour >= 5 && hour < 12) return 'morning';
    if (hour >= 12 && hour < 17) return 'afternoon';
    return 'evening';
  });

  // Firestore-driven data
  const [firestoreEntries, setFirestoreEntries] = useState([]);
  const [todayDreamEntryId, setTodayDreamEntryId] = useState(null);
  const [dreamSaving, setDreamSaving] = useState(false);
  const [eveningSaving, setEveningSaving] = useState(false);

  // ---- Effects ----

  // Splash screen: hide after 2.2s
  useEffect(() => {
    const timer = setTimeout(() => setShowSplash(false), 2200);
    return () => clearTimeout(timer);
  }, []);

  // Auth state observer
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (firebaseUser) => {
      setUser(firebaseUser || false);
      setAuthLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // Firestore entries listener
  useEffect(() => {
    if (!user) return;
    const q = query(
      collection(db, 'users', user.uid, 'entries'),
      orderBy('timestamp', 'desc'),
      limit(30)
    );
    const unsubscribe = onSnapshot(q, (snap) => {
      setFirestoreEntries(snap.docs.map(d => ({
        id: d.id,
        ...d.data(),
        date: d.data().timestamp?.toDate() || new Date(),
      })));
    });
    return () => unsubscribe();
  }, [user]);

  // Firestore goals listener ‚Äî today only
  useEffect(() => {
    if (!user) return;
    const today = new Date().toISOString().split('T')[0];
    const q = query(
      collection(db, 'users', user.uid, 'goals'),
      where('dateString', '==', today),
      orderBy('createdAt', 'asc')
    );
    const unsubscribe = onSnapshot(q, (snap) => {
      const goals = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setAiMicroGoals(goals.filter(g => g.source === 'ai'));
      setUserGoals(goals.filter(g => g.source === 'user'));
    });
    return () => unsubscribe();
  }, [user]);

  // ---- Auth handlers ----

  const handleAuthSubmit = async (e) => {
    e.preventDefault();
    setAuthError('');
    try {
      if (authMode === 'signin') {
        await signInWithEmailAndPassword(auth, authEmail, authPassword);
      } else {
        await createUserWithEmailAndPassword(auth, authEmail, authPassword);
      }
    } catch (err) {
      setAuthError(
        err.message.replace('Firebase: ', '').replace(/ \(auth\/.*?\)\.?/, '')
      );
    }
  };

  // ---- Data ----

  // Merge Firestore entries into the shape views expect
  const entries = useMemo(() => {
    const byDate = {};
    firestoreEntries.forEach(entry => {
      const key = entry.dateString;
      if (!byDate[key]) {
        byDate[key] = { date: entry.date, dateString: key, empty: false };
      }
      if (entry.type === 'dream') byDate[key].dream = entry.text;
      if (entry.type === 'journal') {
        byDate[key].reflection = entry.text;
        byDate[key].mood = entry.mood || 'peaceful';
        byDate[key].gratitude = entry.aiResult?.insight || '';
      }
    });
    return Object.values(byDate).sort(
      (a, b) => new Date(a.dateString) - new Date(b.dateString)
    );
  }, [firestoreEntries]);

  // Calculate dominant mood from recent entries for theme
  const recentMood = useMemo(() => {
    const recent = entries.slice(-7).filter(e => !e.empty && e.mood);
    if (recent.length === 0) return 'peaceful';
    const moodCounts = {};
    recent.forEach(e => { moodCounts[e.mood] = (moodCounts[e.mood] || 0) + 1; });
    return Object.entries(moodCounts).sort((a, b) => b[1] - a[1])[0][0];
  }, [entries]);

  // Theme colors based on mood
  const themes = {
    peaceful:   { bg: '#12161c', accent: '#6aadcf', text: '#d0dce5', subtle: '#1a2230', card: '#1e2736' },
    energetic:  { bg: '#1c1412', accent: '#cf8a6a', text: '#e5d8d0', subtle: '#2a1e1a', card: '#362820' },
    reflective: { bg: '#18141c', accent: '#a68acf', text: '#ddd0e5', subtle: '#241a2a', card: '#2e2236' },
    grateful:   { bg: '#121c16', accent: '#6acf8a', text: '#d0e5d8', subtle: '#1a2a1e', card: '#203628' },
    creative:   { bg: '#1c1a12', accent: '#cfba6a', text: '#e5e0d0', subtle: '#2a281a', card: '#363220' },
    calm:       { bg: '#141c18', accent: '#6acfba', text: '#d0e5e0', subtle: '#1a2a26', card: '#203630' },
    inspired:   { bg: '#1a1418', accent: '#cf6aa6', text: '#e5d0dd', subtle: '#2a1a24', card: '#36202e' },
    cozy:       { bg: '#1a1814', accent: '#cfaa6a', text: '#e5ddd0', subtle: '#2a2620', card: '#363020' },
  };

  const theme = themes[recentMood] || themes.peaceful;

  const streak = useMemo(() => {
    const dates = new Set(firestoreEntries.map(e => e.dateString));
    return dates.size;
  }, [firestoreEntries]);

  const formatDate = (date) => {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    if (date.toDateString() === today.toDateString()) return 'Today';
    if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  };

  // Simulated AI analysis for afternoon view
  const generateAISuggestions = () => {
    setAiLoading(true);
    setTimeout(() => {
      setAiSuggestions({
        insight: "I noticed you've been dreaming about open spaces and freedom lately, and your reflections mention feeling most alive during creative moments. There's a pattern of seeking expansion.",
        goals: [
          { type: 'creative', icon: '‚úèÔ∏è', title: 'Write for 10 minutes', description: 'Spend 10 minutes on a creative project or idea you\'ve been putting off.', why: 'Based on your recent entries' },
          { type: 'mindful', icon: 'üßò', title: 'Morning walk without phone', description: 'Your dreams have featured open landscapes. Try a 15-minute walk, just observing.', why: 'Based on recurring dream themes' },
          { type: 'connection', icon: 'üí¨', title: 'Reach out to someone', description: "Send a quick message to someone you've been thinking about.", why: 'Based on your reflection patterns' },
          { type: 'explore', icon: 'üîç', title: 'Try something new', description: 'Visit a place in your city you\'ve never been, even just for 20 minutes.', why: 'Based on your gratitude patterns' },
        ],
        reflection_prompts: [
          "What would your dream-self from last night want you to do today?",
          "What creates a feeling of peace for you?",
          "If you could give yourself permission to do one thing today, what would it be?"
        ]
      });
      setAiLoading(false);
    }, 1500);
  };

  // ---- Submission handlers ----

  const handleDreamSubmission = async () => {
    const val = dreamRef.current?.value || '';
    if (!val.trim()) return;
    setDreamText(val);
    setDreamSubmitted(true);
    setDreamSaving(true);
    try {
      const today = new Date().toISOString().split('T')[0];
      const docRef = await addDoc(
        collection(db, 'users', user.uid, 'entries'),
        { userId: user.uid, type: 'dream', text: val, dateString: today, timestamp: serverTimestamp() }
      );
      setTodayDreamEntryId(docRef.id);
      await fetch('https://nocturne-87c33.cloudfunctions.net/generateGoalFromDream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dreamText: val, userId: user.uid, entryId: docRef.id }),
      });
      // Goals are saved to Firestore by the function; onSnapshot updates aiMicroGoals automatically
    } catch (err) {
      console.error('Dream submission error:', err);
    } finally {
      setDreamSaving(false);
    }
  };

  const handleEveningSubmission = async () => {
    const val = eveningRef.current?.value || '';
    if (!val.trim()) return;
    setEveningText(val);
    setEveningSubmitted(true);
    setEveningSaving(true);
    try {
      const today = new Date().toISOString().split('T')[0];
      const docRef = await addDoc(
        collection(db, 'users', user.uid, 'entries'),
        { userId: user.uid, type: 'journal', text: val, dateString: today, timestamp: serverTimestamp() }
      );
      await fetch('https://nocturne-87c33.cloudfunctions.net/processJournalEntry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ journalText: val, userId: user.uid, entryId: docRef.id, dateString: today }),
      });
    } catch (err) {
      console.error('Evening submission error:', err);
    } finally {
      setEveningSaving(false);
    }
  };

  // ---- Splash Screen ----

  const SplashScreen = () => (
    <div style={{
      position: 'fixed',
      inset: 0,
      background: '#12161c',
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 9999,
      animation: 'splashFade 2.2s ease forwards',
    }}>
      <style>{`
        @keyframes splashFade {
          0%   { opacity: 1; }
          75%  { opacity: 1; }
          100% { opacity: 0; pointer-events: none; }
        }
      `}</style>
      <img src="/logo.png" alt="Nocturne" style={{ width: '160px', objectFit: 'contain' }} />
    </div>
  );

  // ---- Sign In View ----

  const SignInView = () => (
    <div style={{
      minHeight: '100vh',
      background: '#12161c',
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      padding: '40px 20px',
      fontFamily: '"Fira Code", monospace',
    }}>
      <style>{`@import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap');`}</style>
      <img src="/logo.png" alt="Nocturne" style={{ width: '100px', marginBottom: '28px', objectFit: 'contain' }} />
      <h1 style={{ fontSize: '22px', color: '#d0dce5', fontWeight: 500, margin: '0 0 6px 0' }}>Nocturne</h1>
      <p style={{ fontSize: '13px', color: '#d0dce5', opacity: 0.4, margin: '0 0 36px 0' }}>
        Your dream & reflection journal
      </p>

      <form onSubmit={handleAuthSubmit} style={{ width: '100%', maxWidth: '360px', display: 'flex', flexDirection: 'column', gap: '12px' }}>
        <input
          type="email"
          placeholder="Email"
          value={authEmail}
          onChange={e => setAuthEmail(e.target.value)}
          required
          style={{
            padding: '14px 16px',
            background: '#1e2736',
            border: '1px solid #1a2230',
            borderRadius: '12px',
            color: '#d0dce5',
            fontFamily: '"Fira Code", monospace',
            fontSize: '13px',
            outline: 'none',
          }}
        />
        <input
          type="password"
          placeholder="Password"
          value={authPassword}
          onChange={e => setAuthPassword(e.target.value)}
          required
          style={{
            padding: '14px 16px',
            background: '#1e2736',
            border: '1px solid #1a2230',
            borderRadius: '12px',
            color: '#d0dce5',
            fontFamily: '"Fira Code", monospace',
            fontSize: '13px',
            outline: 'none',
          }}
        />
        {authError && (
          <p style={{ color: '#cf6a6a', fontSize: '12px', margin: 0, textAlign: 'center' }}>{authError}</p>
        )}
        <button
          type="submit"
          style={{
            padding: '16px',
            background: 'linear-gradient(135deg, #6aadcf 0%, #6aadcfcc 100%)',
            color: '#12161c',
            border: 'none',
            borderRadius: '12px',
            fontFamily: '"Fira Code", monospace',
            fontSize: '14px',
            fontWeight: 500,
            cursor: 'pointer',
            marginTop: '4px',
          }}
        >
          {authMode === 'signin' ? 'Sign in ‚Üí' : 'Create account ‚Üí'}
        </button>
      </form>

      <button
        onClick={() => { setAuthMode(m => m === 'signin' ? 'signup' : 'signin'); setAuthError(''); }}
        style={{
          marginTop: '20px',
          background: 'transparent',
          border: 'none',
          color: '#6aadcf',
          fontSize: '12px',
          cursor: 'pointer',
          fontFamily: '"Fira Code", monospace',
          opacity: 0.8,
        }}
      >
        {authMode === 'signin' ? "Don't have an account? Sign up" : 'Already have an account? Sign in'}
      </button>
    </div>
  );

  // ---- Nav Bar ----

  const NavBar = () => (
    <nav style={{
      position: 'fixed',
      bottom: 0,
      left: 0,
      right: 0,
      background: `linear-gradient(to top, ${theme.bg} 0%, ${theme.bg}dd 100%)`,
      borderTop: `1px solid ${theme.subtle}`,
      padding: '14px 0 30px 0',
      display: 'flex',
      justifyContent: 'space-around',
      backdropFilter: 'blur(20px)',
      zIndex: 100,
    }}>
      {[
        { id: 'home', icon: '‚óê', label: 'today' },
        { id: 'goals', icon: '‚óé', label: 'goals' },
        { id: 'history', icon: '‚ó´', label: 'history' },
        { id: 'wrapped', icon: '‚ú¶', label: 'wrapped' },
      ].map(item => (
        <button
          key={item.id}
          onClick={() => { setCurrentView(item.id); setSelectedHistoryDay(null); }}
          style={{
            background: currentView === item.id ? theme.card : 'transparent',
            border: 'none',
            cursor: 'pointer',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            gap: '6px',
            opacity: currentView === item.id ? 1 : 0.5,
            transition: 'all 0.3s ease',
            padding: '10px 20px',
            borderRadius: '12px',
          }}
        >
          <span style={{ fontSize: '18px', color: currentView === item.id ? theme.accent : theme.text }}>{item.icon}</span>
          <span style={{ fontFamily: '"Fira Code", monospace', fontSize: '10px', color: theme.text, letterSpacing: '0.02em' }}>{item.label}</span>
        </button>
      ))}
    </nav>
  );

  const Chip = ({ text, onClick }) => (
    <button
      onClick={onClick}
      style={{
        background: theme.card,
        border: `1px solid ${theme.subtle}`,
        borderRadius: '8px',
        padding: '10px 14px',
        fontFamily: '"Fira Code", monospace',
        fontSize: '12px',
        color: theme.text,
        opacity: 0.8,
        cursor: 'pointer',
        whiteSpace: 'nowrap',
        transition: 'all 0.2s ease',
      }}
      onMouseEnter={e => { e.target.style.opacity = '1'; e.target.style.borderColor = theme.accent; }}
      onMouseLeave={e => { e.target.style.opacity = '0.8'; e.target.style.borderColor = theme.subtle; }}
    >
      {text}
    </button>
  );

  // ---- Home View ----

  const HomeView = () => {
    const greeting = demoTime === 'morning'
      ? { symbol: '‚òÄÔ∏è', text: 'Good morning', sub: 'Capture your dreams before they fade' }
      : demoTime === 'afternoon'
      ? { symbol: 'üå§', text: 'Good afternoon', sub: "How's your day going?" }
      : { symbol: 'üåô', text: 'Good evening', sub: 'Time to reflect on your day' };

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
        {/* Header */}
        <div style={{ textAlign: 'center', paddingTop: '60px', fontFamily: '"Fira Code", monospace' }}>
          <img
            src="/logo.png"
            alt="Nocturne"
            style={{ width: '64px', height: '64px', objectFit: 'contain', display: 'block', margin: '0 auto 12px auto' }}
          />
          <h1 style={{ fontSize: '22px', fontWeight: 500, color: theme.text, margin: '0 0 8px 0', letterSpacing: '-0.01em' }}>
            {greeting.text}
          </h1>
          <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: '0 0 24px 0' }}>{greeting.sub}</p>
          <div style={{ display: 'inline-flex', alignItems: 'center', gap: '8px', background: theme.card, border: `1px solid ${theme.subtle}`, borderRadius: '10px', padding: '10px 18px' }}>
            <span style={{ fontSize: '16px' }}>üî•</span>
            <span style={{ fontSize: '14px', color: theme.accent, fontWeight: 500 }}>{streak} day streak</span>
          </div>
        </div>

        {/* Morning: Dream Journal */}
        {demoTime === 'morning' && (
          <div style={{ background: theme.card, borderRadius: '16px', padding: '24px', border: `1px solid ${theme.subtle}` }}>
            {!dreamSubmitted ? (
              <>
                <h2 style={{ fontFamily: '"Fira Code", monospace', fontSize: '15px', fontWeight: 500, color: theme.text, margin: '0 0 4px 0' }}>
                  What did you dream about?
                </h2>
                <p style={{ fontFamily: '"Fira Code", monospace', fontSize: '12px', color: theme.text, opacity: 0.4, margin: '0 0 16px 0' }}>
                  Even fragments help you remember better
                </p>
                <textarea
                  ref={dreamRef}
                  placeholder="I dreamed that..."
                  rows={4}
                  style={{
                    width: '100%', padding: '16px', border: `1px solid ${theme.subtle}`, borderRadius: '12px',
                    fontFamily: '"Fira Code", monospace', fontSize: '14px', lineHeight: 1.7,
                    color: theme.text, background: theme.bg, resize: 'none', outline: 'none', boxSizing: 'border-box',
                  }}
                />
                <div style={{ display: 'flex', gap: '8px', marginTop: '14px', flexWrap: 'wrap' }}>
                  <Chip text="I was flying..." onClick={() => { if (dreamRef.current) dreamRef.current.value = 'I was flying...'; }} />
                  <Chip text="I felt..." onClick={() => { if (dreamRef.current) dreamRef.current.value = 'I felt...'; }} />
                  <Chip text="Can't remember" onClick={() => { if (dreamRef.current) dreamRef.current.value = "Can't remember any dreams today."; }} />
                </div>
                <button
                  onClick={handleDreamSubmission}
                  disabled={dreamSaving}
                  style={{
                    marginTop: '20px', width: '100%', padding: '16px',
                    background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`,
                    color: theme.bg, border: 'none', borderRadius: '12px',
                    fontFamily: '"Fira Code", monospace', fontSize: '14px', fontWeight: 500,
                    cursor: dreamSaving ? 'not-allowed' : 'pointer',
                    opacity: dreamSaving ? 0.7 : 1,
                    transition: 'all 0.2s ease',
                  }}
                >
                  {dreamSaving ? 'Saving...' : 'Lock it in ‚Üí'}
                </button>
              </>
            ) : (
              <div style={{ textAlign: 'center', padding: '20px 0', fontFamily: '"Fira Code", monospace' }}>
                <span style={{ fontSize: '40px', display: 'block', marginBottom: '16px' }}>‚ú®</span>
                <h2 style={{ fontSize: '18px', fontWeight: 500, color: theme.text, margin: '0 0 8px 0' }}>Dream captured!</h2>
                <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: '0 0 20px 0' }}>
                  {dreamSaving ? 'Generating your goals...' : 'Goals are being added to your list'}
                </p>
                <div style={{ background: theme.bg, border: `1px solid ${theme.subtle}`, borderRadius: '12px', padding: '16px', textAlign: 'left', color: theme.text, fontSize: '13px', lineHeight: 1.6, opacity: 0.8 }}>
                  {dreamText}
                </div>
                <button
                  onClick={() => setDreamSubmitted(false)}
                  style={{ marginTop: '16px', background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '10px', padding: '10px 20px', fontSize: '13px', color: theme.text, opacity: 0.7, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}
                >
                  Edit
                </button>
              </div>
            )}
          </div>
        )}

        {/* Afternoon: AI Suggestions */}
        {demoTime === 'afternoon' && (
          <div style={{ background: theme.card, borderRadius: '16px', padding: '24px', border: `1px solid ${theme.subtle}`, fontFamily: '"Fira Code", monospace' }}>
            {!showAISuggestions ? (
              <div style={{ textAlign: 'center', padding: '20px 0' }}>
                <span style={{ fontSize: '40px', display: 'block', marginBottom: '16px' }}>‚ú®</span>
                <h2 style={{ fontSize: '17px', fontWeight: 500, color: theme.text, margin: '0 0 8px 0' }}>Get personalized ideas</h2>
                <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: '0 0 24px 0', lineHeight: 1.6, maxWidth: '280px', marginLeft: 'auto', marginRight: 'auto' }}>
                  We'll look at your dreams, reflections, and notes to suggest ideas for today
                </p>
                <button
                  onClick={() => { setShowAISuggestions(true); generateAISuggestions(); }}
                  style={{ background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`, color: theme.bg, border: 'none', borderRadius: '12px', padding: '16px 32px', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}
                >
                  Show me ‚Üí
                </button>
              </div>
            ) : aiLoading ? (
              <div style={{ textAlign: 'center', padding: '40px 0' }}>
                <div style={{ width: '40px', height: '40px', border: `3px solid ${theme.subtle}`, borderTopColor: theme.accent, borderRadius: '50%', margin: '0 auto 20px', animation: 'spin 1s linear infinite' }} />
                <p style={{ fontSize: '13px', color: theme.text, opacity: 0.6 }}>Looking through your journal...</p>
                <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
              </div>
            ) : aiSuggestions && (
              <>
                <div style={{ background: `${theme.accent}12`, borderRadius: '12px', padding: '18px', marginBottom: '20px', borderLeft: `3px solid ${theme.accent}` }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>
                    <span style={{ fontSize: '14px' }}>üîÆ</span>
                    <span style={{ fontSize: '11px', color: theme.accent, textTransform: 'uppercase', letterSpacing: '0.08em' }}>Pattern noticed</span>
                  </div>
                  <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>{aiSuggestions.insight}</p>
                </div>

                <h3 style={{ fontSize: '13px', color: theme.text, margin: '0 0 14px 0', opacity: 0.6 }}>Ideas for today</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', marginBottom: '24px' }}>
                  {aiSuggestions.goals.map((goal, i) => (
                    <div
                      key={i}
                      onClick={() => setSelectedGoal(selectedGoal === i ? null : i)}
                      style={{ background: selectedGoal === i ? `${theme.accent}15` : theme.subtle, border: `1px solid ${selectedGoal === i ? theme.accent : theme.card}`, borderRadius: '12px', padding: '16px', cursor: 'pointer', transition: 'all 0.2s ease' }}
                    >
                      <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                        <span style={{ fontSize: '20px' }}>{goal.icon}</span>
                        <div style={{ flex: 1 }}>
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '6px' }}>
                            <h4 style={{ fontSize: '14px', color: theme.text, margin: 0, fontWeight: 500 }}>{goal.title}</h4>
                            {selectedGoal === i && <span style={{ background: theme.accent, color: theme.bg, fontSize: '10px', padding: '4px 10px', borderRadius: '6px' }}>Today's goal</span>}
                          </div>
                          <p style={{ fontSize: '12px', color: theme.text, opacity: 0.7, margin: '0 0 8px 0', lineHeight: 1.5 }}>{goal.description}</p>
                          <p style={{ fontSize: '11px', color: theme.accent, margin: 0, opacity: 0.8 }}>üí° {goal.why}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                <h3 style={{ fontSize: '13px', color: theme.text, margin: '0 0 14px 0', opacity: 0.6 }}>Questions to ponder</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '20px' }}>
                  {aiSuggestions.reflection_prompts.map((prompt, i) => (
                    <div key={i} style={{ background: theme.subtle, borderRadius: '10px', padding: '14px 16px', fontSize: '13px', color: theme.text, opacity: 0.8, lineHeight: 1.5, fontStyle: 'italic' }}>
                      "{prompt}"
                    </div>
                  ))}
                </div>

                <button
                  onClick={() => generateAISuggestions()}
                  style={{ width: '100%', background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '10px', padding: '14px', fontSize: '13px', color: theme.text, opacity: 0.7, cursor: 'pointer', fontFamily: '"Fira Code", monospace', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}
                >
                  <span>‚Üª</span> Get new ideas
                </button>
              </>
            )}

            <div style={{ marginTop: '24px', paddingTop: '24px', borderTop: `1px solid ${theme.subtle}` }}>
              <p style={{ fontSize: '12px', color: theme.text, opacity: 0.5, margin: '0 0 12px 0' }}>Capture a quick thought</p>
              <div style={{ display: 'flex', gap: '10px' }}>
                <input
                  type="text"
                  value={quickNote}
                  onChange={e => setQuickNote(e.target.value)}
                  placeholder="What's on your mind..."
                  style={{ flex: 1, padding: '14px 16px', border: `1px solid ${theme.subtle}`, borderRadius: '10px', fontFamily: '"Fira Code", monospace', fontSize: '13px', color: theme.text, background: theme.bg, outline: 'none' }}
                />
                <button style={{ background: theme.accent, color: theme.bg, border: 'none', borderRadius: '10px', padding: '14px 20px', fontSize: '13px', fontWeight: 500, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}>Save</button>
              </div>
            </div>
          </div>
        )}

        {/* Evening: Reflection */}
        {demoTime === 'evening' && (
          <div style={{ background: theme.card, borderRadius: '16px', padding: '24px', border: `1px solid ${theme.subtle}` }}>
            {!eveningSubmitted ? (
              <>
                <h2 style={{ fontFamily: '"Fira Code", monospace', fontSize: '15px', fontWeight: 500, color: theme.text, margin: '0 0 4px 0' }}>How was your day?</h2>
                <p style={{ fontFamily: '"Fira Code", monospace', fontSize: '12px', color: theme.text, opacity: 0.4, margin: '0 0 16px 0' }}>Reflect on what stood out</p>
                <textarea
                  ref={eveningRef}
                  placeholder="Today I..."
                  rows={5}
                  style={{ width: '100%', padding: '16px', border: `1px solid ${theme.subtle}`, borderRadius: '12px', fontFamily: '"Fira Code", monospace', fontSize: '14px', lineHeight: 1.7, color: theme.text, background: theme.bg, resize: 'none', outline: 'none', boxSizing: 'border-box' }}
                />
                <div style={{ display: 'flex', gap: '8px', marginTop: '14px', flexWrap: 'wrap' }}>
                  <Chip text="I'm grateful for..." onClick={() => { if (eveningRef.current) eveningRef.current.value = "I'm grateful for..."; }} />
                  <Chip text="Today I learned..." onClick={() => { if (eveningRef.current) eveningRef.current.value = 'Today I learned...'; }} />
                  <Chip text="A highlight was..." onClick={() => { if (eveningRef.current) eveningRef.current.value = 'A highlight was...'; }} />
                </div>
                <button
                  onClick={handleEveningSubmission}
                  disabled={eveningSaving}
                  style={{
                    marginTop: '20px', width: '100%', padding: '16px',
                    background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`,
                    color: theme.bg, border: 'none', borderRadius: '12px',
                    fontFamily: '"Fira Code", monospace', fontSize: '14px', fontWeight: 500,
                    cursor: eveningSaving ? 'not-allowed' : 'pointer',
                    opacity: eveningSaving ? 0.7 : 1,
                    transition: 'all 0.2s ease',
                  }}
                >
                  {eveningSaving ? 'Saving...' : 'Lock it in ‚Üí'}
                </button>
              </>
            ) : (
              <div style={{ textAlign: 'center', padding: '20px 0', fontFamily: '"Fira Code", monospace' }}>
                <span style={{ fontSize: '40px', display: 'block', marginBottom: '16px' }}>üåô</span>
                <h2 style={{ fontSize: '18px', fontWeight: 500, color: theme.text, margin: '0 0 8px 0' }}>Day complete!</h2>
                <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: '0 0 20px 0' }}>
                  {eveningSaving ? 'Reflecting on your day...' : 'Another day of growth recorded. Rest well.'}
                </p>
                <div style={{ background: theme.bg, border: `1px solid ${theme.subtle}`, borderRadius: '12px', padding: '16px', textAlign: 'left', color: theme.text, fontSize: '13px', lineHeight: 1.6, opacity: 0.8 }}>
                  {eveningText}
                </div>
                <div style={{ marginTop: '20px', padding: '14px', background: `${theme.accent}15`, border: `1px solid ${theme.accent}30`, borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '10px' }}>
                  <span style={{ fontSize: '20px' }}>üî•</span>
                  <span style={{ fontSize: '15px', color: theme.accent, fontWeight: 500 }}>{streak + 1} day streak!</span>
                </div>
                <button
                  onClick={() => setEveningSubmitted(false)}
                  style={{ marginTop: '16px', background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '10px', padding: '10px 20px', fontSize: '13px', color: theme.text, opacity: 0.7, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}
                >
                  Edit
                </button>
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  // ---- Goals View ----

  const GoalsView = () => {
    const toggleMicroGoal = async (id) => {
      const goal = aiMicroGoals.find(g => g.id === id);
      if (!goal) return;
      setAiMicroGoals(goals => goals.map(g => g.id === id ? { ...g, completed: !g.completed } : g));
      try {
        await updateDoc(doc(db, 'users', user.uid, 'goals', id), {
          completed: !goal.completed,
          completedAt: !goal.completed ? serverTimestamp() : null,
        });
      } catch (err) { console.error('Toggle goal error:', err); }
    };

    const toggleUserGoal = async (id) => {
      const goal = userGoals.find(g => g.id === id);
      if (!goal) return;
      setUserGoals(goals => goals.map(g => g.id === id ? { ...g, completed: !g.completed } : g));
      try {
        await updateDoc(doc(db, 'users', user.uid, 'goals', id), {
          completed: !goal.completed,
          completedAt: !goal.completed ? serverTimestamp() : null,
        });
      } catch (err) { console.error('Toggle goal error:', err); }
    };

    const addUserGoal = async () => {
      if (!newGoalText.trim()) return;
      const today = new Date().toISOString().split('T')[0];
      setNewGoalText('');
      try {
        await addDoc(collection(db, 'users', user.uid, 'goals'), {
          text: newGoalText,
          icon: 'üìã',
          why: 'Added by you',
          source: 'user',
          completed: false,
          createdAt: serverTimestamp(),
          dateString: today,
          userId: user.uid,
        });
      } catch (err) { console.error('Add goal error:', err); }
    };

    const completedCount = [...aiMicroGoals, ...userGoals].filter(g => g.completed).length;
    const totalCount = aiMicroGoals.length + userGoals.length;

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '20px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{ paddingTop: '60px', textAlign: 'center' }}>
          <h1 style={{ fontSize: '22px', fontWeight: 500, color: theme.text, margin: '0 0 8px 0' }}>Today's Goals</h1>
          <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: 0 }}>Small steps, big progress</p>
        </div>

        {/* Progress */}
        {totalCount > 0 && (
          <div style={{ background: theme.card, borderRadius: '14px', padding: '18px', border: `1px solid ${theme.subtle}` }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <span style={{ fontSize: '13px', color: theme.text, opacity: 0.7 }}>Progress</span>
              <span style={{ fontSize: '14px', color: theme.accent, fontWeight: 500 }}>{completedCount}/{totalCount}</span>
            </div>
            <div style={{ background: theme.subtle, borderRadius: '100px', height: '8px', overflow: 'hidden' }}>
              <div style={{ width: `${(completedCount / totalCount) * 100}%`, height: '100%', background: `linear-gradient(90deg, ${theme.accent} 0%, ${theme.accent}aa 100%)`, borderRadius: '100px', transition: 'width 0.3s ease' }} />
            </div>
          </div>
        )}

        {/* AI Suggested Goals */}
        <div style={{ background: theme.card, borderRadius: '16px', padding: '20px', border: `1px solid ${theme.subtle}` }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
            <div>
              <h3 style={{ fontSize: '14px', color: theme.text, margin: '0 0 4px 0', fontWeight: 500 }}>‚ú® Suggested for you</h3>
              <p style={{ fontSize: '11px', color: theme.text, opacity: 0.5, margin: 0 }}>Based on your recent entries</p>
            </div>
          </div>

          {aiMicroGoals.length === 0 ? (
            <p style={{ fontSize: '12px', color: theme.text, opacity: 0.4, margin: 0, textAlign: 'center', padding: '12px 0' }}>
              Submit your morning dream to get AI-generated goals
            </p>
          ) : (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {aiMicroGoals.map(goal => (
                <div
                  key={goal.id}
                  onClick={() => toggleMicroGoal(goal.id)}
                  style={{ background: goal.completed ? `${theme.accent}15` : theme.subtle, border: `1px solid ${goal.completed ? theme.accent + '40' : 'transparent'}`, borderRadius: '12px', padding: '14px 16px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '12px', transition: 'all 0.2s ease' }}
                >
                  <div style={{ width: '22px', height: '22px', borderRadius: '6px', border: `2px solid ${goal.completed ? theme.accent : theme.text + '40'}`, background: goal.completed ? theme.accent : 'transparent', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, transition: 'all 0.2s ease' }}>
                    {goal.completed && <span style={{ color: theme.bg, fontSize: '12px' }}>‚úì</span>}
                  </div>
                  <span style={{ fontSize: '18px' }}>{goal.icon}</span>
                  <div style={{ flex: 1 }}>
                    <span style={{ fontSize: '13px', color: theme.text, opacity: goal.completed ? 0.6 : 0.9, textDecoration: goal.completed ? 'line-through' : 'none', lineHeight: 1.4, display: 'block' }}>{goal.text}</span>
                    {goal.why && <span style={{ fontSize: '11px', color: theme.accent, opacity: 0.7 }}>{goal.why}</span>}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* User Goals */}
        <div style={{ background: theme.card, borderRadius: '16px', padding: '20px', border: `1px solid ${theme.subtle}` }}>
          <h3 style={{ fontSize: '14px', color: theme.text, margin: '0 0 16px 0', fontWeight: 500 }}>üìã Your Goals</h3>
          <div style={{ display: 'flex', gap: '10px', marginBottom: userGoals.length > 0 ? '16px' : '0' }}>
            <input
              type="text"
              value={newGoalText}
              onChange={e => setNewGoalText(e.target.value)}
              onKeyPress={e => e.key === 'Enter' && addUserGoal()}
              placeholder="Add a goal for today..."
              style={{ flex: 1, padding: '14px 16px', border: `1px solid ${theme.subtle}`, borderRadius: '10px', fontFamily: '"Fira Code", monospace', fontSize: '13px', color: theme.text, background: theme.bg, outline: 'none' }}
            />
            <button onClick={addUserGoal} style={{ background: theme.accent, color: theme.bg, border: 'none', borderRadius: '10px', padding: '14px 18px', fontSize: '16px', cursor: 'pointer' }}>+</button>
          </div>
          {userGoals.length > 0 && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {userGoals.map(goal => (
                <div
                  key={goal.id}
                  onClick={() => toggleUserGoal(goal.id)}
                  style={{ background: goal.completed ? `${theme.accent}15` : theme.subtle, border: `1px solid ${goal.completed ? theme.accent + '40' : 'transparent'}`, borderRadius: '12px', padding: '14px 16px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '12px', transition: 'all 0.2s ease' }}
                >
                  <div style={{ width: '22px', height: '22px', borderRadius: '6px', border: `2px solid ${goal.completed ? theme.accent : theme.text + '40'}`, background: goal.completed ? theme.accent : 'transparent', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>
                    {goal.completed && <span style={{ color: theme.bg, fontSize: '12px' }}>‚úì</span>}
                  </div>
                  <span style={{ fontSize: '13px', color: theme.text, opacity: goal.completed ? 0.6 : 0.9, textDecoration: goal.completed ? 'line-through' : 'none' }}>{goal.text}</span>
                </div>
              ))}
            </div>
          )}
          {userGoals.length === 0 && (
            <p style={{ fontSize: '12px', color: theme.text, opacity: 0.4, margin: '12px 0 0 0', textAlign: 'center' }}>
              No goals yet. What do you want to accomplish today?
            </p>
          )}
        </div>

        {totalCount > 0 && completedCount === totalCount && (
          <div style={{ background: `linear-gradient(135deg, ${theme.accent}20 0%, ${theme.accent}10 100%)`, borderRadius: '14px', padding: '24px', textAlign: 'center', border: `1px solid ${theme.accent}30` }}>
            <span style={{ fontSize: '32px', display: 'block', marginBottom: '12px' }}>üéâ</span>
            <p style={{ fontSize: '15px', color: theme.text, margin: 0, fontWeight: 500 }}>All goals complete!</p>
            <p style={{ fontSize: '12px', color: theme.text, opacity: 0.6, margin: '8px 0 0 0' }}>You're crushing it today</p>
          </div>
        )}
      </div>
    );
  };

  // ---- History View ----

  const HistoryView = () => {
    const weeks = [];
    for (let i = 0; i < entries.length; i += 7) weeks.push(entries.slice(i, i + 7));

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '24px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{ paddingTop: '60px', textAlign: 'center' }}>
          <h1 style={{ fontSize: '22px', fontWeight: 500, color: theme.text, margin: '0 0 8px 0' }}>History</h1>
          <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: 0 }}>Tap any day to revisit</p>
        </div>

        {entries.length === 0 ? (
          <div style={{ background: theme.card, borderRadius: '16px', padding: '40px 24px', border: `1px solid ${theme.subtle}`, textAlign: 'center' }}>
            <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: 0 }}>Your journal history will appear here</p>
          </div>
        ) : (
          <div style={{ background: theme.card, borderRadius: '16px', padding: '20px', border: `1px solid ${theme.subtle}` }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '14px' }}>
              {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => (
                <span key={i} style={{ width: '38px', textAlign: 'center', fontSize: '11px', color: theme.text, opacity: 0.4 }}>{d}</span>
              ))}
            </div>
            {weeks.map((week, wi) => (
              <div key={wi} style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                {week.map((day, di) => {
                  const isToday = day.date.toDateString() === new Date().toDateString();
                  const hasEntry = !day.empty;
                  const dayTheme = hasEntry && day.mood ? themes[day.mood] : null;
                  return (
                    <button
                      key={di}
                      onClick={() => !day.empty && setSelectedHistoryDay(day)}
                      disabled={day.empty}
                      style={{ width: '38px', height: '38px', borderRadius: '10px', border: isToday ? `2px solid ${theme.accent}` : `1px solid transparent`, background: hasEntry ? `${(dayTheme || theme).accent}35` : theme.subtle, cursor: hasEntry ? 'pointer' : 'default', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', color: hasEntry ? theme.text : `${theme.text}40`, transition: 'all 0.2s ease', fontFamily: '"Fira Code", monospace' }}
                    >
                      {day.date.getDate()}
                    </button>
                  );
                })}
              </div>
            ))}
          </div>
        )}

        {selectedHistoryDay && (
          <div style={{ background: theme.card, borderRadius: '16px', padding: '24px', border: `1px solid ${theme.accent}50`, animation: 'fadeIn 0.3s ease' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h3 style={{ fontSize: '16px', fontWeight: 500, color: theme.text, margin: 0 }}>{formatDate(selectedHistoryDay.date)}</h3>
              {selectedHistoryDay.mood && (
                <span style={{ background: `${(themes[selectedHistoryDay.mood] || theme).accent}30`, color: (themes[selectedHistoryDay.mood] || theme).accent, padding: '6px 12px', borderRadius: '8px', fontSize: '12px' }}>{selectedHistoryDay.mood}</span>
              )}
            </div>
            {selectedHistoryDay.dream && (
              <div style={{ marginBottom: '18px' }}>
                <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>Dream</p>
                <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>{selectedHistoryDay.dream}</p>
              </div>
            )}
            {selectedHistoryDay.reflection && (
              <div style={{ marginBottom: '18px' }}>
                <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>Reflection</p>
                <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>{selectedHistoryDay.reflection}</p>
              </div>
            )}
            {selectedHistoryDay.gratitude && (
              <div style={{ background: theme.subtle, borderRadius: '10px', padding: '14px' }}>
                <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>AI Insight</p>
                <p style={{ fontSize: '13px', color: theme.text, margin: 0, opacity: 0.8 }}>{selectedHistoryDay.gratitude}</p>
              </div>
            )}
            <button onClick={() => setSelectedHistoryDay(null)} style={{ marginTop: '18px', background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '10px', padding: '12px 20px', fontSize: '13px', color: theme.text, opacity: 0.7, cursor: 'pointer', width: '100%', fontFamily: '"Fira Code", monospace' }}>Close</button>
          </div>
        )}
      </div>
    );
  };

  // ---- Wrapped View ----

  const WrappedView = () => {
    const recentEntries = entries.filter(e => !e.empty).slice(-7);
    const moodCounts = {};
    recentEntries.forEach(e => { if (e.mood) moodCounts[e.mood] = (moodCounts[e.mood] || 0) + 1; });
    const topMoods = Object.entries(moodCounts).sort((a, b) => b[1] - a[1]).slice(0, 3).map(m => m[0]);
    const dreamsRemembered = firestoreEntries.filter(e => e.type === 'dream').length;
    const totalWords = firestoreEntries.reduce((acc, e) => acc + (e.text?.split(' ').length || 0), 0);

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '20px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{ textAlign: 'center', paddingTop: '60px', paddingBottom: '10px' }}>
          <p style={{ fontSize: '12px', color: theme.text, opacity: 0.4, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.1em' }}>This Week</p>
          <h1 style={{ fontSize: '28px', fontWeight: 500, color: theme.text, margin: '0 0 4px 0' }}>‚ú¶ Your Wrapped</h1>
        </div>

        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px' }}>
          {[
            { label: 'Days logged', value: recentEntries.length, icon: 'üìù' },
            { label: 'Dreams', value: dreamsRemembered, icon: 'üí≠' },
            { label: 'Words', value: totalWords, icon: '‚úèÔ∏è' },
            { label: 'Streak', value: streak, icon: 'üî•' },
          ].map((stat, i) => (
            <div key={i} style={{ background: theme.card, borderRadius: '14px', padding: '20px', textAlign: 'center', border: `1px solid ${theme.subtle}` }}>
              <span style={{ fontSize: '24px', display: 'block', marginBottom: '10px' }}>{stat.icon}</span>
              <p style={{ fontSize: '28px', fontWeight: 500, color: theme.text, margin: '0 0 4px 0' }}>{stat.value}</p>
              <p style={{ fontSize: '11px', color: theme.text, opacity: 0.5, margin: 0 }}>{stat.label}</p>
            </div>
          ))}
        </div>

        {topMoods.length > 0 && (
          <div style={{ background: theme.card, borderRadius: '14px', padding: '20px', border: `1px solid ${theme.subtle}` }}>
            <h3 style={{ fontSize: '14px', fontWeight: 500, color: theme.text, margin: '0 0 16px 0' }}>Your vibes this week</h3>
            <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
              {topMoods.map((mood, i) => (
                <span key={i} style={{ background: `${(themes[mood] || theme).accent}25`, color: (themes[mood] || theme).accent, padding: '10px 18px', borderRadius: '10px', fontSize: '13px', border: `1px solid ${(themes[mood] || theme).accent}30` }}>{mood}</span>
              ))}
            </div>
          </div>
        )}

        <div style={{ background: `${theme.accent}12`, borderRadius: '14px', padding: '22px', borderLeft: `3px solid ${theme.accent}` }}>
          <h3 style={{ fontSize: '14px', fontWeight: 500, color: theme.accent, margin: '0 0 12px 0', display: 'flex', alignItems: 'center', gap: '8px' }}>
            <span>‚ú®</span> Weekly Insight
          </h3>
          <p style={{ fontSize: '14px', color: theme.text, margin: 0, lineHeight: 1.7, opacity: 0.85 }}>
            {topMoods[0]
              ? <>You've been feeling most <span style={{ color: theme.accent, fontWeight: 500 }}>{topMoods[0]}</span> this week. Keep journaling ‚Äî patterns will emerge over time.</>
              : 'Start journaling to see your weekly insights here.'}
          </p>
        </div>

        <div style={{ background: `linear-gradient(135deg, ${theme.accent}20 0%, ${theme.accent}10 100%)`, borderRadius: '14px', padding: '28px', textAlign: 'center', border: `1px solid ${theme.accent}30` }}>
          <span style={{ fontSize: '40px', display: 'block', marginBottom: '12px' }}>üî•</span>
          <p style={{ fontSize: '22px', fontWeight: 500, color: theme.text, margin: '0 0 6px 0' }}>{streak} day streak!</p>
          <p style={{ fontSize: '13px', color: theme.text, opacity: 0.6, margin: 0 }}>Keep going ‚Äî you're building something meaningful</p>
        </div>

        <button
          onClick={() => signOut(auth)}
          style={{ background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '10px', padding: '12px', fontSize: '12px', color: theme.text, opacity: 0.4, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}
        >
          Sign out
        </button>
      </div>
    );
  };

  // ---- Render ----

  // Splash always shows first
  if (showSplash || authLoading) {
    return (
      <>
        <SplashScreen />
      </>
    );
  }

  // Sign-in screen
  if (!user) {
    return <SignInView />;
  }

  // Main app
  return (
    <div style={{ minHeight: '100vh', background: theme.bg, fontFamily: '"SF Mono", "Fira Code", Consolas, monospace', transition: 'background 0.5s ease' }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap');
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        ::placeholder { color: ${theme.text}40; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: ${theme.bg}; }
        ::-webkit-scrollbar-thumb { background: ${theme.accent}40; border-radius: 3px; }
      `}</style>

      <div style={{ maxWidth: '480px', margin: '0 auto', padding: '20px 20px 120px 20px' }}>
        {currentView === 'home' && <HomeView />}
        {currentView === 'goals' && <GoalsView />}
        {currentView === 'history' && <HistoryView />}
        {currentView === 'wrapped' && <WrappedView />}
      </div>

      <NavBar />
    </div>
  );
};

export default DaylightJournal;
