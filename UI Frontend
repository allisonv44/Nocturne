import React, { useState, useMemo, useRef, useCallback, useEffect } from 'react';
import { auth, db } from './src/firebase.js';
import {
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
} from 'firebase/auth';
import {
  collection, addDoc, query, where, orderBy, limit,
  onSnapshot, doc, updateDoc, serverTimestamp,
} from 'firebase/firestore';

// Cloud Function URLs ‚Äî update these after `firebase deploy --only functions`
const CF_URLS = {
  dream: 'https://generategoalfromdream-r7ou5o5rea-uc.a.run.app',
  journal: 'https://processjournalentry-r7ou5o5rea-uc.a.run.app',
};

const DaylightJournal = () => {
  // ---- Demo UI state ----
  const [currentView, setCurrentView] = useState('home');
  const [demoTime, setDemoTime] = useState('morning');
  const [demoDay, setDemoDay] = useState(0);
  const [selectedHistoryDay, setSelectedHistoryDay] = useState(null);
  const [quickNote, setQuickNote] = useState('');
  const [noteSaving, setNoteSaving] = useState(false);
  const [dreamSubmitted, setDreamSubmitted] = useState(false);
  const [eveningSubmitted, setEveningSubmitted] = useState(false);

  // ---- Auth state ----
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [showSplash, setShowSplash] = useState(true);
  const [authEmail, setAuthEmail] = useState('');
  const [authPassword, setAuthPassword] = useState('');
  const [authMode, setAuthMode] = useState('signin');
  const [authError, setAuthError] = useState('');

  // ---- Text state ----
  const dreamRef = useRef(null);
  const eveningRef = useRef(null);
  const historyDetailRef = useRef(null);
  const [dreamText, setDreamText] = useState('');
  const [eveningText, setEveningText] = useState('');

  // ---- AI result state ----
  const [dreamAiResult, setDreamAiResult] = useState(null);
  const [dreamAiLoading, setDreamAiLoading] = useState(false);
  const [journalAiResult, setJournalAiResult] = useState(null);
  const [journalAiLoading, setJournalAiLoading] = useState(false);

  // ---- Goals state ----
  const [userGoals, setUserGoals] = useState([]);
  const [newGoalText, setNewGoalText] = useState('');
  const [aiMicroGoals, setAiMicroGoals] = useState([]);
  const [generatingGoals, setGeneratingGoals] = useState(false);

  // ---- Firestore state ----
  const [firestoreEntries, setFirestoreEntries] = useState([]);
  const [todayDreamEntryId, setTodayDreamEntryId] = useState(null);
  const [todayJournalEntryId, setTodayJournalEntryId] = useState(null);
  const [dreamSaving, setDreamSaving] = useState(false);
  const [eveningSaving, setEveningSaving] = useState(false);

  // ---- History edit state ----
  const [editingHistory, setEditingHistory] = useState(false);
  const [editDreamText, setEditDreamText] = useState('');
  const [editJournalText, setEditJournalText] = useState('');
  const [editSaving, setEditSaving] = useState(false);

  // ---- Calendar state (lifted from HistoryView to prevent reset on re-render) ----
  const [calMonth, setCalMonth] = useState(new Date().getMonth());
  const [calYear, setCalYear] = useState(new Date().getFullYear());

  // ---- Demo day data ----
  const demoDays = [
    { mood: 'peaceful', dream: 'I was walking through a quiet forest, the trees were glowing softly.', reflection: 'Today felt balanced. Had a good conversation with mom.' },
    { mood: 'energetic', dream: 'Running through city streets, everything was fast and exciting.', reflection: 'So much energy today! Finished the project ahead of schedule.' },
    { mood: 'reflective', dream: 'Sitting by an ocean, waves bringing old memories.', reflection: 'Thought a lot about where I want to be next year.' },
    { mood: 'creative', dream: 'Building impossible structures that kept changing shape.', reflection: 'Ideas flowing all day. Started three new projects.' },
    { mood: 'grateful', dream: 'A gathering of friends, everyone was laughing.', reflection: 'Feeling so thankful for the people in my life.' },
    { mood: 'calm', dream: 'Floating in warm water under stars.', reflection: 'Quiet day. Sometimes stillness is what we need.' },
  ];

  const currentDemoDay = demoDays[demoDay % demoDays.length];

  const nextDemoDay = useCallback(() => {
    setDemoDay(d => d + 1);
    setDreamSubmitted(false);
    setEveningSubmitted(false);
    setDreamText('');
    setEveningText('');
    if (dreamRef.current) dreamRef.current.value = '';
    if (eveningRef.current) eveningRef.current.value = '';
    setDreamAiResult(null);
    setJournalAiResult(null);
  }, []);

  // ---- Static demo entries (History fallback) ----
  const [demoEntries] = useState([
    { date: new Date(Date.now() - 29 * 86400000), mood: 'peaceful', dream: 'Flying over mountains made of glass', reflection: 'Had a wonderful conversation that made me think differently.', gratitude: 'Good health' },
    { date: new Date(Date.now() - 28 * 86400000), mood: 'energetic', dream: 'Swimming with luminescent fish', reflection: "Quiet day, but peaceful. Sometimes that's exactly what I need.", gratitude: 'Supportive friends' },
    { date: new Date(Date.now() - 27 * 86400000), mood: 'reflective', dream: null, reflection: 'Pushed through something difficult. Proud of myself.', gratitude: 'Creative time' },
    { date: new Date(Date.now() - 26 * 86400000), mood: 'grateful', dream: 'A library where books whispered secrets', reflection: 'Noticed the small things today - sunlight, good coffee.', gratitude: 'Nature' },
    { date: new Date(Date.now() - 25 * 86400000), empty: true },
    { date: new Date(Date.now() - 24 * 86400000), mood: 'creative', dream: 'Walking through a forest of giant flowers', reflection: 'Creative energy was flowing. Made progress on my project.', gratitude: 'Music' },
    { date: new Date(Date.now() - 23 * 86400000), mood: 'calm', dream: 'Meeting an old friend in a strange city', reflection: 'Felt connected to the people around me.', gratitude: 'Good health' },
    { date: new Date(Date.now() - 22 * 86400000), mood: 'inspired', dream: 'Building something impossible', reflection: 'Took time to rest without guilt.', gratitude: 'Supportive friends' },
    { date: new Date(Date.now() - 21 * 86400000), mood: 'cozy', dream: 'A warm kitchen filled with familiar smells', reflection: 'Learned something new that excited me.', gratitude: 'Creative time' },
    { date: new Date(Date.now() - 20 * 86400000), mood: 'peaceful', dream: null, reflection: 'Had a wonderful conversation that made me think differently.', gratitude: 'Nature' },
    { date: new Date(Date.now() - 19 * 86400000), empty: true },
    { date: new Date(Date.now() - 18 * 86400000), mood: 'energetic', dream: 'Flying over mountains made of glass', reflection: 'Quiet day, but peaceful.', gratitude: 'Music' },
    { date: new Date(Date.now() - 17 * 86400000), mood: 'reflective', dream: 'Swimming with luminescent fish', reflection: 'Pushed through something difficult.', gratitude: 'Good health' },
    { date: new Date(Date.now() - 16 * 86400000), mood: 'grateful', dream: 'A library where books whispered secrets', reflection: 'Noticed the small things today.', gratitude: 'Supportive friends' },
    { date: new Date(Date.now() - 15 * 86400000), mood: 'creative', dream: null, reflection: 'Creative energy was flowing.', gratitude: 'Creative time' },
    { date: new Date(Date.now() - 14 * 86400000), mood: 'calm', dream: 'Walking through a forest of giant flowers', reflection: 'Felt connected to the people around me.', gratitude: 'Nature' },
    { date: new Date(Date.now() - 13 * 86400000), empty: true },
    { date: new Date(Date.now() - 12 * 86400000), mood: 'inspired', dream: 'Meeting an old friend in a strange city', reflection: 'Took time to rest without guilt.', gratitude: 'Music' },
    { date: new Date(Date.now() - 11 * 86400000), mood: 'cozy', dream: 'Building something impossible', reflection: 'Learned something new that excited me.', gratitude: 'Good health' },
    { date: new Date(Date.now() - 10 * 86400000), mood: 'peaceful', dream: 'A warm kitchen filled with familiar smells', reflection: 'Had a wonderful conversation.', gratitude: 'Supportive friends' },
    { date: new Date(Date.now() - 9 * 86400000), mood: 'energetic', dream: null, reflection: 'Quiet day, but peaceful.', gratitude: 'Creative time' },
    { date: new Date(Date.now() - 8 * 86400000), mood: 'reflective', dream: 'Flying over mountains made of glass', reflection: 'Pushed through something difficult.', gratitude: 'Nature' },
    { date: new Date(Date.now() - 7 * 86400000), empty: true },
    { date: new Date(Date.now() - 6 * 86400000), mood: 'grateful', dream: 'Swimming with luminescent fish', reflection: 'Noticed the small things today.', gratitude: 'Music' },
    { date: new Date(Date.now() - 5 * 86400000), mood: 'creative', dream: 'A library where books whispered secrets', reflection: 'Creative energy was flowing.', gratitude: 'Good health' },
    { date: new Date(Date.now() - 4 * 86400000), mood: 'calm', dream: null, reflection: 'Felt connected to the people around me.', gratitude: 'Supportive friends' },
    { date: new Date(Date.now() - 3 * 86400000), mood: 'inspired', dream: 'Walking through a forest of giant flowers', reflection: 'Took time to rest without guilt.', gratitude: 'Creative time' },
    { date: new Date(Date.now() - 2 * 86400000), mood: 'cozy', dream: 'Meeting an old friend in a strange city', reflection: 'Learned something new that excited me.', gratitude: 'Nature' },
    { date: new Date(Date.now() - 1 * 86400000), mood: 'peaceful', dream: 'Building something impossible', reflection: 'Had a wonderful conversation.', gratitude: 'Music' },
    { date: new Date(), mood: 'grateful', dream: 'A warm kitchen filled with familiar smells', reflection: 'Today was a good day.', gratitude: 'Good health' },
  ]);

  // ---- Sanitizers ----
  const sanitizeText = (value, { trim = false, collapseWhitespace = false, maxLen = 4000 } = {}) => {
    let s = String(value).replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g, '');
    if (collapseWhitespace) s = s.replace(/\s+/g, ' ');
    if (trim) s = s.trim();
    if (maxLen && s.length > maxLen) s = s.slice(0, maxLen);
    return s;
  };
  const sanitizeEmail = (v) => sanitizeText(v, { trim: true, collapseWhitespace: true, maxLen: 320 }).replace(/\s+/g, '');
  const sanitizePassword = (v) => sanitizeText(v, { trim: false, collapseWhitespace: false, maxLen: 256 });

  // ---- Effects ----

  // Splash
  useEffect(() => {
    const t = setTimeout(() => setShowSplash(false), 2200);
    return () => clearTimeout(t);
  }, []);

  // Auth
  useEffect(() => {
    const unsub = onAuthStateChanged(auth, (u) => {
      setUser(u || false);
      setAuthLoading(false);
    });
    return () => unsub();
  }, []);

  // Firestore entries
  useEffect(() => {
    if (!user) return;
    const q = query(collection(db, 'users', user.uid, 'entries'), orderBy('timestamp', 'desc'), limit(60));
    const unsub = onSnapshot(q, (snap) => {
      setFirestoreEntries(snap.docs.map(d => ({ id: d.id, ...d.data(), date: d.data().timestamp?.toDate() || new Date() })));
    });
    return () => unsub();
  }, [user]);

  // Firestore goals (today)
  useEffect(() => {
    if (!user) return;
    const today = new Date().toISOString().split('T')[0];
    const q = query(collection(db, 'users', user.uid, 'goals'), where('dateString', '==', today), orderBy('createdAt', 'asc'));
    const unsub = onSnapshot(q, (snap) => {
      const goals = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      const aiGoals = goals.filter(g => g.source === 'ai');
      if (aiGoals.length > 0) setAiMicroGoals(aiGoals);
      setUserGoals(goals.filter(g => g.source === 'user'));
    });
    return () => unsub();
  }, [user]);

  // Sync today's dream/journal from Firestore on load (includes AI results)
  useEffect(() => {
    const today = new Date().toISOString().split('T')[0];
    const todayDream = firestoreEntries.find(e => e.type === 'dream' && e.dateString === today);
    if (todayDream && !todayDreamEntryId) {
      setTodayDreamEntryId(todayDream.id);
      setDreamText(todayDream.text);
      if (dreamRef.current) dreamRef.current.value = todayDream.text;
      setDreamSubmitted(true);
      if (todayDream.aiResult) setDreamAiResult(todayDream.aiResult);
    }
    const todayJournal = firestoreEntries.find(e => e.type === 'journal' && e.dateString === today);
    if (todayJournal && !todayJournalEntryId) {
      setTodayJournalEntryId(todayJournal.id);
      setEveningText(todayJournal.text);
      if (eveningRef.current) eveningRef.current.value = todayJournal.text;
      setEveningSubmitted(true);
      if (todayJournal.aiResult) setJournalAiResult(todayJournal.aiResult);
    }
  }, [firestoreEntries]); // eslint-disable-line react-hooks/exhaustive-deps

  // ---- Computed values ----

  // Today's quick notes
  const todayNotes = useMemo(() => {
    const today = new Date().toISOString().split('T')[0];
    return firestoreEntries.filter(e => e.type === 'note' && e.dateString === today);
  }, [firestoreEntries]);

  // Merge Firestore entries into day-keyed objects for calendar
  const firestoreCalendarEntries = useMemo(() => {
    if (firestoreEntries.length === 0) return null;
    const byDate = {};
    firestoreEntries.forEach(e => {
      const key = e.dateString;
      if (!key) return;
      if (!byDate[key]) byDate[key] = { date: new Date(key + 'T12:00:00'), dateString: key, empty: false };
      if (e.type === 'dream') {
        byDate[key].dream = e.text;
        byDate[key].dreamEntryId = e.id;
      }
      if (e.type === 'journal') {
        byDate[key].reflection = e.text;
        byDate[key].journalEntryId = e.id;
        byDate[key].mood = e.mood || 'peaceful';
        byDate[key].gratitude = e.aiResult?.insight || '';
        byDate[key].aiResult = e.aiResult;
      }
      if (e.type === 'note') {
        if (!byDate[key].notes) byDate[key].notes = [];
        byDate[key].notes.push(e.text);
      }
    });
    return Object.values(byDate).sort((a, b) => new Date(a.dateString) - new Date(b.dateString));
  }, [firestoreEntries]);

  // Use real entries if available, else demo fallback
  const calendarEntries = firestoreCalendarEntries || demoEntries;

  // Theme: use real Firestore mood if available, else demo day mood
  const recentMood = useMemo(() => {
    if (firestoreCalendarEntries && firestoreCalendarEntries.length > 0) {
      const recent = firestoreCalendarEntries.slice(-7).filter(e => e.mood);
      if (recent.length > 0) {
        const counts = {};
        recent.forEach(e => { counts[e.mood] = (counts[e.mood] || 0) + 1; });
        return Object.entries(counts).sort((a, b) => b[1] - a[1])[0][0];
      }
    }
    return currentDemoDay.mood;
  }, [firestoreCalendarEntries, currentDemoDay]);

  const themes = {
    peaceful:   { bg: '#12161c', accent: '#6aadcf', text: '#d0dce5', subtle: '#1a2230', card: '#1e2736' },
    energetic:  { bg: '#1c1412', accent: '#cf8a6a', text: '#e5d8d0', subtle: '#2a1e1a', card: '#362820' },
    reflective: { bg: '#18141c', accent: '#a68acf', text: '#ddd0e5', subtle: '#241a2a', card: '#2e2236' },
    grateful:   { bg: '#121c16', accent: '#6acf8a', text: '#d0e5d8', subtle: '#1a2a1e', card: '#203628' },
    creative:   { bg: '#1c1a12', accent: '#cfba6a', text: '#e5e0d0', subtle: '#2a281a', card: '#363220' },
    calm:       { bg: '#141c18', accent: '#6acfba', text: '#d0e5e0', subtle: '#1a2a26', card: '#203630' },
    inspired:   { bg: '#1a1418', accent: '#cf6aa6', text: '#e5d0dd', subtle: '#2a1a24', card: '#36202e' },
    cozy:       { bg: '#1a1814', accent: '#cfaa6a', text: '#e5ddd0', subtle: '#2a2620', card: '#363020' },
  };

  const theme = themes[recentMood] || themes.peaceful;

  const streak = useMemo(() => {
    if (firestoreEntries.length > 0) {
      const dates = [...new Set(firestoreEntries.map(e => e.dateString))].sort().reverse();
      if (dates.length === 0) return 0;
      let count = 1;
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const latest = new Date(dates[0] + 'T00:00:00');
      if (Math.round((today - latest) / 86400000) > 1) return 0;
      for (let i = 1; i < dates.length; i++) {
        const curr = new Date(dates[i - 1] + 'T00:00:00');
        const prev = new Date(dates[i] + 'T00:00:00');
        if (Math.round((curr - prev) / 86400000) === 1) count++;
        else break;
      }
      return count;
    }
    return demoEntries.filter(e => !e.empty).length;
  }, [firestoreEntries, demoEntries]);

  const formatDate = (date) => {
    const today = new Date();
    const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
    if (date.toDateString() === today.toDateString()) return 'Today';
    if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  };

  // ---- Auth handlers ----
  const handleAuthSubmit = async (e) => {
    e.preventDefault();
    setAuthError('');
    const email = sanitizeEmail(authEmail);
    const password = sanitizePassword(authPassword);
    try {
      if (authMode === 'signin') await signInWithEmailAndPassword(auth, email, password);
      else await createUserWithEmailAndPassword(auth, email, password);
    } catch (err) {
      setAuthError(err.message.replace('Firebase: ', '').replace(/ \(auth\/.*?\)\.?/, ''));
    }
  };

  // ---- Submission handlers ----
  const handleDreamSubmission = async () => {
    const raw = dreamRef.current?.value || dreamText;
    const val = sanitizeText(raw, { trim: true, maxLen: 4000 });
    if (!val) return;
    setDreamText(val);
    setDreamSubmitted(true);
    if (!user) return;
    setDreamSaving(true);
    try {
      const today = new Date().toISOString().split('T')[0];
      let entryId = todayDreamEntryId;
      if (entryId) {
        await updateDoc(doc(db, 'users', user.uid, 'entries', entryId), { text: val, timestamp: serverTimestamp() });
      } else {
        const docRef = await addDoc(collection(db, 'users', user.uid, 'entries'), {
          userId: user.uid, type: 'dream', text: val, dateString: today, timestamp: serverTimestamp(),
        });
        entryId = docRef.id;
        setTodayDreamEntryId(entryId);
      }
      // Always call cloud function (on create AND edit)
      setDreamAiLoading(true);
      try {
        const todayNotesText = todayNotes.map(n => n.text).join('\n');
        const response = await fetch(CF_URLS.dream, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dreamText: val, userId: user.uid, entryId, refreshGoals: !!todayDreamEntryId, quickNotes: todayNotesText }),
        });
        if (response.ok) {
          const aiResult = await response.json();
          setDreamAiResult(aiResult);
        } else {
          console.error('Cloud function returned', response.status);
          setDreamAiResult({ error: true, insight: 'AI is temporarily unavailable ‚Äî your dream was saved successfully. Insights will appear next time.', mood: null, goals: [] });
        }
      } catch (err) {
        console.error('Cloud function error:', err);
        setDreamAiResult({ error: true, insight: 'Could not reach the AI service ‚Äî your dream was saved. Try refreshing goals later.', mood: null, goals: [] });
      } finally {
        setDreamAiLoading(false);
      }
    } catch (err) {
      console.error('Dream submission error:', err);
    } finally {
      setDreamSaving(false);
    }
  };

  const handleEveningSubmission = async () => {
    const raw = eveningRef.current?.value || eveningText;
    const val = sanitizeText(raw, { trim: true, maxLen: 4000 });
    if (!val) return;
    setEveningText(val);
    setEveningSubmitted(true);
    if (!user) return;
    setEveningSaving(true);
    try {
      const today = new Date().toISOString().split('T')[0];
      let entryId = todayJournalEntryId;
      if (entryId) {
        await updateDoc(doc(db, 'users', user.uid, 'entries', entryId), { text: val, timestamp: serverTimestamp() });
      } else {
        const docRef = await addDoc(collection(db, 'users', user.uid, 'entries'), {
          userId: user.uid, type: 'journal', text: val, dateString: today, timestamp: serverTimestamp(),
        });
        entryId = docRef.id;
        setTodayJournalEntryId(entryId);
      }
      // Always call cloud function (on create AND edit)
      setJournalAiLoading(true);
      try {
        const response = await fetch(CF_URLS.journal, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ journalText: val, userId: user.uid, entryId, dateString: today }),
        });
        if (response.ok) {
          const aiResult = await response.json();
          setJournalAiResult(aiResult);
        } else {
          console.error('Cloud function returned', response.status);
          setJournalAiResult({ error: true, insight: 'AI is temporarily unavailable ‚Äî your journal was saved successfully. Insights will appear next time.', mood: null, goals: [] });
        }
      } catch (err) {
        console.error('Cloud function error:', err);
        setJournalAiResult({ error: true, insight: 'Could not reach the AI service ‚Äî your journal was saved. Try again later.', mood: null, goals: [] });
      } finally {
        setJournalAiLoading(false);
      }
    } catch (err) {
      console.error('Evening submission error:', err);
    } finally {
      setEveningSaving(false);
    }
  };

  // ---- Quick note handler ----
  const handleQuickNoteSave = async () => {
    const text = sanitizeText(quickNote, { trim: true, maxLen: 1000 });
    if (!text) return;
    if (!user) return;
    setNoteSaving(true);
    try {
      const today = new Date().toISOString().split('T')[0];
      await addDoc(collection(db, 'users', user.uid, 'entries'), {
        userId: user.uid, type: 'note', text, dateString: today, timestamp: serverTimestamp(),
      });
      setQuickNote('');
    } catch (err) {
      console.error('Quick note save error:', err);
    } finally {
      setNoteSaving(false);
    }
  };

  // ---- History edit handler ----
  const handleHistoryEdit = async () => {
    if (!user || !selectedHistoryDay) return;
    setEditSaving(true);
    try {
      const dateStr = selectedHistoryDay.dateString;
      const dreamEntry = firestoreEntries.find(e => e.type === 'dream' && e.dateString === dateStr);
      const journalEntry = firestoreEntries.find(e => e.type === 'journal' && e.dateString === dateStr);
      const cleanDream = sanitizeText(editDreamText, { trim: true, maxLen: 4000 });
      const cleanJournal = sanitizeText(editJournalText, { trim: true, maxLen: 4000 });

      // Update existing entries
      if (dreamEntry && cleanDream && cleanDream !== dreamEntry.text) {
        await updateDoc(doc(db, 'users', user.uid, 'entries', dreamEntry.id), { text: cleanDream });
      }
      if (journalEntry && cleanJournal && cleanJournal !== journalEntry.text) {
        await updateDoc(doc(db, 'users', user.uid, 'entries', journalEntry.id), { text: cleanJournal });
      }

      // Create new entries if text was added where none existed
      if (!dreamEntry && cleanDream) {
        await addDoc(collection(db, 'users', user.uid, 'entries'), {
          userId: user.uid, type: 'dream', text: cleanDream, dateString: dateStr, timestamp: serverTimestamp(),
        });
      }
      if (!journalEntry && cleanJournal) {
        await addDoc(collection(db, 'users', user.uid, 'entries'), {
          userId: user.uid, type: 'journal', text: cleanJournal, dateString: dateStr, timestamp: serverTimestamp(),
        });
      }

      setEditingHistory(false);
    } catch (err) {
      console.error('History edit error:', err);
    } finally {
      setEditSaving(false);
    }
  };

  // ---- Goal handlers (Firestore-aware) ----
  const toggleMicroGoal = async (id) => {
    const goal = aiMicroGoals.find(g => g.id === id);
    if (!goal) return;
    setAiMicroGoals(gs => gs.map(g => g.id === id ? { ...g, completed: !g.completed } : g));
    if (user && typeof id === 'string') {
      try {
        await updateDoc(doc(db, 'users', user.uid, 'goals', id), {
          completed: !goal.completed, completedAt: !goal.completed ? serverTimestamp() : null,
        });
      } catch (err) { console.error(err); }
    }
  };

  const toggleUserGoal = async (id) => {
    const goal = userGoals.find(g => g.id === id);
    if (!goal) return;
    setUserGoals(gs => gs.map(g => g.id === id ? { ...g, completed: !g.completed } : g));
    if (user && typeof id === 'string') {
      try {
        await updateDoc(doc(db, 'users', user.uid, 'goals', id), {
          completed: !goal.completed, completedAt: !goal.completed ? serverTimestamp() : null,
        });
      } catch (err) { console.error(err); }
    }
  };

  const addUserGoal = async () => {
    const text = sanitizeText(newGoalText, { trim: true, collapseWhitespace: true, maxLen: 200 });
    if (!text) return;
    setNewGoalText('');
    if (user) {
      try {
        const today = new Date().toISOString().split('T')[0];
        await addDoc(collection(db, 'users', user.uid, 'goals'), {
          text, icon: 'üìã', why: 'Added by you', source: 'user',
          completed: false, createdAt: serverTimestamp(), dateString: today, userId: user.uid,
        });
      } catch (err) { console.error(err); }
    } else {
      setUserGoals(prev => [...prev, { id: Date.now(), text, completed: false }]);
    }
  };

  // ---- AI Result Display Component ----
  const AiResultDisplay = ({ aiResult, type }) => (
    <div style={{ padding: '16px 0', fontFamily: '"Fira Code", monospace' }}>
      {aiResult.mood && (
        <div style={{ textAlign: 'center', marginBottom: '16px' }}>
          <span style={{ background: `${(themes[aiResult.mood] || theme).accent}25`, color: (themes[aiResult.mood] || theme).accent, padding: '8px 16px', borderRadius: '10px', fontSize: '13px', border: `1px solid ${(themes[aiResult.mood] || theme).accent}30` }}>
            Feeling: {aiResult.mood}
          </span>
        </div>
      )}
      {aiResult.insight && (
        <div style={{ background: `${theme.accent}12`, borderRadius: '12px', padding: '18px', marginBottom: '20px', borderLeft: `3px solid ${theme.accent}` }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>
            <span style={{ fontSize: '14px' }}>üîÆ</span>
            <span style={{ fontSize: '11px', color: theme.accent, textTransform: 'uppercase', letterSpacing: '0.08em' }}>Pattern noticed</span>
          </div>
          <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>{aiResult.insight}</p>
        </div>
      )}
      {aiResult.goals && aiResult.goals.length > 0 && (
        <div>
          <h3 style={{ fontSize: '13px', color: theme.text, margin: '0 0 12px 0', opacity: 0.6 }}>
            {type === 'dream' ? "Today's goals" : 'Intentions for tomorrow'}
          </h3>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
            {aiResult.goals.map((goal, i) => (
              <div key={i} style={{ background: theme.subtle, borderRadius: '12px', padding: '14px 16px', display: 'flex', alignItems: 'center', gap: '12px' }}>
                <span style={{ fontSize: '18px' }}>{goal.icon}</span>
                <div style={{ flex: 1 }}>
                  <span style={{ fontSize: '13px', color: theme.text, display: 'block', lineHeight: 1.4 }}>{goal.text}</span>
                  {goal.why && <span style={{ fontSize: '11px', color: theme.accent, opacity: 0.7 }}>{goal.why}</span>}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );

  // ---- AI Loading Spinner ----
  const AiLoadingSpinner = ({ message }) => (
    <div style={{ textAlign: 'center', padding: '30px 0' }}>
      <div style={{ width: '40px', height: '40px', border: `3px solid ${theme.subtle}`, borderTopColor: theme.accent, borderRadius: '50%', margin: '0 auto 16px', animation: 'spin 1s linear infinite' }} />
      <p style={{ fontSize: '13px', color: theme.text, opacity: 0.6, fontFamily: '"Fira Code", monospace' }}>{message || 'Processing...'}</p>
    </div>
  );

  // ---- SplashScreen ----
  const SplashScreen = () => (
    <div style={{ position: 'fixed', inset: 0, background: '#12161c', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', zIndex: 9999, animation: 'splashFade 2.2s ease forwards' }}>
      <style>{`@keyframes splashFade { 0% { opacity: 1; } 75% { opacity: 1; } 100% { opacity: 0; pointer-events: none; } }`}</style>
      <img src="/logo.png" alt="Nocturne" style={{ width: '160px', objectFit: 'contain' }} />
    </div>
  );

  // ---- SignInView ----
  const SignInView = () => (
    <div style={{ minHeight: '100vh', background: '#12161c', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: '40px 20px', fontFamily: '"Fira Code", monospace' }}>
      <style>{`@import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap');`}</style>
      <img src="/logo.png" alt="Nocturne" style={{ width: '100px', marginBottom: '28px', objectFit: 'contain' }} />
      <h1 style={{ fontSize: '22px', color: '#d0dce5', fontWeight: 500, margin: '0 0 6px 0' }}>Nocturne</h1>
      <p style={{ fontSize: '13px', color: '#d0dce5', opacity: 0.4, margin: '0 0 36px 0' }}>Your dream & reflection journal</p>
      <form onSubmit={handleAuthSubmit} style={{ width: '100%', maxWidth: '360px', display: 'flex', flexDirection: 'column', gap: '12px' }}>
        <input type="email" placeholder="Email" value={authEmail} onChange={e => setAuthEmail(sanitizeEmail(e.target.value))} required
          style={{ padding: '14px 16px', background: '#1e2736', border: '1px solid #1a2230', borderRadius: '12px', color: '#d0dce5', fontFamily: '"Fira Code", monospace', fontSize: '13px', outline: 'none' }} />
        <input type="password" placeholder="Password" value={authPassword} onChange={e => setAuthPassword(sanitizePassword(e.target.value))} required
          style={{ padding: '14px 16px', background: '#1e2736', border: '1px solid #1a2230', borderRadius: '12px', color: '#d0dce5', fontFamily: '"Fira Code", monospace', fontSize: '13px', outline: 'none' }} />
        {authError && <p style={{ color: '#cf6a6a', fontSize: '12px', margin: 0, textAlign: 'center' }}>{authError}</p>}
        <button type="submit" style={{ padding: '16px', background: 'linear-gradient(135deg, #6aadcf 0%, #6aadcfcc 100%)', color: '#12161c', border: 'none', borderRadius: '12px', fontFamily: '"Fira Code", monospace', fontSize: '14px', fontWeight: 500, cursor: 'pointer', marginTop: '4px' }}>
          {authMode === 'signin' ? 'Sign in ‚Üí' : 'Create account ‚Üí'}
        </button>
      </form>
      <button type="button" onClick={() => { setAuthMode(m => m === 'signin' ? 'signup' : 'signin'); setAuthError(''); }}
        style={{ marginTop: '20px', background: 'transparent', border: 'none', color: '#6aadcf', fontSize: '12px', cursor: 'pointer', fontFamily: '"Fira Code", monospace', opacity: 0.8 }}>
        {authMode === 'signin' ? "Don't have an account? Sign up" : 'Already have an account? Sign in'}
      </button>
    </div>
  );

  // ---- NavBar ----
  const NavBar = () => (
    <nav style={{ position: 'fixed', bottom: 0, left: 0, right: 0, background: `linear-gradient(to top, ${theme.bg} 0%, ${theme.bg}dd 100%)`, borderTop: `1px solid ${theme.subtle}`, padding: '14px 0 30px 0', display: 'flex', justifyContent: 'space-around', backdropFilter: 'blur(20px)', zIndex: 100 }}>
      {[
        { id: 'home', icon: '‚óê', label: 'today' },
        { id: 'goals', icon: '‚óé', label: 'goals' },
        { id: 'history', icon: '‚ó´', label: 'history' },
        { id: 'wrapped', icon: '‚ú¶', label: 'wrapped' },
      ].map(item => (
        <button key={item.id} onClick={() => { setCurrentView(item.id); setSelectedHistoryDay(null); setEditingHistory(false); }}
          style={{ background: currentView === item.id ? theme.card : 'transparent', border: 'none', cursor: 'pointer', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '6px', opacity: currentView === item.id ? 1 : 0.5, transition: 'all 0.3s ease', padding: '10px 20px', borderRadius: '12px' }}>
          <span style={{ fontSize: '18px', color: currentView === item.id ? theme.accent : theme.text }}>{item.icon}</span>
          <span style={{ fontFamily: '"Fira Code", monospace', fontSize: '10px', color: theme.text, letterSpacing: '0.02em' }}>{item.label}</span>
        </button>
      ))}
    </nav>
  );

  // ---- DemoToggle ----
  const DemoToggle = () => (
    <div style={{ position: 'fixed', top: '16px', left: '50%', transform: 'translateX(-50%)', background: theme.card, border: `1px solid ${theme.subtle}`, borderRadius: '12px', padding: '6px', display: 'flex', gap: '6px', zIndex: 200, fontFamily: '"Fira Code", monospace' }}>
      <button onClick={nextDemoDay} style={{ background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}aa 100%)`, color: theme.bg, border: 'none', borderRadius: '8px', padding: '8px 14px', fontSize: '11px', fontWeight: 500, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '6px' }}>
        <span>‚Üª</span> New Day
      </button>
      <div style={{ display: 'flex', gap: '2px', background: theme.subtle, borderRadius: '8px', padding: '2px' }}>
        {['morning', 'afternoon', 'evening'].map(time => (
          <button key={time} onClick={() => setDemoTime(time)}
            style={{ background: demoTime === time ? theme.card : 'transparent', color: demoTime === time ? theme.accent : theme.text, border: 'none', borderRadius: '6px', padding: '6px 10px', fontSize: '11px', cursor: 'pointer', opacity: demoTime === time ? 1 : 0.5, transition: 'all 0.2s ease' }}>
            {time === 'morning' ? '‚òÄÔ∏è' : time === 'afternoon' ? 'üå§' : 'üåô'}
          </button>
        ))}
      </div>
    </div>
  );

  // ---- Chip ----
  const Chip = ({ text, onClick }) => (
    <button onClick={onClick}
      style={{ background: theme.card, border: `1px solid ${theme.subtle}`, borderRadius: '8px', padding: '10px 14px', fontFamily: '"Fira Code", monospace', fontSize: '12px', color: theme.text, opacity: 0.8, cursor: 'pointer', whiteSpace: 'nowrap', transition: 'all 0.2s ease' }}
      onMouseEnter={e => { e.target.style.opacity = '1'; e.target.style.borderColor = theme.accent; }}
      onMouseLeave={e => { e.target.style.opacity = '0.8'; e.target.style.borderColor = theme.subtle; }}>
      {text}
    </button>
  );

  // ---- HomeView ----
  const HomeView = () => {
    const greeting = demoTime === 'morning'
      ? { symbol: '‚òÄÔ∏è', text: 'Good morning', sub: 'Capture your dreams before they fade' }
      : demoTime === 'afternoon'
      ? { symbol: 'üå§', text: 'Good afternoon', sub: "How's your day going?" }
      : { symbol: 'üåô', text: 'Good evening', sub: 'Time to reflect on your day' };

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
        <div style={{ textAlign: 'center', paddingTop: '60px', fontFamily: '"Fira Code", monospace' }}>
          <span style={{ fontSize: '40px', display: 'block', marginBottom: '16px' }}>{greeting.symbol}</span>
          <h1 style={{ fontSize: '22px', fontWeight: 500, color: theme.text, margin: '0 0 8px 0', letterSpacing: '-0.01em' }}>{greeting.text}</h1>
          <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: '0 0 24px 0' }}>{greeting.sub}</p>
          <div style={{ display: 'inline-flex', alignItems: 'center', gap: '8px', background: theme.card, border: `1px solid ${theme.subtle}`, borderRadius: '10px', padding: '10px 18px' }}>
            <span style={{ fontSize: '16px' }}>üî•</span>
            <span style={{ fontSize: '14px', color: theme.accent, fontWeight: 500 }}>{streak} day streak</span>
          </div>
        </div>

        {/* Morning: Dream Journal */}
        {demoTime === 'morning' && (
          <div style={{ background: theme.card, borderRadius: '16px', padding: '24px', border: `1px solid ${theme.subtle}` }}>
            {!dreamSubmitted ? (
              <>
                <h2 style={{ fontFamily: '"Fira Code", monospace', fontSize: '15px', fontWeight: 500, color: theme.text, margin: '0 0 4px 0' }}>What did you dream about?</h2>
                <p style={{ fontFamily: '"Fira Code", monospace', fontSize: '12px', color: theme.text, opacity: 0.4, margin: '0 0 16px 0' }}>Even fragments help you remember better</p>
                <textarea ref={dreamRef} placeholder="I dreamed that..." rows={4}
                  style={{ width: '100%', padding: '16px', border: `1px solid ${theme.subtle}`, borderRadius: '12px', fontFamily: '"Fira Code", monospace', fontSize: '14px', lineHeight: 1.7, color: theme.text, background: theme.bg, resize: 'none', outline: 'none', boxSizing: 'border-box' }} />
                <div style={{ display: 'flex', gap: '8px', marginTop: '14px', flexWrap: 'wrap' }}>
                  <Chip text="I was flying..." onClick={() => { if (dreamRef.current) dreamRef.current.value = 'I was flying...'; }} />
                  <Chip text="I felt..." onClick={() => { if (dreamRef.current) dreamRef.current.value = 'I felt...'; }} />
                  <Chip text="Can't remember" onClick={() => { if (dreamRef.current) dreamRef.current.value = "Can't remember any dreams today."; }} />
                </div>
                <button onClick={handleDreamSubmission} disabled={dreamSaving}
                  style={{ marginTop: '20px', width: '100%', padding: '16px', background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`, color: theme.bg, border: 'none', borderRadius: '12px', fontFamily: '"Fira Code", monospace', fontSize: '14px', fontWeight: 500, cursor: dreamSaving ? 'not-allowed' : 'pointer', opacity: dreamSaving ? 0.7 : 1, transition: 'all 0.2s ease' }}>
                  {dreamSaving ? 'Saving...' : 'Lock it in ‚Üí'}
                </button>
              </>
            ) : (
              <div style={{ fontFamily: '"Fira Code", monospace' }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                  <h2 style={{ fontSize: '16px', fontWeight: 500, color: theme.text, margin: 0 }}>‚ú® Dream captured</h2>
                  <button onClick={() => setDreamSubmitted(false)}
                    style={{ background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '8px', padding: '6px 14px', fontSize: '12px', color: theme.text, opacity: 0.7, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}>
                    Edit
                  </button>
                </div>
                <div style={{ background: theme.bg, border: `1px solid ${theme.subtle}`, borderRadius: '12px', padding: '14px', color: theme.text, fontSize: '13px', lineHeight: 1.6, opacity: 0.8, marginBottom: '8px' }}>
                  {dreamText || currentDemoDay.dream}
                </div>
                {dreamAiLoading && <AiLoadingSpinner message="Nocturne is reading your dream..." />}
                {dreamAiResult && <AiResultDisplay aiResult={dreamAiResult} type="dream" />}
              </div>
            )}
          </div>
        )}

        {/* Afternoon: AI Insights + Quick Notes */}
        {demoTime === 'afternoon' && (
          <div style={{ background: theme.card, borderRadius: '16px', padding: '24px', border: `1px solid ${theme.subtle}`, fontFamily: '"Fira Code", monospace' }}>
            {dreamAiResult ? (
              <>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '20px' }}>
                  <span style={{ fontSize: '20px' }}>‚ú®</span>
                  <div>
                    <h2 style={{ fontSize: '15px', fontWeight: 500, color: theme.text, margin: 0 }}>Your morning insights</h2>
                    <p style={{ fontSize: '11px', color: theme.text, opacity: 0.5, margin: 0 }}>Based on your dream this morning</p>
                  </div>
                </div>
                <AiResultDisplay aiResult={dreamAiResult} type="dream" />
              </>
            ) : (
              <div style={{ textAlign: 'center', padding: '20px 0' }}>
                <span style={{ fontSize: '40px', display: 'block', marginBottom: '16px' }}>üí≠</span>
                <h2 style={{ fontSize: '17px', fontWeight: 500, color: theme.text, margin: '0 0 8px 0' }}>No dream recorded yet</h2>
                <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: '0 0 24px 0', lineHeight: 1.6, maxWidth: '280px', marginLeft: 'auto', marginRight: 'auto' }}>
                  Write your morning dream to get personalized insights and goals
                </p>
                <button onClick={() => setDemoTime('morning')}
                  style={{ background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`, color: theme.bg, border: 'none', borderRadius: '12px', padding: '14px 28px', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}>
                  Write a dream ‚Üí
                </button>
              </div>
            )}

            {/* Quick notes section */}
            <div style={{ marginTop: '24px', paddingTop: '24px', borderTop: `1px solid ${theme.subtle}` }}>
              <p style={{ fontSize: '12px', color: theme.text, opacity: 0.5, margin: '0 0 12px 0' }}>Capture a quick thought</p>
              <div style={{ display: 'flex', gap: '10px' }}>
                <input type="text" value={quickNote} onChange={e => setQuickNote(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && handleQuickNoteSave()}
                  placeholder="What's on your mind..."
                  style={{ flex: 1, padding: '14px 16px', border: `1px solid ${theme.subtle}`, borderRadius: '10px', fontFamily: '"Fira Code", monospace', fontSize: '13px', color: theme.text, background: theme.bg, outline: 'none' }} />
                <button onClick={handleQuickNoteSave} disabled={noteSaving}
                  style={{ background: theme.accent, color: theme.bg, border: 'none', borderRadius: '10px', padding: '14px 20px', fontSize: '13px', fontWeight: 500, cursor: noteSaving ? 'not-allowed' : 'pointer', fontFamily: '"Fira Code", monospace', opacity: noteSaving ? 0.7 : 1 }}>
                  {noteSaving ? '...' : 'Save'}
                </button>
              </div>
              {todayNotes.length > 0 && (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginTop: '14px' }}>
                  {todayNotes.map((note, i) => (
                    <div key={note.id || i} style={{ background: theme.subtle, borderRadius: '8px', padding: '10px 14px', fontSize: '12px', color: theme.text, opacity: 0.7, lineHeight: 1.5 }}>
                      {note.text}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Evening: Reflection */}
        {demoTime === 'evening' && (
          <div style={{ background: theme.card, borderRadius: '16px', padding: '24px', border: `1px solid ${theme.subtle}` }}>
            {!eveningSubmitted ? (
              <>
                <h2 style={{ fontFamily: '"Fira Code", monospace', fontSize: '15px', fontWeight: 500, color: theme.text, margin: '0 0 4px 0' }}>How was your day?</h2>
                <p style={{ fontFamily: '"Fira Code", monospace', fontSize: '12px', color: theme.text, opacity: 0.4, margin: '0 0 16px 0' }}>Reflect on what stood out</p>
                <textarea ref={eveningRef} placeholder="Today I..." rows={5}
                  style={{ width: '100%', padding: '16px', border: `1px solid ${theme.subtle}`, borderRadius: '12px', fontFamily: '"Fira Code", monospace', fontSize: '14px', lineHeight: 1.7, color: theme.text, background: theme.bg, resize: 'none', outline: 'none', boxSizing: 'border-box' }} />
                <div style={{ display: 'flex', gap: '8px', marginTop: '14px', flexWrap: 'wrap' }}>
                  <Chip text="I'm grateful for..." onClick={() => { if (eveningRef.current) eveningRef.current.value = "I'm grateful for..."; }} />
                  <Chip text="Today I learned..." onClick={() => { if (eveningRef.current) eveningRef.current.value = 'Today I learned...'; }} />
                  <Chip text="A highlight was..." onClick={() => { if (eveningRef.current) eveningRef.current.value = 'A highlight was...'; }} />
                </div>
                <button onClick={handleEveningSubmission} disabled={eveningSaving}
                  style={{ marginTop: '20px', width: '100%', padding: '16px', background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`, color: theme.bg, border: 'none', borderRadius: '12px', fontFamily: '"Fira Code", monospace', fontSize: '14px', fontWeight: 500, cursor: eveningSaving ? 'not-allowed' : 'pointer', opacity: eveningSaving ? 0.7 : 1, transition: 'all 0.2s ease' }}>
                  {eveningSaving ? 'Saving...' : 'Lock it in ‚Üí'}
                </button>
              </>
            ) : (
              <div style={{ fontFamily: '"Fira Code", monospace' }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                  <h2 style={{ fontSize: '16px', fontWeight: 500, color: theme.text, margin: 0 }}>üåô Day complete</h2>
                  <button onClick={() => setEveningSubmitted(false)}
                    style={{ background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '8px', padding: '6px 14px', fontSize: '12px', color: theme.text, opacity: 0.7, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}>
                    Edit
                  </button>
                </div>
                <div style={{ background: theme.bg, border: `1px solid ${theme.subtle}`, borderRadius: '12px', padding: '14px', color: theme.text, fontSize: '13px', lineHeight: 1.6, opacity: 0.8, marginBottom: '8px' }}>
                  {eveningText || currentDemoDay.reflection}
                </div>
                {journalAiLoading && <AiLoadingSpinner message="Nocturne is reflecting on your day..." />}
                {journalAiResult && <AiResultDisplay aiResult={journalAiResult} type="journal" />}
                <div style={{ marginTop: '16px', padding: '14px', background: `${theme.accent}15`, border: `1px solid ${theme.accent}30`, borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '10px' }}>
                  <span style={{ fontSize: '20px' }}>üî•</span>
                  <span style={{ fontSize: '15px', color: theme.accent, fontWeight: 500 }}>{streak + 1} day streak!</span>
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  // ---- GoalsView ----
  const GoalsView = () => {
    const refreshMicroGoals = async () => {
      if (!user || generatingGoals) return;
      setGeneratingGoals(true);
      try {
        const today = new Date().toISOString().split('T')[0];
        const todayDream = firestoreEntries.find(e => e.type === 'dream' && e.dateString === today);
        const todayNotesText = todayNotes.map(n => n.text).join('\n');

        const response = await fetch(CF_URLS.dream, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            dreamText: todayDream?.text || 'No dream recorded today',
            userId: user.uid,
            refreshGoals: true,
            quickNotes: todayNotesText,
          }),
        });
        if (response.ok) {
          const aiResult = await response.json();
          setDreamAiResult(aiResult);
          // Goals will also update via Firestore onSnapshot
        }
      } catch (err) {
        console.error('Refresh goals error:', err);
      } finally {
        setGeneratingGoals(false);
      }
    };

    const completedCount = [...aiMicroGoals, ...userGoals].filter(g => g.completed).length;
    const totalCount = aiMicroGoals.length + userGoals.length;

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '20px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{ paddingTop: '60px', textAlign: 'center' }}>
          <h1 style={{ fontSize: '22px', fontWeight: 500, color: theme.text, margin: '0 0 8px 0' }}>Today's Goals</h1>
          <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: 0 }}>Small steps, big progress</p>
        </div>

        {totalCount > 0 && (
          <div style={{ background: theme.card, borderRadius: '14px', padding: '18px', border: `1px solid ${theme.subtle}` }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <span style={{ fontSize: '13px', color: theme.text, opacity: 0.7 }}>Progress</span>
              <span style={{ fontSize: '14px', color: theme.accent, fontWeight: 500 }}>{completedCount}/{totalCount}</span>
            </div>
            <div style={{ background: theme.subtle, borderRadius: '100px', height: '8px', overflow: 'hidden' }}>
              <div style={{ width: `${totalCount > 0 ? (completedCount / totalCount) * 100 : 0}%`, height: '100%', background: `linear-gradient(90deg, ${theme.accent} 0%, ${theme.accent}aa 100%)`, borderRadius: '100px', transition: 'width 0.3s ease' }} />
            </div>
          </div>
        )}

        <div style={{ background: theme.card, borderRadius: '16px', padding: '20px', border: `1px solid ${theme.subtle}` }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
            <div>
              <h3 style={{ fontSize: '14px', color: theme.text, margin: '0 0 4px 0', fontWeight: 500 }}>‚ú® Suggested for you</h3>
              <p style={{ fontSize: '11px', color: theme.text, opacity: 0.5, margin: 0 }}>Based on your recent entries</p>
            </div>
            {user && (
              <button onClick={refreshMicroGoals} disabled={generatingGoals}
                style={{ background: theme.subtle, border: 'none', borderRadius: '8px', padding: '8px 12px', fontSize: '12px', color: theme.accent, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '6px', opacity: generatingGoals ? 0.5 : 1 }}>
                <span style={{ display: 'inline-block', animation: generatingGoals ? 'spin 1s linear infinite' : 'none' }}>‚Üª</span> Refresh
              </button>
            )}
          </div>
          {aiMicroGoals.length === 0 ? (
            <div style={{ textAlign: 'center', padding: '24px 0' }}>
              <span style={{ fontSize: '32px', display: 'block', marginBottom: '12px' }}>üí≠</span>
              <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: 0, lineHeight: 1.6 }}>
                No AI goals yet. Write a dream or journal entry to get personalized suggestions.
              </p>
            </div>
          ) : (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {aiMicroGoals.map(goal => (
                <div key={goal.id} onClick={() => toggleMicroGoal(goal.id)}
                  style={{ background: goal.completed ? `${theme.accent}15` : theme.subtle, border: `1px solid ${goal.completed ? theme.accent + '40' : 'transparent'}`, borderRadius: '12px', padding: '14px 16px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '12px', transition: 'all 0.2s ease' }}>
                  <div style={{ width: '22px', height: '22px', borderRadius: '6px', border: `2px solid ${goal.completed ? theme.accent : theme.text + '40'}`, background: goal.completed ? theme.accent : 'transparent', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, transition: 'all 0.2s ease' }}>
                    {goal.completed && <span style={{ color: theme.bg, fontSize: '12px' }}>‚úì</span>}
                  </div>
                  <span style={{ fontSize: '18px' }}>{goal.icon}</span>
                  <div style={{ flex: 1 }}>
                    <span style={{ fontSize: '13px', color: theme.text, opacity: goal.completed ? 0.6 : 0.9, textDecoration: goal.completed ? 'line-through' : 'none', lineHeight: 1.4, display: 'block' }}>{goal.text}</span>
                    {(goal.source || goal.why) && <span style={{ fontSize: '11px', color: theme.accent, opacity: 0.7 }}>{goal.source || goal.why}</span>}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        <div style={{ background: theme.card, borderRadius: '16px', padding: '20px', border: `1px solid ${theme.subtle}` }}>
          <h3 style={{ fontSize: '14px', color: theme.text, margin: '0 0 16px 0', fontWeight: 500 }}>üìã Your Goals</h3>
          <div style={{ display: 'flex', gap: '10px', marginBottom: userGoals.length > 0 ? '16px' : '0' }}>
            <input type="text" value={newGoalText} onChange={e => setNewGoalText(e.target.value)} onKeyDown={e => e.key === 'Enter' && addUserGoal()} placeholder="Add a goal for today..."
              style={{ flex: 1, padding: '14px 16px', border: `1px solid ${theme.subtle}`, borderRadius: '10px', fontFamily: '"Fira Code", monospace', fontSize: '13px', color: theme.text, background: theme.bg, outline: 'none' }} />
            <button onClick={addUserGoal} style={{ background: theme.accent, color: theme.bg, border: 'none', borderRadius: '10px', padding: '14px 18px', fontSize: '16px', cursor: 'pointer' }}>+</button>
          </div>
          {userGoals.length > 0 && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {userGoals.map(goal => (
                <div key={goal.id} onClick={() => toggleUserGoal(goal.id)}
                  style={{ background: goal.completed ? `${theme.accent}15` : theme.subtle, border: `1px solid ${goal.completed ? theme.accent + '40' : 'transparent'}`, borderRadius: '12px', padding: '14px 16px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '12px', transition: 'all 0.2s ease' }}>
                  <div style={{ width: '22px', height: '22px', borderRadius: '6px', border: `2px solid ${goal.completed ? theme.accent : theme.text + '40'}`, background: goal.completed ? theme.accent : 'transparent', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>
                    {goal.completed && <span style={{ color: theme.bg, fontSize: '12px' }}>‚úì</span>}
                  </div>
                  <span style={{ fontSize: '13px', color: theme.text, opacity: goal.completed ? 0.6 : 0.9, textDecoration: goal.completed ? 'line-through' : 'none' }}>{goal.text}</span>
                </div>
              ))}
            </div>
          )}
          {userGoals.length === 0 && <p style={{ fontSize: '12px', color: theme.text, opacity: 0.4, margin: '12px 0 0 0', textAlign: 'center' }}>No goals yet. What do you want to accomplish today?</p>}
        </div>

        {totalCount > 0 && completedCount === totalCount && (
          <div style={{ background: `linear-gradient(135deg, ${theme.accent}20 0%, ${theme.accent}10 100%)`, borderRadius: '14px', padding: '24px', textAlign: 'center', border: `1px solid ${theme.accent}30` }}>
            <span style={{ fontSize: '32px', display: 'block', marginBottom: '12px' }}>üéâ</span>
            <p style={{ fontSize: '15px', color: theme.text, margin: 0, fontWeight: 500 }}>All goals complete!</p>
            <p style={{ fontSize: '12px', color: theme.text, opacity: 0.6, margin: '8px 0 0 0' }}>You're crushing it today</p>
          </div>
        )}
      </div>
    );
  };

  // ---- HistoryView ----
  const HistoryView = () => {
    const today = new Date();

    const entryByDate = {};
    calendarEntries.forEach(e => {
      if (!e.empty) {
        const dateStr = e.dateString || e.date?.toISOString()?.split('T')[0];
        if (dateStr) entryByDate[dateStr] = e;
      }
    });

    const firstDay = new Date(calYear, calMonth, 1).getDay();
    const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
    const cells = [];
    for (let i = 0; i < firstDay; i++) cells.push(null);
    for (let d = 1; d <= daysInMonth; d++) cells.push(d);

    const monthName = new Date(calYear, calMonth).toLocaleString('en-US', { month: 'long', year: 'numeric' });
    const isCurrentMonth = calMonth === today.getMonth() && calYear === today.getFullYear();

    const prevMonth = () => { if (calMonth === 0) { setCalMonth(11); setCalYear(y => y - 1); } else setCalMonth(m => m - 1); };
    const nextMonth = () => { if (isCurrentMonth) return; if (calMonth === 11) { setCalMonth(0); setCalYear(y => y + 1); } else setCalMonth(m => m + 1); };

    const textareaStyle = { width: '100%', padding: '12px', border: `1px solid ${theme.subtle}`, borderRadius: '10px', fontFamily: '"Fira Code", monospace', fontSize: '13px', lineHeight: 1.6, color: theme.text, background: theme.bg, resize: 'none', outline: 'none', boxSizing: 'border-box' };

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '24px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{ paddingTop: '60px', textAlign: 'center' }}>
          <h1 style={{ fontSize: '22px', fontWeight: 500, color: theme.text, margin: '0 0 8px 0' }}>History</h1>
          <p style={{ fontSize: '13px', color: theme.text, opacity: 0.5, margin: 0 }}>Tap any day to revisit</p>
        </div>

        <div style={{ background: theme.card, borderRadius: '16px', padding: '20px', border: `1px solid ${theme.subtle}` }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '18px' }}>
            <button onClick={prevMonth} style={{ background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '8px', padding: '6px 12px', color: theme.text, cursor: 'pointer', fontSize: '14px', fontFamily: '"Fira Code", monospace', opacity: 0.7 }}>‚Üê</button>
            <span style={{ fontSize: '14px', color: theme.text, fontWeight: 500 }}>{monthName}</span>
            <button onClick={nextMonth} style={{ background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '8px', padding: '6px 12px', color: theme.text, cursor: isCurrentMonth ? 'default' : 'pointer', fontSize: '14px', fontFamily: '"Fira Code", monospace', opacity: isCurrentMonth ? 0.2 : 0.7 }}>‚Üí</button>
          </div>

          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '6px', marginBottom: '8px' }}>
            {['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map((d, i) => (
              <span key={i} style={{ textAlign: 'center', fontSize: '10px', color: theme.text, opacity: 0.35, paddingBottom: '4px' }}>{d}</span>
            ))}
          </div>

          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '6px' }}>
            {cells.map((day, i) => {
              if (!day) return <div key={i} />;
              const dateStr = `${calYear}-${String(calMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
              const entry = entryByDate[dateStr];
              const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
              const isToday = dateStr === todayStr;
              const isFuture = dateStr > todayStr;
              const moodAccent = entry?.mood ? (themes[entry.mood] || theme).accent : theme.accent;
              return (
                <button key={i} type="button" onClick={() => {
                  if (entry) {
                    setSelectedHistoryDay(entry);
                    setEditingHistory(false);
                    setEditDreamText(entry.dream || '');
                    setEditJournalText(entry.reflection || '');
                    setTimeout(() => historyDetailRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                  }
                }} disabled={!entry || isFuture}
                  style={{ aspectRatio: '1', borderRadius: '10px', border: isToday ? `2px solid ${theme.accent}` : `1px solid ${entry ? moodAccent + '40' : 'transparent'}`, background: entry ? `${moodAccent}30` : isFuture ? 'transparent' : theme.subtle, cursor: entry ? 'pointer' : 'default', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '2px', transition: 'all 0.15s ease', padding: '2px' }}>
                  <span style={{ fontSize: '12px', color: entry ? theme.text : `${theme.text}${isFuture ? '20' : '40'}`, fontFamily: '"Fira Code", monospace', fontWeight: isToday ? 600 : 400 }}>{day}</span>
                  {entry && <span style={{ fontSize: '7px', lineHeight: 1 }}>{entry.dream ? 'üí≠' : ''}{entry.reflection ? 'üåô' : ''}</span>}
                </button>
              );
            })}
          </div>

          <div style={{ display: 'flex', gap: '16px', marginTop: '16px', paddingTop: '14px', borderTop: `1px solid ${theme.subtle}`, justifyContent: 'center' }}>
            <span style={{ fontSize: '11px', color: theme.text, opacity: 0.5 }}>üí≠ dream</span>
            <span style={{ fontSize: '11px', color: theme.text, opacity: 0.5 }}>üåô journal</span>
          </div>
        </div>

        {selectedHistoryDay && (
          <div ref={historyDetailRef} style={{ background: theme.card, borderRadius: '16px', padding: '24px', border: `1px solid ${theme.accent}50`, animation: 'fadeIn 0.3s ease' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h3 style={{ fontSize: '16px', fontWeight: 500, color: theme.text, margin: 0 }}>{formatDate(selectedHistoryDay.date)}</h3>
              {selectedHistoryDay.mood && (
                <span style={{ background: `${(themes[selectedHistoryDay.mood] || theme).accent}30`, color: (themes[selectedHistoryDay.mood] || theme).accent, padding: '6px 12px', borderRadius: '8px', fontSize: '12px' }}>{selectedHistoryDay.mood}</span>
              )}
            </div>

            {editingHistory ? (
              <>
                <div style={{ marginBottom: '18px' }}>
                  <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>Dream</p>
                  <textarea value={editDreamText} onChange={e => setEditDreamText(e.target.value)} rows={3} placeholder="No dream recorded..." style={textareaStyle} />
                </div>
                <div style={{ marginBottom: '18px' }}>
                  <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>Reflection</p>
                  <textarea value={editJournalText} onChange={e => setEditJournalText(e.target.value)} rows={4} placeholder="No reflection recorded..." style={textareaStyle} />
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={handleHistoryEdit} disabled={editSaving}
                    style={{ flex: 1, padding: '12px', background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`, color: theme.bg, border: 'none', borderRadius: '10px', fontSize: '13px', fontWeight: 500, cursor: editSaving ? 'not-allowed' : 'pointer', fontFamily: '"Fira Code", monospace', opacity: editSaving ? 0.7 : 1 }}>
                    {editSaving ? 'Saving...' : 'Save changes'}
                  </button>
                  <button onClick={() => setEditingHistory(false)}
                    style={{ padding: '12px 20px', background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '10px', fontSize: '13px', color: theme.text, opacity: 0.7, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}>
                    Cancel
                  </button>
                </div>
              </>
            ) : (
              <>
                {selectedHistoryDay.dream && (
                  <div style={{ marginBottom: '18px' }}>
                    <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>Dream</p>
                    <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>{selectedHistoryDay.dream}</p>
                  </div>
                )}
                {selectedHistoryDay.reflection && (
                  <div style={{ marginBottom: '18px' }}>
                    <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>Reflection</p>
                    <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>{selectedHistoryDay.reflection}</p>
                  </div>
                )}
                {selectedHistoryDay.notes && selectedHistoryDay.notes.length > 0 && (
                  <div style={{ marginBottom: '18px' }}>
                    <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>Quick Notes</p>
                    {selectedHistoryDay.notes.map((note, i) => (
                      <p key={i} style={{ fontSize: '13px', color: theme.text, margin: '0 0 6px 0', lineHeight: 1.6, opacity: 0.75 }}>‚Ä¢ {note}</p>
                    ))}
                  </div>
                )}
                {selectedHistoryDay.gratitude && (
                  <div style={{ background: theme.subtle, borderRadius: '10px', padding: '14px', marginBottom: '18px' }}>
                    <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>AI Insight</p>
                    <p style={{ fontSize: '13px', color: theme.text, margin: 0, opacity: 0.8 }}>{selectedHistoryDay.gratitude}</p>
                  </div>
                )}
                <div style={{ display: 'flex', gap: '10px' }}>
                  {user && selectedHistoryDay.dateString && (
                    <button onClick={() => {
                      setEditingHistory(true);
                      setEditDreamText(selectedHistoryDay.dream || '');
                      setEditJournalText(selectedHistoryDay.reflection || '');
                    }}
                      style={{ flex: 1, padding: '12px', background: theme.subtle, border: 'none', borderRadius: '10px', fontSize: '13px', color: theme.accent, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}>
                      Edit
                    </button>
                  )}
                  <button onClick={() => { setSelectedHistoryDay(null); setEditingHistory(false); }}
                    style={{ flex: 1, padding: '12px', background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '10px', fontSize: '13px', color: theme.text, opacity: 0.7, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}>
                    Close
                  </button>
                </div>
              </>
            )}
          </div>
        )}
      </div>
    );
  };

  // ---- WrappedView ----
  const WrappedView = () => {
    const recentEntries = calendarEntries.filter(e => !e.empty).slice(-7);
    const moodCounts = {};
    recentEntries.forEach(e => { if (e.mood) moodCounts[e.mood] = (moodCounts[e.mood] || 0) + 1; });
    const topMoods = Object.entries(moodCounts).sort((a, b) => b[1] - a[1]).slice(0, 3).map(m => m[0]);
    const dreamsRemembered = recentEntries.filter(e => e.dream).length;
    const totalWords = recentEntries.reduce((acc, e) => acc + (e.dream?.split(' ').length || 0) + (e.reflection?.split(' ').length || 0), 0);

    // Get real AI insights from recent entries
    const weeklyInsight = (() => {
      const entriesWithInsight = firestoreEntries.filter(e => e.aiResult?.insight).slice(0, 3);
      if (entriesWithInsight.length > 0) {
        return entriesWithInsight.map(e => e.aiResult.insight).join(' ');
      }
      if (topMoods[0]) {
        return `You've been feeling most ${topMoods[0]} this week. Keep journaling to unlock deeper insights from Nocturne.`;
      }
      return 'Start journaling to see your weekly insights here.';
    })();

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '20px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{ textAlign: 'center', paddingTop: '60px', paddingBottom: '10px' }}>
          <p style={{ fontSize: '12px', color: theme.text, opacity: 0.4, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.1em' }}>This Week</p>
          <h1 style={{ fontSize: '28px', fontWeight: 500, color: theme.text, margin: '0 0 4px 0' }}>‚ú¶ Your Wrapped</h1>
        </div>

        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px' }}>
          {[
            { label: 'Days logged', value: recentEntries.length, icon: 'üìù' },
            { label: 'Dreams', value: dreamsRemembered, icon: 'üí≠' },
            { label: 'Words', value: totalWords, icon: '‚úèÔ∏è' },
            { label: 'Streak', value: streak, icon: 'üî•' },
          ].map((stat, i) => (
            <div key={i} style={{ background: theme.card, borderRadius: '14px', padding: '20px', textAlign: 'center', border: `1px solid ${theme.subtle}` }}>
              <span style={{ fontSize: '24px', display: 'block', marginBottom: '10px' }}>{stat.icon}</span>
              <p style={{ fontSize: '28px', fontWeight: 500, color: theme.text, margin: '0 0 4px 0' }}>{stat.value}</p>
              <p style={{ fontSize: '11px', color: theme.text, opacity: 0.5, margin: 0 }}>{stat.label}</p>
            </div>
          ))}
        </div>

        {topMoods.length > 0 && (
          <div style={{ background: theme.card, borderRadius: '14px', padding: '20px', border: `1px solid ${theme.subtle}` }}>
            <h3 style={{ fontSize: '14px', fontWeight: 500, color: theme.text, margin: '0 0 16px 0' }}>Your vibes this week</h3>
            <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
              {topMoods.map((mood, i) => (
                <span key={i} style={{ background: `${(themes[mood] || theme).accent}25`, color: (themes[mood] || theme).accent, padding: '10px 18px', borderRadius: '10px', fontSize: '13px', border: `1px solid ${(themes[mood] || theme).accent}30` }}>{mood}</span>
              ))}
            </div>
          </div>
        )}

        <div style={{ background: `${theme.accent}12`, borderRadius: '14px', padding: '22px', borderLeft: `3px solid ${theme.accent}` }}>
          <h3 style={{ fontSize: '14px', fontWeight: 500, color: theme.accent, margin: '0 0 12px 0', display: 'flex', alignItems: 'center', gap: '8px' }}>
            <span>‚ú®</span> Weekly Insight
          </h3>
          <p style={{ fontSize: '14px', color: theme.text, margin: 0, lineHeight: 1.7, opacity: 0.85 }}>
            {weeklyInsight}
          </p>
        </div>

        <div style={{ background: `linear-gradient(135deg, ${theme.accent}20 0%, ${theme.accent}10 100%)`, borderRadius: '14px', padding: '28px', textAlign: 'center', border: `1px solid ${theme.accent}30` }}>
          <span style={{ fontSize: '40px', display: 'block', marginBottom: '12px' }}>üî•</span>
          <p style={{ fontSize: '22px', fontWeight: 500, color: theme.text, margin: '0 0 6px 0' }}>{streak} day streak!</p>
          <p style={{ fontSize: '13px', color: theme.text, opacity: 0.6, margin: 0 }}>Keep going ‚Äî you're building something meaningful</p>
        </div>

        <button onClick={() => signOut(auth)} style={{ background: 'transparent', border: `1px solid ${theme.subtle}`, borderRadius: '10px', padding: '12px', fontSize: '12px', color: theme.text, opacity: 0.4, cursor: 'pointer', fontFamily: '"Fira Code", monospace' }}>
          Sign out
        </button>
      </div>
    );
  };

  // ---- Render ----
  if (showSplash || authLoading) return <>{SplashScreen()}</>;
  if (!user) return SignInView();

  return (
    <div style={{ minHeight: '100vh', background: theme.bg, fontFamily: '"SF Mono", "Fira Code", Consolas, monospace', transition: 'background 0.5s ease' }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap');
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        ::placeholder { color: ${theme.text}40; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: ${theme.bg}; }
        ::-webkit-scrollbar-thumb { background: ${theme.accent}40; border-radius: 3px; }
      `}</style>

      <DemoToggle />

      <div style={{ maxWidth: '480px', margin: '0 auto', padding: '20px 20px 120px 20px' }}>
        {currentView === 'home' && HomeView()}
        {currentView === 'goals' && GoalsView()}
        {currentView === 'history' && HistoryView()}
        {currentView === 'wrapped' && WrappedView()}
      </div>

      <NavBar />
    </div>
  );
};

export default DaylightJournal;
