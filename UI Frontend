import React, { useState, useMemo, useRef, useCallback } from 'react';

const DaylightJournal = () => {
  const [currentView, setCurrentView] = useState('home');
  const [demoTime, setDemoTime] = useState('morning'); // morning, afternoon, evening
  const [demoDay, setDemoDay] = useState(0); // For cycling through demo days
  const [selectedHistoryDay, setSelectedHistoryDay] = useState(null);
  const [quickNote, setQuickNote] = useState('');
  const [selectedGoal, setSelectedGoal] = useState(null);
  const [dreamSubmitted, setDreamSubmitted] = useState(false);
  const [eveningSubmitted, setEveningSubmitted] = useState(false);
  
  // Use refs to store text values without causing re-render
  const dreamRef = useRef(null);
  const eveningRef = useRef(null);
  const [dreamText, setDreamText] = useState('');
  const [eveningText, setEveningText] = useState('');
  const [showAISuggestions, setShowAISuggestions] = useState(false);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiSuggestions, setAiSuggestions] = useState(null);
  
  // Goals state
  const [userGoals, setUserGoals] = useState([]);
  const [newGoalText, setNewGoalText] = useState('');
  const [aiMicroGoals, setAiMicroGoals] = useState([
    { id: 1, text: 'Take 3 deep breaths before your first meeting', completed: false, icon: 'üßò' },
    { id: 2, text: 'Write down one thing you\'re looking forward to', completed: false, icon: '‚úèÔ∏è' },
    { id: 3, text: 'Step outside for 5 minutes of fresh air', completed: false, icon: 'üåø' },
  ]);
  const [generatingGoals, setGeneratingGoals] = useState(false);

  // Demo day data for cycling
  const demoDays = [
    { mood: 'peaceful', dream: 'I was walking through a quiet forest, the trees were glowing softly.', reflection: 'Today felt balanced. Had a good conversation with mom.' },
    { mood: 'energetic', dream: 'Running through city streets, everything was fast and exciting.', reflection: 'So much energy today! Finished the project ahead of schedule.' },
    { mood: 'reflective', dream: 'Sitting by an ocean, waves bringing old memories.', reflection: 'Thought a lot about where I want to be next year.' },
    { mood: 'creative', dream: 'Building impossible structures that kept changing shape.', reflection: 'Ideas flowing all day. Started three new projects.' },
    { mood: 'grateful', dream: 'A gathering of friends, everyone was laughing.', reflection: 'Feeling so thankful for the people in my life.' },
    { mood: 'calm', dream: 'Floating in warm water under stars.', reflection: 'Quiet day. Sometimes stillness is what we need.' },
  ];

  const currentDemoDay = demoDays[demoDay % demoDays.length];

  // Cycle to next demo day
  const nextDemoDay = () => {
    setDemoDay(d => d + 1);
    setDreamSubmitted(false);
    setEveningSubmitted(false);
    setDreamText('');
    setEveningText('');
    setShowAISuggestions(false);
    setAiSuggestions(null);
    setSelectedGoal(null);
    // Generate new AI micro goals
    generateNewMicroGoals();
  };

  const generateNewMicroGoals = () => {
    const moodBasedGoals = {
      peaceful: [
        { text: 'Find a quiet spot and sit for 5 minutes', icon: 'üßò', source: 'You felt calm yesterday' },
        { text: 'Write down what peace means to you today', icon: '‚úèÔ∏è', source: 'From your reflection' },
        { text: 'Take a slow walk without your phone', icon: 'üö∂', source: 'Based on your dream themes' },
      ],
      energetic: [
        { text: 'Channel your energy into a quick workout', icon: 'üí™', source: 'Matching your vibe' },
        { text: 'Start that project you\'ve been putting off', icon: 'üöÄ', source: 'You mentioned feeling motivated' },
        { text: 'Dance to your favorite song', icon: 'üíÉ', source: 'Based on your mood' },
      ],
      reflective: [
        { text: 'Write a letter to your future self', icon: 'üíå', source: 'You\'ve been introspective' },
        { text: 'Look through old photos for 10 minutes', icon: 'üì∏', source: 'From your dream about memories' },
        { text: 'Journal about a turning point in your life', icon: 'üìñ', source: 'Based on your reflections' },
      ],
      creative: [
        { text: 'Sketch something without lifting your pen', icon: '‚úèÔ∏è', source: 'Your creative energy is high' },
        { text: 'Write 100 words of fiction', icon: 'üìù', source: 'From your lighthouse keeper idea' },
        { text: 'Take a photo from an unusual angle', icon: 'üì∑', source: 'Based on your dreams' },
      ],
      grateful: [
        { text: 'Send a thank you message to someone', icon: 'üí¨', source: 'You mentioned feeling thankful' },
        { text: 'Write 3 things you appreciate about yourself', icon: 'üíù', source: 'From your gratitude patterns' },
        { text: 'Do something kind for a stranger', icon: 'üåü', source: 'Based on your reflections' },
      ],
      calm: [
        { text: 'Make a cup of tea and drink it slowly', icon: 'üçµ', source: 'Matching your peaceful mood' },
        { text: 'Listen to ambient sounds for 5 minutes', icon: 'üéß', source: 'From your dream imagery' },
        { text: 'Declutter one small space', icon: '‚ú®', source: 'Based on your calm state' },
      ],
      inspired: [
        { text: 'Write down 5 ideas, no matter how wild', icon: 'üí°', source: 'Your inspiration is flowing' },
        { text: 'Research something you\'re curious about', icon: 'üîç', source: 'Based on your entries' },
        { text: 'Share an idea with someone', icon: 'üí¨', source: 'From your creative dreams' },
      ],
      cozy: [
        { text: 'Create a cozy corner and read for 20 min', icon: 'üìö', source: 'Matching your mood' },
        { text: 'Cook or bake something comforting', icon: 'üç™', source: 'From your dream about warmth' },
        { text: 'Reach out to someone you miss', icon: 'üíõ', source: 'Based on your reflections' },
      ],
    };
    
    const currentMood = currentDemoDay.mood;
    const goals = moodBasedGoals[currentMood] || moodBasedGoals.peaceful;
    setAiMicroGoals(goals.map((g, i) => ({ ...g, id: Date.now() + i, completed: false })));
  };

  // Simulated AI analysis of past entries
  const generateAISuggestions = () => {
    setAiLoading(true);
    // Simulate API call delay
    setTimeout(() => {
      const suggestions = {
        insight: "I noticed you've been dreaming about open spaces and freedom lately, and your reflections mention feeling most alive during creative moments. There's a pattern of seeking expansion.",
        goals: [
          {
            type: 'creative',
            icon: '‚úèÔ∏è',
            title: 'Write for 10 minutes',
            description: 'You mentioned a lighthouse keeper story idea 3 days ago. Spend 10 minutes expanding it.',
            why: 'Based on your note from Tuesday'
          },
          {
            type: 'mindful',
            icon: 'üßò',
            title: 'Morning walk without phone',
            description: 'Your dreams have featured open landscapes. Try a 15-minute walk, just observing.',
            why: 'Based on recurring dream themes'
          },
          {
            type: 'connection',
            icon: 'üí¨',
            title: 'Reach out to someone',
            description: "You felt energized after talking with Sarah. Send a quick message to someone you've been thinking about.",
            why: 'Based on your reflection from yesterday'
          },
          {
            type: 'explore',
            icon: 'üîç',
            title: 'Try something new',
            description: 'Visit a place in your city you\'ve never been, even just for 20 minutes.',
            why: 'Based on your gratitude patterns'
          },
        ],
        reflection_prompts: [
          "What would your dream-self from last night want you to do today?",
          "You mentioned feeling 'peaceful' often this week. What creates that feeling?",
          "If you could give yourself permission to do one thing today, what would it be?"
        ]
      };
      setAiSuggestions(suggestions);
      setAiLoading(false);
    }, 1500);
  };
  
  // Static demo data - 30 days of entries (defined once, never changes)
  const [entries] = useState([
    { date: new Date(Date.now() - 29 * 86400000), mood: 'peaceful', dream: 'Flying over mountains made of glass', reflection: 'Had a wonderful conversation that made me think differently.', gratitude: 'Good health' },
    { date: new Date(Date.now() - 28 * 86400000), mood: 'energetic', dream: 'Swimming with luminescent fish', reflection: 'Quiet day, but peaceful. Sometimes that\'s exactly what I need.', gratitude: 'Supportive friends' },
    { date: new Date(Date.now() - 27 * 86400000), mood: 'reflective', dream: null, reflection: 'Pushed through something difficult. Proud of myself.', gratitude: 'Creative time' },
    { date: new Date(Date.now() - 26 * 86400000), mood: 'grateful', dream: 'A library where books whispered secrets', reflection: 'Noticed the small things today - sunlight, good coffee.', gratitude: 'Nature' },
    { date: new Date(Date.now() - 25 * 86400000), empty: true },
    { date: new Date(Date.now() - 24 * 86400000), mood: 'creative', dream: 'Walking through a forest of giant flowers', reflection: 'Creative energy was flowing. Made progress on my project.', gratitude: 'Music' },
    { date: new Date(Date.now() - 23 * 86400000), mood: 'calm', dream: 'Meeting an old friend in a strange city', reflection: 'Felt connected to the people around me.', gratitude: 'Good health' },
    { date: new Date(Date.now() - 22 * 86400000), mood: 'inspired', dream: 'Building something impossible', reflection: 'Took time to rest without guilt.', gratitude: 'Supportive friends' },
    { date: new Date(Date.now() - 21 * 86400000), mood: 'cozy', dream: 'A warm kitchen filled with familiar smells', reflection: 'Learned something new that excited me.', gratitude: 'Creative time' },
    { date: new Date(Date.now() - 20 * 86400000), mood: 'peaceful', dream: null, reflection: 'Had a wonderful conversation that made me think differently.', gratitude: 'Nature' },
    { date: new Date(Date.now() - 19 * 86400000), empty: true },
    { date: new Date(Date.now() - 18 * 86400000), mood: 'energetic', dream: 'Flying over mountains made of glass', reflection: 'Quiet day, but peaceful.', gratitude: 'Music' },
    { date: new Date(Date.now() - 17 * 86400000), mood: 'reflective', dream: 'Swimming with luminescent fish', reflection: 'Pushed through something difficult.', gratitude: 'Good health' },
    { date: new Date(Date.now() - 16 * 86400000), mood: 'grateful', dream: 'A library where books whispered secrets', reflection: 'Noticed the small things today.', gratitude: 'Supportive friends' },
    { date: new Date(Date.now() - 15 * 86400000), mood: 'creative', dream: null, reflection: 'Creative energy was flowing.', gratitude: 'Creative time' },
    { date: new Date(Date.now() - 14 * 86400000), mood: 'calm', dream: 'Walking through a forest of giant flowers', reflection: 'Felt connected to the people around me.', gratitude: 'Nature' },
    { date: new Date(Date.now() - 13 * 86400000), empty: true },
    { date: new Date(Date.now() - 12 * 86400000), mood: 'inspired', dream: 'Meeting an old friend in a strange city', reflection: 'Took time to rest without guilt.', gratitude: 'Music' },
    { date: new Date(Date.now() - 11 * 86400000), mood: 'cozy', dream: 'Building something impossible', reflection: 'Learned something new that excited me.', gratitude: 'Good health' },
    { date: new Date(Date.now() - 10 * 86400000), mood: 'peaceful', dream: 'A warm kitchen filled with familiar smells', reflection: 'Had a wonderful conversation.', gratitude: 'Supportive friends' },
    { date: new Date(Date.now() - 9 * 86400000), mood: 'energetic', dream: null, reflection: 'Quiet day, but peaceful.', gratitude: 'Creative time' },
    { date: new Date(Date.now() - 8 * 86400000), mood: 'reflective', dream: 'Flying over mountains made of glass', reflection: 'Pushed through something difficult.', gratitude: 'Nature' },
    { date: new Date(Date.now() - 7 * 86400000), empty: true },
    { date: new Date(Date.now() - 6 * 86400000), mood: 'grateful', dream: 'Swimming with luminescent fish', reflection: 'Noticed the small things today.', gratitude: 'Music' },
    { date: new Date(Date.now() - 5 * 86400000), mood: 'creative', dream: 'A library where books whispered secrets', reflection: 'Creative energy was flowing.', gratitude: 'Good health' },
    { date: new Date(Date.now() - 4 * 86400000), mood: 'calm', dream: null, reflection: 'Felt connected to the people around me.', gratitude: 'Supportive friends' },
    { date: new Date(Date.now() - 3 * 86400000), mood: 'inspired', dream: 'Walking through a forest of giant flowers', reflection: 'Took time to rest without guilt.', gratitude: 'Creative time' },
    { date: new Date(Date.now() - 2 * 86400000), mood: 'cozy', dream: 'Meeting an old friend in a strange city', reflection: 'Learned something new that excited me.', gratitude: 'Nature' },
    { date: new Date(Date.now() - 1 * 86400000), mood: 'peaceful', dream: 'Building something impossible', reflection: 'Had a wonderful conversation.', gratitude: 'Music' },
    { date: new Date(), mood: 'grateful', dream: 'A warm kitchen filled with familiar smells', reflection: 'Today was a good day.', gratitude: 'Good health' },
  ]);

  // Calculate dominant mood from recent entries for theme
  const recentMood = useMemo(() => {
    const recent = entries.slice(-7).filter(e => !e.empty);
    if (recent.length === 0) return 'peaceful';
    const moodCounts = {};
    recent.forEach(e => {
      moodCounts[e.mood] = (moodCounts[e.mood] || 0) + 1;
    });
    return Object.entries(moodCounts).sort((a, b) => b[1] - a[1])[0][0];
  }, [entries]);

  // Theme colors based on mood - modern dark UI with subtle mood tints
  const themes = {
    peaceful: { bg: '#12161c', accent: '#6aadcf', text: '#d0dce5', subtle: '#1a2230', card: '#1e2736' },
    energetic: { bg: '#1c1412', accent: '#cf8a6a', text: '#e5d8d0', subtle: '#2a1e1a', card: '#362820' },
    reflective: { bg: '#18141c', accent: '#a68acf', text: '#ddd0e5', subtle: '#241a2a', card: '#2e2236' },
    grateful: { bg: '#121c16', accent: '#6acf8a', text: '#d0e5d8', subtle: '#1a2a1e', card: '#203628' },
    creative: { bg: '#1c1a12', accent: '#cfba6a', text: '#e5e0d0', subtle: '#2a281a', card: '#363220' },
    calm: { bg: '#141c18', accent: '#6acfba', text: '#d0e5e0', subtle: '#1a2a26', card: '#203630' },
    inspired: { bg: '#1a1418', accent: '#cf6aa6', text: '#e5d0dd', subtle: '#2a1a24', card: '#36202e' },
    cozy: { bg: '#1a1814', accent: '#cfaa6a', text: '#e5ddd0', subtle: '#2a2620', card: '#363020' },
  };

  const theme = themes[currentDemoDay.mood] || themes.peaceful;
  const streak = entries.filter(e => !e.empty).length;

  const formatDate = (date) => {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) return 'Today';
    if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  };

  const NavBar = () => (
    <nav style={{
      position: 'fixed',
      bottom: 0,
      left: 0,
      right: 0,
      background: `linear-gradient(to top, ${theme.bg} 0%, ${theme.bg}dd 100%)`,
      borderTop: `1px solid ${theme.subtle}`,
      padding: '14px 0 30px 0',
      display: 'flex',
      justifyContent: 'space-around',
      backdropFilter: 'blur(20px)',
      zIndex: 100,
    }}>
      {[
        { id: 'home', icon: '‚óê', label: 'today' },
        { id: 'goals', icon: '‚óé', label: 'goals' },
        { id: 'history', icon: '‚ó´', label: 'history' },
        { id: 'wrapped', icon: '‚ú¶', label: 'wrapped' },
      ].map(item => (
        <button
          key={item.id}
          onClick={() => { setCurrentView(item.id); setSelectedHistoryDay(null); }}
          style={{
            background: currentView === item.id ? theme.card : 'transparent',
            border: 'none',
            cursor: 'pointer',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            gap: '6px',
            opacity: currentView === item.id ? 1 : 0.5,
            transition: 'all 0.3s ease',
            padding: '10px 20px',
            borderRadius: '12px',
          }}
        >
          <span style={{ 
            fontSize: '18px', 
            color: currentView === item.id ? theme.accent : theme.text,
          }}>{item.icon}</span>
          <span style={{
            fontFamily: '"Fira Code", monospace',
            fontSize: '10px',
            color: theme.text,
            letterSpacing: '0.02em',
          }}>{item.label}</span>
        </button>
      ))}
    </nav>
  );

  // Demo controls
  const DemoToggle = () => (
    <div style={{
      position: 'fixed',
      top: '16px',
      left: '50%',
      transform: 'translateX(-50%)',
      background: theme.card,
      border: `1px solid ${theme.subtle}`,
      borderRadius: '12px',
      padding: '6px',
      display: 'flex',
      gap: '6px',
      zIndex: 200,
      fontFamily: '"Fira Code", monospace',
    }}>
      <button
        onClick={nextDemoDay}
        style={{
          background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}aa 100%)`,
          color: theme.bg,
          border: 'none',
          borderRadius: '8px',
          padding: '8px 14px',
          fontSize: '11px',
          fontWeight: 500,
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
        }}
      >
        <span>‚Üª</span> New Day
      </button>
      <div style={{
        display: 'flex',
        gap: '2px',
        background: theme.subtle,
        borderRadius: '8px',
        padding: '2px',
      }}>
        {['morning', 'afternoon', 'evening'].map(time => (
          <button
            key={time}
            onClick={() => setDemoTime(time)}
            style={{
              background: demoTime === time ? theme.card : 'transparent',
              color: demoTime === time ? theme.accent : theme.text,
              border: 'none',
              borderRadius: '6px',
              padding: '6px 10px',
              fontSize: '11px',
              cursor: 'pointer',
              opacity: demoTime === time ? 1 : 0.5,
              transition: 'all 0.2s ease',
            }}
          >
            {time === 'morning' ? '‚òÄÔ∏è' : time === 'afternoon' ? 'üå§' : 'üåô'}
          </button>
        ))}
      </div>
    </div>
  );

  const Chip = ({ text, onClick }) => (
    <button
      onClick={onClick}
      style={{
        background: theme.card,
        border: `1px solid ${theme.subtle}`,
        borderRadius: '8px',
        padding: '10px 14px',
        fontFamily: '"Fira Code", monospace',
        fontSize: '12px',
        color: theme.text,
        opacity: 0.8,
        cursor: 'pointer',
        whiteSpace: 'nowrap',
        transition: 'all 0.2s ease',
      }}
      onMouseEnter={(e) => {
        e.target.style.opacity = '1';
        e.target.style.borderColor = theme.accent;
      }}
      onMouseLeave={(e) => {
        e.target.style.opacity = '0.8';
        e.target.style.borderColor = theme.subtle;
      }}
    >
      {text}
    </button>
  );

  const SuggestionCard = ({ icon, source, suggestion, micro, index }) => (
    <div
      onClick={() => setSelectedGoal(index)}
      style={{
        background: selectedGoal === index ? theme.card : theme.subtle,
        border: `1px solid ${selectedGoal === index ? theme.accent : theme.card}`,
        borderRadius: '14px',
        padding: '18px',
        cursor: 'pointer',
        transition: 'all 0.2s ease',
        fontFamily: '"Fira Code", monospace',
      }}
    >
      <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px' }}>
        <span style={{ fontSize: '16px' }}>{icon}</span>
        <span style={{ fontSize: '11px', color: theme.text, opacity: 0.5, textTransform: 'uppercase', letterSpacing: '0.08em' }}>
          {source}
        </span>
        {selectedGoal === index && (
          <span style={{
            marginLeft: 'auto',
            background: theme.accent,
            color: theme.bg,
            fontSize: '10px',
            padding: '4px 10px',
            borderRadius: '6px',
            fontWeight: 500,
          }}>selected</span>
        )}
      </div>
      <p style={{ fontSize: '13px', color: theme.text, margin: '0 0 14px 0', lineHeight: 1.6, opacity: 0.85 }}>
        {suggestion}
      </p>
      <div style={{
        display: 'inline-flex',
        alignItems: 'center',
        gap: '8px',
        background: `${theme.accent}20`,
        padding: '8px 12px',
        borderRadius: '8px',
      }}>
        <span style={{ fontSize: '12px', color: theme.accent }}>‚Üí</span>
        <span style={{ fontSize: '12px', color: theme.accent }}>{micro}</span>
      </div>
    </div>
  );

  const HomeView = () => {
    const greeting = demoTime === 'morning' 
      ? { symbol: '‚òÄÔ∏è', text: 'Good morning', sub: 'Capture your dreams before they fade' }
      : demoTime === 'afternoon'
      ? { symbol: 'üå§', text: 'Good afternoon', sub: "How's your day going?" }
      : { symbol: 'üåô', text: 'Good evening', sub: 'Time to reflect on your day' };

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
        {/* Header */}
        <div style={{ textAlign: 'center', paddingTop: '60px', fontFamily: '"Fira Code", monospace' }}>
          <span style={{ 
            fontSize: '40px', 
            display: 'block', 
            marginBottom: '16px',
          }}>{greeting.symbol}</span>
          <h1 style={{
            fontSize: '22px',
            fontWeight: 500,
            color: theme.text,
            margin: '0 0 8px 0',
            letterSpacing: '-0.01em',
          }}>{greeting.text}</h1>
          <p style={{
            fontSize: '13px',
            color: theme.text,
            opacity: 0.5,
            margin: '0 0 24px 0',
          }}>{greeting.sub}</p>
          <div style={{
            display: 'inline-flex',
            alignItems: 'center',
            gap: '8px',
            background: theme.card,
            border: `1px solid ${theme.subtle}`,
            borderRadius: '10px',
            padding: '10px 18px',
          }}>
            <span style={{ fontSize: '16px' }}>üî•</span>
            <span style={{ fontSize: '14px', color: theme.accent, fontWeight: 500 }}>
              {streak} day streak
            </span>
          </div>
        </div>

        {/* Morning: Dream Journal */}
        {demoTime === 'morning' && (
          <div style={{
            background: theme.card,
            borderRadius: '16px',
            padding: '24px',
            border: `1px solid ${theme.subtle}`,
          }}>
            {!dreamSubmitted ? (
              <>
                <h2 style={{
                  fontFamily: '"Fira Code", monospace',
                  fontSize: '15px',
                  fontWeight: 500,
                  color: theme.text,
                  margin: '0 0 4px 0',
                }}>What did you dream about?</h2>
                <p style={{
                  fontFamily: '"Fira Code", monospace',
                  fontSize: '12px',
                  color: theme.text,
                  opacity: 0.4,
                  margin: '0 0 16px 0',
                }}>Even fragments help you remember better</p>
                <textarea
                  ref={dreamRef}
                  id="dream-input"
                  placeholder="I dreamed that..."
                  rows={4}
                  style={{
                    width: '100%',
                    padding: '16px',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '12px',
                    fontFamily: '"Fira Code", monospace',
                    fontSize: '14px',
                    lineHeight: 1.7,
                    color: theme.text,
                    background: theme.bg,
                    resize: 'none',
                    outline: 'none',
                    boxSizing: 'border-box',
                  }}
                />
                <div style={{ display: 'flex', gap: '8px', marginTop: '14px', flexWrap: 'wrap' }}>
                  <Chip text="I was flying..." onClick={() => { if(dreamRef.current) dreamRef.current.value = 'I was flying...'; }} />
                  <Chip text="I felt..." onClick={() => { if(dreamRef.current) dreamRef.current.value = 'I felt...'; }} />
                  <Chip text="Can't remember" onClick={() => { if(dreamRef.current) dreamRef.current.value = "Can't remember any dreams today."; }} />
                </div>
                <button
                  onClick={() => { 
                    const val = dreamRef.current?.value || '';
                    if (val.trim()) {
                      setDreamText(val); 
                      setDreamSubmitted(true);
                    }
                  }}
                  style={{
                    marginTop: '20px',
                    width: '100%',
                    padding: '16px',
                    background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`,
                    color: theme.bg,
                    border: 'none',
                    borderRadius: '12px',
                    fontFamily: '"Fira Code", monospace',
                    fontSize: '14px',
                    fontWeight: 500,
                    cursor: 'pointer',
                    transition: 'all 0.2s ease',
                  }}
                >
                  Lock it in ‚Üí
                </button>
              </>
            ) : (
              <div style={{ textAlign: 'center', padding: '20px 0', fontFamily: '"Fira Code", monospace' }}>
                <span style={{ fontSize: '40px', display: 'block', marginBottom: '16px' }}>‚ú®</span>
                <h2 style={{
                  fontSize: '18px',
                  fontWeight: 500,
                  color: theme.text,
                  margin: '0 0 8px 0',
                }}>Dream captured!</h2>
                <p style={{
                  fontSize: '13px',
                  color: theme.text,
                  opacity: 0.5,
                  margin: '0 0 20px 0',
                }}>
                  The more you record, the more you'll remember
                </p>
                <div style={{
                  background: theme.bg,
                  border: `1px solid ${theme.subtle}`,
                  borderRadius: '12px',
                  padding: '16px',
                  textAlign: 'left',
                  color: theme.text,
                  fontSize: '13px',
                  lineHeight: 1.6,
                  opacity: 0.8,
                }}>
                  {dreamText}
                </div>
                <button
                  onClick={() => setDreamSubmitted(false)}
                  style={{
                    marginTop: '16px',
                    background: 'transparent',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '10px',
                    padding: '10px 20px',
                    fontSize: '13px',
                    color: theme.text,
                    opacity: 0.7,
                    cursor: 'pointer',
                    fontFamily: '"Fira Code", monospace',
                  }}
                >
                  Edit
                </button>
              </div>
            )}
          </div>
        )}

        {/* Afternoon: Suggestions */}
        {demoTime === 'afternoon' && (
          <div style={{
            background: theme.card,
            borderRadius: '16px',
            padding: '24px',
            border: `1px solid ${theme.subtle}`,
            fontFamily: '"Fira Code", monospace',
          }}>
            {!showAISuggestions ? (
              <>
                <div style={{ textAlign: 'center', padding: '20px 0' }}>
                  <span style={{ fontSize: '40px', display: 'block', marginBottom: '16px' }}>‚ú®</span>
                  <h2 style={{
                    fontSize: '17px',
                    fontWeight: 500,
                    color: theme.text,
                    margin: '0 0 8px 0',
                  }}>Get personalized ideas</h2>
                  <p style={{ 
                    fontSize: '13px', 
                    color: theme.text, 
                    opacity: 0.5, 
                    margin: '0 0 24px 0',
                    lineHeight: 1.6,
                    maxWidth: '280px',
                    marginLeft: 'auto',
                    marginRight: 'auto',
                  }}>
                    We'll look at your dreams, reflections, and notes to suggest ideas for today
                  </p>
                  <button
                    onClick={() => {
                      setShowAISuggestions(true);
                      generateAISuggestions();
                    }}
                    style={{
                      background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`,
                      color: theme.bg,
                      border: 'none',
                      borderRadius: '12px',
                      padding: '16px 32px',
                      fontSize: '14px',
                      fontWeight: 500,
                      cursor: 'pointer',
                      fontFamily: '"Fira Code", monospace',
                    }}
                  >
                    Show me ‚Üí
                  </button>
                </div>
              </>
            ) : aiLoading ? (
              <div style={{ textAlign: 'center', padding: '40px 0' }}>
                <div style={{
                  width: '40px',
                  height: '40px',
                  border: `3px solid ${theme.subtle}`,
                  borderTopColor: theme.accent,
                  borderRadius: '50%',
                  margin: '0 auto 20px',
                  animation: 'spin 1s linear infinite',
                }}/>
                <p style={{ fontSize: '13px', color: theme.text, opacity: 0.6 }}>
                  Looking through your journal...
                </p>
                <style>{`
                  @keyframes spin {
                    to { transform: rotate(360deg); }
                  }
                `}</style>
              </div>
            ) : aiSuggestions && (
              <>
                {/* Insight */}
                <div style={{
                  background: `${theme.accent}12`,
                  borderRadius: '12px',
                  padding: '18px',
                  marginBottom: '20px',
                  borderLeft: `3px solid ${theme.accent}`,
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>
                    <span style={{ fontSize: '14px' }}>üîÆ</span>
                    <span style={{ fontSize: '11px', color: theme.accent, textTransform: 'uppercase', letterSpacing: '0.08em' }}>
                      Pattern noticed
                    </span>
                  </div>
                  <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>
                    {aiSuggestions.insight}
                  </p>
                </div>

                {/* Goal suggestions */}
                <h3 style={{ fontSize: '13px', color: theme.text, margin: '0 0 14px 0', opacity: 0.6 }}>
                  Ideas for today
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', marginBottom: '24px' }}>
                  {aiSuggestions.goals.map((goal, i) => (
                    <div
                      key={i}
                      onClick={() => setSelectedGoal(selectedGoal === i ? null : i)}
                      style={{
                        background: selectedGoal === i ? `${theme.accent}15` : theme.subtle,
                        border: `1px solid ${selectedGoal === i ? theme.accent : theme.card}`,
                        borderRadius: '12px',
                        padding: '16px',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                      }}
                    >
                      <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                        <span style={{ fontSize: '20px' }}>{goal.icon}</span>
                        <div style={{ flex: 1 }}>
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '6px' }}>
                            <h4 style={{ fontSize: '14px', color: theme.text, margin: 0, fontWeight: 500 }}>
                              {goal.title}
                            </h4>
                            {selectedGoal === i && (
                              <span style={{
                                background: theme.accent,
                                color: theme.bg,
                                fontSize: '10px',
                                padding: '4px 10px',
                                borderRadius: '6px',
                              }}>Today's goal</span>
                            )}
                          </div>
                          <p style={{ fontSize: '12px', color: theme.text, opacity: 0.7, margin: '0 0 8px 0', lineHeight: 1.5 }}>
                            {goal.description}
                          </p>
                          <p style={{ fontSize: '11px', color: theme.accent, margin: 0, opacity: 0.8 }}>
                            üí° {goal.why}
                          </p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                {/* Reflection prompts */}
                <h3 style={{ fontSize: '13px', color: theme.text, margin: '0 0 14px 0', opacity: 0.6 }}>
                  Questions to ponder
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '20px' }}>
                  {aiSuggestions.reflection_prompts.map((prompt, i) => (
                    <div
                      key={i}
                      style={{
                        background: theme.subtle,
                        borderRadius: '10px',
                        padding: '14px 16px',
                        fontSize: '13px',
                        color: theme.text,
                        opacity: 0.8,
                        lineHeight: 1.5,
                        fontStyle: 'italic',
                      }}
                    >
                      "{prompt}"
                    </div>
                  ))}
                </div>

                {/* Regenerate button */}
                <button
                  onClick={() => generateAISuggestions()}
                  style={{
                    width: '100%',
                    background: 'transparent',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '10px',
                    padding: '14px',
                    fontSize: '13px',
                    color: theme.text,
                    opacity: 0.7,
                    cursor: 'pointer',
                    fontFamily: '"Fira Code", monospace',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                  }}
                >
                  <span>‚Üª</span> Get new ideas
                </button>
              </>
            )}
            
            {/* Quick note - always visible */}
            <div style={{ marginTop: '24px', paddingTop: '24px', borderTop: `1px solid ${theme.subtle}` }}>
              <p style={{ fontSize: '12px', color: theme.text, opacity: 0.5, margin: '0 0 12px 0' }}>
                Capture a quick thought
              </p>
              <div style={{ display: 'flex', gap: '10px' }}>
                <input
                  type="text"
                  value={quickNote}
                  onChange={(e) => setQuickNote(e.target.value)}
                  placeholder="What's on your mind..."
                  style={{
                    flex: 1,
                    padding: '14px 16px',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '10px',
                    fontFamily: '"Fira Code", monospace',
                    fontSize: '13px',
                    color: theme.text,
                    background: theme.bg,
                    outline: 'none',
                  }}
                />
                <button style={{
                  background: theme.accent,
                  color: theme.bg,
                  border: 'none',
                  borderRadius: '10px',
                  padding: '14px 20px',
                  fontSize: '13px',
                  fontWeight: 500,
                  cursor: 'pointer',
                  fontFamily: '"Fira Code", monospace',
                }}>Save</button>
              </div>
            </div>
          </div>
        )}

        {/* Evening: Reflection */}
        {demoTime === 'evening' && (
          <div style={{
            background: theme.card,
            borderRadius: '16px',
            padding: '24px',
            border: `1px solid ${theme.subtle}`,
          }}>
            {!eveningSubmitted ? (
              <>
                <h2 style={{
                  fontFamily: '"Fira Code", monospace',
                  fontSize: '15px',
                  fontWeight: 500,
                  color: theme.text,
                  margin: '0 0 4px 0',
                }}>How was your day?</h2>
                <p style={{
                  fontFamily: '"Fira Code", monospace',
                  fontSize: '12px',
                  color: theme.text,
                  opacity: 0.4,
                  margin: '0 0 16px 0',
                }}>Reflect on what stood out</p>
                <textarea
                  ref={eveningRef}
                  id="evening-input"
                  placeholder="Today I..."
                  rows={5}
                  style={{
                    width: '100%',
                    padding: '16px',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '12px',
                    fontFamily: '"Fira Code", monospace',
                    fontSize: '14px',
                    lineHeight: 1.7,
                    color: theme.text,
                    background: theme.bg,
                    resize: 'none',
                    outline: 'none',
                    boxSizing: 'border-box',
                  }}
                />
                <div style={{ display: 'flex', gap: '8px', marginTop: '14px', flexWrap: 'wrap' }}>
                  <Chip text="I'm grateful for..." onClick={() => { if(eveningRef.current) eveningRef.current.value = "I'm grateful for..."; }} />
                  <Chip text="Today I learned..." onClick={() => { if(eveningRef.current) eveningRef.current.value = 'Today I learned...'; }} />
                  <Chip text="A highlight was..." onClick={() => { if(eveningRef.current) eveningRef.current.value = 'A highlight was...'; }} />
                </div>
                <button
                  onClick={() => { 
                    const val = eveningRef.current?.value || '';
                    if (val.trim()) {
                      setEveningText(val); 
                      setEveningSubmitted(true);
                    }
                  }}
                  style={{
                    marginTop: '20px',
                    width: '100%',
                    padding: '16px',
                    background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`,
                    color: theme.bg,
                    border: 'none',
                    borderRadius: '12px',
                    fontFamily: '"Fira Code", monospace',
                    fontSize: '14px',
                    fontWeight: 500,
                    cursor: 'pointer',
                    transition: 'all 0.2s ease',
                  }}
                >
                  Lock it in ‚Üí
                </button>
              </>
            ) : (
              <div style={{ textAlign: 'center', padding: '20px 0', fontFamily: '"Fira Code", monospace' }}>
                <span style={{ fontSize: '40px', display: 'block', marginBottom: '16px' }}>üåô</span>
                <h2 style={{
                  fontSize: '18px',
                  fontWeight: 500,
                  color: theme.text,
                  margin: '0 0 8px 0',
                }}>Day complete!</h2>
                <p style={{
                  fontSize: '13px',
                  color: theme.text,
                  opacity: 0.5,
                  margin: '0 0 20px 0',
                }}>
                  Another day of growth recorded. Rest well.
                </p>
                <div style={{
                  background: theme.bg,
                  border: `1px solid ${theme.subtle}`,
                  borderRadius: '12px',
                  padding: '16px',
                  textAlign: 'left',
                  color: theme.text,
                  fontSize: '13px',
                  lineHeight: 1.6,
                  opacity: 0.8,
                }}>
                  {eveningText}
                </div>
                <div style={{
                  marginTop: '20px',
                  padding: '14px',
                  background: `${theme.accent}15`,
                  border: `1px solid ${theme.accent}30`,
                  borderRadius: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '10px',
                }}>
                  <span style={{ fontSize: '20px' }}>üî•</span>
                  <span style={{ fontSize: '15px', color: theme.accent, fontWeight: 500 }}>
                    {streak + 1} day streak!
                  </span>
                </div>
                <button
                  onClick={() => setEveningSubmitted(false)}
                  style={{
                    marginTop: '16px',
                    background: 'transparent',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '10px',
                    padding: '10px 20px',
                    fontSize: '13px',
                    color: theme.text,
                    opacity: 0.7,
                    cursor: 'pointer',
                    fontFamily: '"Fira Code", monospace',
                  }}
                >
                  Edit
                </button>
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  const GoalsView = () => {
    const toggleMicroGoal = (id) => {
      setAiMicroGoals(goals => goals.map(g => 
        g.id === id ? { ...g, completed: !g.completed } : g
      ));
    };

    const toggleUserGoal = (id) => {
      setUserGoals(goals => goals.map(g => 
        g.id === id ? { ...g, completed: !g.completed } : g
      ));
    };

    const addUserGoal = () => {
      if (newGoalText.trim()) {
        setUserGoals([...userGoals, { id: Date.now(), text: newGoalText, completed: false }]);
        setNewGoalText('');
      }
    };

    const refreshMicroGoals = () => {
      setGeneratingGoals(true);
      setTimeout(() => {
        generateNewMicroGoals();
        setGeneratingGoals(false);
      }, 800);
    };

    const completedCount = [...aiMicroGoals, ...userGoals].filter(g => g.completed).length;
    const totalCount = aiMicroGoals.length + userGoals.length;

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '20px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{ paddingTop: '60px', textAlign: 'center' }}>
          <h1 style={{
            fontSize: '22px',
            fontWeight: 500,
            color: theme.text,
            margin: '0 0 8px 0',
          }}>Today's Goals</h1>
          <p style={{
            fontSize: '13px',
            color: theme.text,
            opacity: 0.5,
            margin: 0,
          }}>Small steps, big progress</p>
        </div>

        {/* Progress */}
        {totalCount > 0 && (
          <div style={{
            background: theme.card,
            borderRadius: '14px',
            padding: '18px',
            border: `1px solid ${theme.subtle}`,
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <span style={{ fontSize: '13px', color: theme.text, opacity: 0.7 }}>Progress</span>
              <span style={{ fontSize: '14px', color: theme.accent, fontWeight: 500 }}>
                {completedCount}/{totalCount}
              </span>
            </div>
            <div style={{
              background: theme.subtle,
              borderRadius: '100px',
              height: '8px',
              overflow: 'hidden',
            }}>
              <div style={{
                width: `${(completedCount / totalCount) * 100}%`,
                height: '100%',
                background: `linear-gradient(90deg, ${theme.accent} 0%, ${theme.accent}aa 100%)`,
                borderRadius: '100px',
                transition: 'width 0.3s ease',
              }} />
            </div>
          </div>
        )}

        {/* Suggested Goals - based on journal */}
        <div style={{
          background: theme.card,
          borderRadius: '16px',
          padding: '20px',
          border: `1px solid ${theme.subtle}`,
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
            <div>
              <h3 style={{ fontSize: '14px', color: theme.text, margin: '0 0 4px 0', fontWeight: 500 }}>
                ‚ú® Suggested for you
              </h3>
              <p style={{ fontSize: '11px', color: theme.text, opacity: 0.5, margin: 0 }}>
                Based on your recent entries
              </p>
            </div>
            <button
              onClick={refreshMicroGoals}
              disabled={generatingGoals}
              style={{
                background: theme.subtle,
                border: 'none',
                borderRadius: '8px',
                padding: '8px 12px',
                fontSize: '12px',
                color: theme.accent,
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '6px',
                opacity: generatingGoals ? 0.5 : 1,
              }}
            >
              <span style={{ 
                display: 'inline-block',
                animation: generatingGoals ? 'spin 1s linear infinite' : 'none',
              }}>‚Üª</span>
              Refresh
            </button>
          </div>

          <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
            {aiMicroGoals.map((goal) => (
              <div
                key={goal.id}
                onClick={() => toggleMicroGoal(goal.id)}
                style={{
                  background: goal.completed ? `${theme.accent}15` : theme.subtle,
                  border: `1px solid ${goal.completed ? theme.accent + '40' : 'transparent'}`,
                  borderRadius: '12px',
                  padding: '14px 16px',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  transition: 'all 0.2s ease',
                }}
              >
                <div style={{
                  width: '22px',
                  height: '22px',
                  borderRadius: '6px',
                  border: `2px solid ${goal.completed ? theme.accent : theme.text + '40'}`,
                  background: goal.completed ? theme.accent : 'transparent',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  flexShrink: 0,
                  transition: 'all 0.2s ease',
                }}>
                  {goal.completed && (
                    <span style={{ color: theme.bg, fontSize: '12px' }}>‚úì</span>
                  )}
                </div>
                <span style={{ fontSize: '18px' }}>{goal.icon}</span>
                <div style={{ flex: 1 }}>
                  <span style={{
                    fontSize: '13px',
                    color: theme.text,
                    opacity: goal.completed ? 0.6 : 0.9,
                    textDecoration: goal.completed ? 'line-through' : 'none',
                    lineHeight: 1.4,
                    display: 'block',
                  }}>
                    {goal.text}
                  </span>
                  {goal.source && (
                    <span style={{ fontSize: '11px', color: theme.accent, opacity: 0.7 }}>
                      {goal.source}
                    </span>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* User Goals */}
        <div style={{
          background: theme.card,
          borderRadius: '16px',
          padding: '20px',
          border: `1px solid ${theme.subtle}`,
        }}>
          <h3 style={{ fontSize: '14px', color: theme.text, margin: '0 0 16px 0', fontWeight: 500 }}>
            üìã Your Goals
          </h3>

          {/* Add goal input */}
          <div style={{ display: 'flex', gap: '10px', marginBottom: userGoals.length > 0 ? '16px' : '0' }}>
            <input
              type="text"
              value={newGoalText}
              onChange={(e) => setNewGoalText(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && addUserGoal()}
              placeholder="Add a goal for today..."
              style={{
                flex: 1,
                padding: '14px 16px',
                border: `1px solid ${theme.subtle}`,
                borderRadius: '10px',
                fontFamily: '"Fira Code", monospace',
                fontSize: '13px',
                color: theme.text,
                background: theme.bg,
                outline: 'none',
              }}
            />
            <button
              onClick={addUserGoal}
              style={{
                background: theme.accent,
                color: theme.bg,
                border: 'none',
                borderRadius: '10px',
                padding: '14px 18px',
                fontSize: '16px',
                cursor: 'pointer',
              }}
            >
              +
            </button>
          </div>

          {/* User goal list */}
          {userGoals.length > 0 && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {userGoals.map((goal) => (
                <div
                  key={goal.id}
                  onClick={() => toggleUserGoal(goal.id)}
                  style={{
                    background: goal.completed ? `${theme.accent}15` : theme.subtle,
                    border: `1px solid ${goal.completed ? theme.accent + '40' : 'transparent'}`,
                    borderRadius: '12px',
                    padding: '14px 16px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    transition: 'all 0.2s ease',
                  }}
                >
                  <div style={{
                    width: '22px',
                    height: '22px',
                    borderRadius: '6px',
                    border: `2px solid ${goal.completed ? theme.accent : theme.text + '40'}`,
                    background: goal.completed ? theme.accent : 'transparent',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    flexShrink: 0,
                  }}>
                    {goal.completed && (
                      <span style={{ color: theme.bg, fontSize: '12px' }}>‚úì</span>
                    )}
                  </div>
                  <span style={{
                    fontSize: '13px',
                    color: theme.text,
                    opacity: goal.completed ? 0.6 : 0.9,
                    textDecoration: goal.completed ? 'line-through' : 'none',
                  }}>
                    {goal.text}
                  </span>
                </div>
              ))}
            </div>
          )}

          {userGoals.length === 0 && (
            <p style={{ 
              fontSize: '12px', 
              color: theme.text, 
              opacity: 0.4, 
              margin: '12px 0 0 0',
              textAlign: 'center',
            }}>
              No goals yet. What do you want to accomplish today?
            </p>
          )}
        </div>

        {/* Motivational footer when all complete */}
        {totalCount > 0 && completedCount === totalCount && (
          <div style={{
            background: `linear-gradient(135deg, ${theme.accent}20 0%, ${theme.accent}10 100%)`,
            borderRadius: '14px',
            padding: '24px',
            textAlign: 'center',
            border: `1px solid ${theme.accent}30`,
          }}>
            <span style={{ fontSize: '32px', display: 'block', marginBottom: '12px' }}>üéâ</span>
            <p style={{ fontSize: '15px', color: theme.text, margin: 0, fontWeight: 500 }}>
              All goals complete!
            </p>
            <p style={{ fontSize: '12px', color: theme.text, opacity: 0.6, margin: '8px 0 0 0' }}>
              You're crushing it today
            </p>
          </div>
        )}
      </div>
    );
  };

  const HistoryView = () => {
    const weeks = [];
    for (let i = 0; i < entries.length; i += 7) {
      weeks.push(entries.slice(i, i + 7));
    }

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '24px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{ paddingTop: '60px', textAlign: 'center' }}>
          <h1 style={{
            fontSize: '22px',
            fontWeight: 500,
            color: theme.text,
            margin: '0 0 8px 0',
          }}>History</h1>
          <p style={{
            fontSize: '13px',
            color: theme.text,
            opacity: 0.5,
            margin: 0,
          }}>Tap any day to revisit</p>
        </div>

        {/* Calendar grid */}
        <div style={{
          background: theme.card,
          borderRadius: '16px',
          padding: '20px',
          border: `1px solid ${theme.subtle}`,
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '14px' }}>
            {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => (
              <span key={i} style={{
                width: '38px',
                textAlign: 'center',
                fontSize: '11px',
                color: theme.text,
                opacity: 0.4,
              }}>{d}</span>
            ))}
          </div>
          
          {weeks.map((week, wi) => (
            <div key={wi} style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
              {week.map((day, di) => {
                const isToday = day.date.toDateString() === new Date().toDateString();
                const hasEntry = !day.empty;
                const dayTheme = hasEntry ? themes[day.mood] : null;
                
                return (
                  <button
                    key={di}
                    onClick={() => !day.empty && setSelectedHistoryDay(day)}
                    disabled={day.empty}
                    style={{
                      width: '38px',
                      height: '38px',
                      borderRadius: '10px',
                      border: isToday ? `2px solid ${theme.accent}` : `1px solid transparent`,
                      background: hasEntry 
                        ? `${dayTheme.accent}35`
                        : theme.subtle,
                      cursor: hasEntry ? 'pointer' : 'default',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '12px',
                      color: hasEntry ? theme.text : `${theme.text}40`,
                      transition: 'all 0.2s ease',
                      fontFamily: '"Fira Code", monospace',
                    }}
                  >
                    {day.date.getDate()}
                  </button>
                );
              })}
            </div>
          ))}
        </div>

        {/* Selected day detail */}
        {selectedHistoryDay && (
          <div style={{
            background: theme.card,
            borderRadius: '16px',
            padding: '24px',
            border: `1px solid ${theme.accent}50`,
            animation: 'fadeIn 0.3s ease',
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h3 style={{
                fontSize: '16px',
                fontWeight: 500,
                color: theme.text,
                margin: 0,
              }}>{formatDate(selectedHistoryDay.date)}</h3>
              <span style={{
                background: `${themes[selectedHistoryDay.mood].accent}30`,
                color: themes[selectedHistoryDay.mood].accent,
                padding: '6px 12px',
                borderRadius: '8px',
                fontSize: '12px',
              }}>{selectedHistoryDay.mood}</span>
            </div>

            {selectedHistoryDay.dream && (
              <div style={{ marginBottom: '18px' }}>
                <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>
                  Dream
                </p>
                <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>
                  {selectedHistoryDay.dream}
                </p>
              </div>
            )}

            <div style={{ marginBottom: '18px' }}>
              <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>
                Reflection
              </p>
              <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>
                {selectedHistoryDay.reflection}
              </p>
            </div>

            <div style={{
              background: theme.subtle,
              borderRadius: '10px',
              padding: '14px',
            }}>
              <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>
                Grateful for
              </p>
              <p style={{ fontSize: '13px', color: theme.text, margin: 0, opacity: 0.8 }}>
                {selectedHistoryDay.gratitude}
              </p>
            </div>

            <button
              onClick={() => setSelectedHistoryDay(null)}
              style={{
                marginTop: '18px',
                background: 'transparent',
                border: `1px solid ${theme.subtle}`,
                borderRadius: '10px',
                padding: '12px 20px',
                fontSize: '13px',
                color: theme.text,
                opacity: 0.7,
                cursor: 'pointer',
                width: '100%',
                fontFamily: '"Fira Code", monospace',
              }}
            >Close</button>
          </div>
        )}
      </div>
    );
  };

  const WrappedView = () => {
    const recentEntries = entries.filter(e => !e.empty).slice(-7);
    const moodCounts = {};
    recentEntries.forEach(e => {
      moodCounts[e.mood] = (moodCounts[e.mood] || 0) + 1;
    });
    const topMoods = Object.entries(moodCounts).sort((a, b) => b[1] - a[1]).slice(0, 3).map(m => m[0]);
    
    const dreamsRemembered = recentEntries.filter(e => e.dream).length;
    const totalWords = recentEntries.reduce((acc, e) => {
      return acc + (e.dream?.split(' ').length || 0) + (e.reflection?.split(' ').length || 0);
    }, 0);

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '20px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{
          textAlign: 'center',
          paddingTop: '60px',
          paddingBottom: '10px',
        }}>
          <p style={{
            fontSize: '12px',
            color: theme.text,
            opacity: 0.4,
            marginBottom: '8px',
            textTransform: 'uppercase',
            letterSpacing: '0.1em',
          }}>This Week</p>
          <h1 style={{
            fontSize: '28px',
            fontWeight: 500,
            color: theme.text,
            margin: '0 0 4px 0',
          }}>‚ú¶ Your Wrapped</h1>
        </div>

        {/* Big stats */}
        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(2, 1fr)',
          gap: '12px',
        }}>
          {[
            { label: 'Days logged', value: recentEntries.length, icon: 'üìù' },
            { label: 'Dreams', value: dreamsRemembered, icon: 'üí≠' },
            { label: 'Words', value: totalWords, icon: '‚úèÔ∏è' },
            { label: 'Streak', value: streak, icon: 'üî•' },
          ].map((stat, i) => (
            <div key={i} style={{
              background: theme.card,
              borderRadius: '14px',
              padding: '20px',
              textAlign: 'center',
              border: `1px solid ${theme.subtle}`,
            }}>
              <span style={{ fontSize: '24px', display: 'block', marginBottom: '10px' }}>{stat.icon}</span>
              <p style={{
                fontSize: '28px',
                fontWeight: 500,
                color: theme.text,
                margin: '0 0 4px 0',
              }}>{stat.value}</p>
              <p style={{
                fontSize: '11px',
                color: theme.text,
                opacity: 0.5,
                margin: 0,
              }}>{stat.label}</p>
            </div>
          ))}
        </div>

        {/* Mood breakdown */}
        <div style={{
          background: theme.card,
          borderRadius: '14px',
          padding: '20px',
          border: `1px solid ${theme.subtle}`,
        }}>
          <h3 style={{
            fontSize: '14px',
            fontWeight: 500,
            color: theme.text,
            margin: '0 0 16px 0',
          }}>Your vibes this week</h3>
          <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
            {topMoods.map((mood, i) => (
              <span key={i} style={{
                background: `${themes[mood].accent}25`,
                color: themes[mood].accent,
                padding: '10px 18px',
                borderRadius: '10px',
                fontSize: '13px',
                border: `1px solid ${themes[mood].accent}30`,
              }}>{mood}</span>
            ))}
          </div>
        </div>

        {/* Insight */}
        <div style={{
          background: `${theme.accent}12`,
          borderRadius: '14px',
          padding: '22px',
          borderLeft: `3px solid ${theme.accent}`,
        }}>
          <h3 style={{
            fontSize: '14px',
            fontWeight: 500,
            color: theme.accent,
            margin: '0 0 12px 0',
            display: 'flex',
            alignItems: 'center',
            gap: '8px',
          }}>
            <span>‚ú®</span> Weekly Insight
          </h3>
          <p style={{
            fontSize: '14px',
            color: theme.text,
            margin: 0,
            lineHeight: 1.7,
            opacity: 0.85,
          }}>
            You've been feeling most <span style={{ color: theme.accent, fontWeight: 500 }}>{topMoods[0]}</span> this week. 
            Your dreams have featured themes of exploration and freedom. 
            Consider: what new territory are you ready to explore?
          </p>
        </div>

        {/* Streak celebration */}
        <div style={{
          background: `linear-gradient(135deg, ${theme.accent}20 0%, ${theme.accent}10 100%)`,
          borderRadius: '14px',
          padding: '28px',
          textAlign: 'center',
          border: `1px solid ${theme.accent}30`,
        }}>
          <span style={{ fontSize: '40px', display: 'block', marginBottom: '12px' }}>üî•</span>
          <p style={{
            fontSize: '22px',
            fontWeight: 500,
            color: theme.text,
            margin: '0 0 6px 0',
          }}>{streak} day streak!</p>
          <p style={{
            fontSize: '13px',
            color: theme.text,
            opacity: 0.6,
            margin: 0,
          }}>Keep going ‚Äî you're building something meaningful</p>
        </div>
      </div>
    );
  };

  return (
    <div style={{
      minHeight: '100vh',
      background: theme.bg,
      fontFamily: '"SF Mono", "Fira Code", Consolas, monospace',
      transition: 'background 0.5s ease',
    }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap');
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        ::placeholder { color: ${theme.text}40; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: ${theme.bg}; }
        ::-webkit-scrollbar-thumb { background: ${theme.accent}40; border-radius: 3px; }
      `}</style>
      
      <DemoToggle />
      
      <div style={{
        maxWidth: '480px',
        margin: '0 auto',
        padding: '20px 20px 120px 20px',
      }}>
        {currentView === 'home' && <HomeView />}
        {currentView === 'goals' && <GoalsView />}
        {currentView === 'history' && <HistoryView />}
        {currentView === 'wrapped' && <WrappedView />}
      </div>
      
      <NavBar />
    </div>
  );
};

export default DaylightJournal;
