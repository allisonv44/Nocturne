import React, { useState, useMemo, useRef, useEffect } from 'react';

// Firebase imports
import { initializeApp } from "firebase/app";
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  getDocs, 
  collection, 
  query, 
  orderBy, 
  Timestamp,
  deleteDoc 
} from "firebase/firestore";
import { 
  getAuth, 
  onAuthStateChanged, 
  signInWithPopup, 
  GoogleAuthProvider,
  signOut as firebaseSignOut 
} from "firebase/auth";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAIV7X0d8dn4-j5UVDRHUv4GxR00Pr0gUE",
  authDomain: "nocturne-87c33.firebaseapp.com",
  projectId: "nocturne-87c33",
  storageBucket: "nocturne-87c33.firebasestorage.app",
  messagingSenderId: "860334917357",
  appId: "1:860334917357:web:4839d70107a18215abaee4",
  measurementId: "G-33JZ02JMBZ"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const googleProvider = new GoogleAuthProvider();

const DaylightJournal = () => {
  // Auth state
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  
  // App state
  const [currentView, setCurrentView] = useState('home');
  const [selectedHistoryDay, setSelectedHistoryDay] = useState(null);
  const [quickNote, setQuickNote] = useState('');
  const [selectedGoal, setSelectedGoal] = useState(null);
  const [dreamSubmitted, setDreamSubmitted] = useState(false);
  const [eveningSubmitted, setEveningSubmitted] = useState(false);
  const [saving, setSaving] = useState(false);
  
  // Refs for text inputs
  const dreamRef = useRef(null);
  const eveningRef = useRef(null);
  const [dreamText, setDreamText] = useState('');
  const [eveningText, setEveningText] = useState('');
  const [showAISuggestions, setShowAISuggestions] = useState(false);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiSuggestions, setAiSuggestions] = useState(null);
  
  // Data from Firestore
  const [entries, setEntries] = useState([]);
  const [entriesLoading, setEntriesLoading] = useState(false);
  
  // Goals state
  const [userGoals, setUserGoals] = useState([]);
  const [newGoalText, setNewGoalText] = useState('');
  const [aiMicroGoals, setAiMicroGoals] = useState([
    { id: 1, text: 'Take 3 deep breaths before your first meeting', completed: false, icon: 'üßò' },
    { id: 2, text: 'Write down one thing you\'re looking forward to', completed: false, icon: '‚úèÔ∏è' },
    { id: 3, text: 'Step outside for 5 minutes of fresh air', completed: false, icon: 'üåø' },
  ]);
  const [generatingGoals, setGeneratingGoals] = useState(false);

  // Mood selection for entries
  const [selectedMood, setSelectedMood] = useState('peaceful');
  const moodOptions = ['peaceful', 'energetic', 'reflective', 'grateful', 'creative', 'calm', 'inspired', 'cozy'];

  // Get current time of day
  const getTimeOfDay = () => {
    const hour = new Date().getHours();
    if (hour < 12) return 'morning';
    if (hour < 17) return 'afternoon';
    return 'evening';
  };
  
  const [timeOfDay, setTimeOfDay] = useState(getTimeOfDay());

  // ============================================
  // AUTH FUNCTIONS
  // ============================================
  
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      setUser(user);
      if (user) {
        await loadUserData(user.uid);
      } else {
        setEntries([]);
        setUserGoals([]);
      }
      setAuthLoading(false);
    });
    return () => unsubscribe();
  }, []);

  const signIn = async () => {
    try {
      await signInWithPopup(auth, googleProvider);
    } catch (error) {
      console.error('Sign in error:', error);
    }
  };

  const signOut = async () => {
    try {
      await firebaseSignOut(auth);
    } catch (error) {
      console.error('Sign out error:', error);
    }
  };

  // ============================================
  // FIRESTORE FUNCTIONS
  // ============================================

  const loadUserData = async (userId) => {
    setEntriesLoading(true);
    try {
      await Promise.all([
        loadEntries(userId),
        loadGoals(userId),
        loadTodayEntry(userId)
      ]);
    } catch (error) {
      console.error('Error loading user data:', error);
    } finally {
      setEntriesLoading(false);
    }
  };

  const loadEntries = async (userId) => {
    try {
      const q = query(
        collection(db, 'users', userId, 'entries'),
        orderBy('date', 'desc')
      );
      const snapshot = await getDocs(q);
      const data = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        date: doc.data().date?.toDate() || new Date()
      }));
      setEntries(data);
    } catch (error) {
      console.error('Error loading entries:', error);
    }
  };

  const loadTodayEntry = async (userId) => {
    const today = new Date().toISOString().split('T')[0];
    try {
      const docRef = doc(db, 'users', userId, 'entries', today);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        if (data.dream) {
          setDreamText(data.dream);
          setDreamSubmitted(true);
        }
        if (data.reflection) {
          setEveningText(data.reflection);
          setEveningSubmitted(true);
        }
        if (data.mood) {
          setSelectedMood(data.mood);
        }
      }
    } catch (error) {
      console.error('Error loading today entry:', error);
    }
  };

  const loadGoals = async (userId) => {
    try {
      const docRef = doc(db, 'users', userId, 'goals', 'current');
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        if (data.userGoals) setUserGoals(data.userGoals);
        if (data.aiMicroGoals) setAiMicroGoals(data.aiMicroGoals);
      }
    } catch (error) {
      console.error('Error loading goals:', error);
    }
  };

  const saveEntry = async (data) => {
    if (!user) return;
    setSaving(true);
    const today = new Date().toISOString().split('T')[0];
    try {
      await setDoc(doc(db, 'users', user.uid, 'entries', today), {
        ...data,
        date: Timestamp.now(),
        updatedAt: Timestamp.now()
      }, { merge: true });
      await loadEntries(user.uid);
    } catch (error) {
      console.error('Error saving entry:', error);
    } finally {
      setSaving(false);
    }
  };

  const saveGoals = async (userGoalsData, aiGoalsData) => {
    if (!user) return;
    try {
      await setDoc(doc(db, 'users', user.uid, 'goals', 'current'), {
        userGoals: userGoalsData,
        aiMicroGoals: aiGoalsData,
        updatedAt: Timestamp.now()
      });
    } catch (error) {
      console.error('Error saving goals:', error);
    }
  };

  const saveQuickNote = async () => {
    if (!user || !quickNote.trim()) return;
    const today = new Date().toISOString().split('T')[0];
    try {
      const docRef = doc(db, 'users', user.uid, 'entries', today);
      const docSnap = await getDoc(docRef);
      const existingNotes = docSnap.exists() ? (docSnap.data().quickNotes || []) : [];
      
      await setDoc(docRef, {
        quickNotes: [...existingNotes, { text: quickNote, timestamp: Timestamp.now() }],
        updatedAt: Timestamp.now()
      }, { merge: true });
      
      setQuickNote('');
    } catch (error) {
      console.error('Error saving quick note:', error);
    }
  };

  // ============================================
  // HANDLER FUNCTIONS
  // ============================================

  const handleDreamSubmit = async () => {
    const val = dreamRef.current?.value || '';
    if (!val.trim()) return;
    
    setDreamText(val);
    setDreamSubmitted(true);
    await saveEntry({ dream: val });
  };

  const handleEveningSubmit = async () => {
    const val = eveningRef.current?.value || '';
    if (!val.trim()) return;
    
    setEveningText(val);
    setEveningSubmitted(true);
    await saveEntry({ reflection: val, mood: selectedMood });
  };

  const generateNewMicroGoals = () => {
    const moodBasedGoals = {
      peaceful: [
        { text: 'Find a quiet spot and sit for 5 minutes', icon: 'üßò', source: 'Matching your peaceful mood' },
        { text: 'Write down what peace means to you today', icon: '‚úèÔ∏è', source: 'From your reflection' },
        { text: 'Take a slow walk without your phone', icon: 'üö∂', source: 'Based on your dream themes' },
      ],
      energetic: [
        { text: 'Channel your energy into a quick workout', icon: 'üí™', source: 'Matching your vibe' },
        { text: 'Start that project you\'ve been putting off', icon: 'üöÄ', source: 'You mentioned feeling motivated' },
        { text: 'Dance to your favorite song', icon: 'üíÉ', source: 'Based on your mood' },
      ],
      reflective: [
        { text: 'Write a letter to your future self', icon: 'üíå', source: 'You\'ve been introspective' },
        { text: 'Look through old photos for 10 minutes', icon: 'üì∏', source: 'From your dream about memories' },
        { text: 'Journal about a turning point in your life', icon: 'üìñ', source: 'Based on your reflections' },
      ],
      creative: [
        { text: 'Sketch something without lifting your pen', icon: '‚úèÔ∏è', source: 'Your creative energy is high' },
        { text: 'Write 100 words of fiction', icon: 'üìù', source: 'Based on your recent entries' },
        { text: 'Take a photo from an unusual angle', icon: 'üì∑', source: 'Based on your dreams' },
      ],
      grateful: [
        { text: 'Send a thank you message to someone', icon: 'üí¨', source: 'You mentioned feeling thankful' },
        { text: 'Write 3 things you appreciate about yourself', icon: 'üíù', source: 'From your gratitude patterns' },
        { text: 'Do something kind for a stranger', icon: 'üåü', source: 'Based on your reflections' },
      ],
      calm: [
        { text: 'Make a cup of tea and drink it slowly', icon: 'üçµ', source: 'Matching your peaceful mood' },
        { text: 'Listen to ambient sounds for 5 minutes', icon: 'üéß', source: 'From your dream imagery' },
        { text: 'Declutter one small space', icon: '‚ú®', source: 'Based on your calm state' },
      ],
      inspired: [
        { text: 'Write down 5 ideas, no matter how wild', icon: 'üí°', source: 'Your inspiration is flowing' },
        { text: 'Research something you\'re curious about', icon: 'üîç', source: 'Based on your entries' },
        { text: 'Share an idea with someone', icon: 'üí¨', source: 'From your creative dreams' },
      ],
      cozy: [
        { text: 'Create a cozy corner and read for 20 min', icon: 'üìö', source: 'Matching your mood' },
        { text: 'Cook or bake something comforting', icon: 'üç™', source: 'From your dream about warmth' },
        { text: 'Reach out to someone you miss', icon: 'üíõ', source: 'Based on your reflections' },
      ],
    };
    
    const goals = moodBasedGoals[selectedMood] || moodBasedGoals.peaceful;
    const newGoals = goals.map((g, i) => ({ ...g, id: Date.now() + i, completed: false }));
    setAiMicroGoals(newGoals);
    saveGoals(userGoals, newGoals);
  };

  const generateAISuggestions = () => {
    setAiLoading(true);
    setTimeout(() => {
      const suggestions = {
        insight: "I noticed you've been dreaming about open spaces and freedom lately, and your reflections mention feeling most alive during creative moments. There's a pattern of seeking expansion.",
        goals: [
          {
            type: 'creative',
            icon: '‚úèÔ∏è',
            title: 'Write for 10 minutes',
            description: 'Based on your recent entries, creative expression seems to energize you.',
            why: 'Based on your mood patterns'
          },
          {
            type: 'mindful',
            icon: 'üßò',
            title: 'Morning walk without phone',
            description: 'Your dreams have featured open landscapes. Try a 15-minute walk, just observing.',
            why: 'Based on recurring dream themes'
          },
          {
            type: 'connection',
            icon: 'üí¨',
            title: 'Reach out to someone',
            description: "You felt energized after social interactions. Send a quick message to someone you've been thinking about.",
            why: 'Based on your reflection patterns'
          },
          {
            type: 'explore',
            icon: 'üîç',
            title: 'Try something new',
            description: 'Visit a place in your city you\'ve never been, even just for 20 minutes.',
            why: 'Based on your gratitude entries'
          },
        ],
        reflection_prompts: [
          "What would your dream-self from last night want you to do today?",
          `You mentioned feeling '${selectedMood}' often this week. What creates that feeling?`,
          "If you could give yourself permission to do one thing today, what would it be?"
        ]
      };
      setAiSuggestions(suggestions);
      setAiLoading(false);
    }, 1500);
  };

  // ============================================
  // COMPUTED VALUES
  // ============================================

  const recentMood = useMemo(() => {
    const recent = entries.slice(0, 7).filter(e => e.mood);
    if (recent.length === 0) return 'peaceful';
    const moodCounts = {};
    recent.forEach(e => {
      moodCounts[e.mood] = (moodCounts[e.mood] || 0) + 1;
    });
    return Object.entries(moodCounts).sort((a, b) => b[1] - a[1])[0][0];
  }, [entries]);

  // Calculate streak
  const streak = useMemo(() => {
    let count = 0;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (let i = 0; i < entries.length; i++) {
      const entryDate = new Date(entries[i].date);
      entryDate.setHours(0, 0, 0, 0);
      
      const expectedDate = new Date(today);
      expectedDate.setDate(expectedDate.getDate() - i);
      
      if (entryDate.getTime() === expectedDate.getTime()) {
        count++;
      } else {
        break;
      }
    }
    return count;
  }, [entries]);

  // Theme colors based on mood
  const themes = {
    peaceful: { bg: '#12161c', accent: '#6aadcf', text: '#d0dce5', subtle: '#1a2230', card: '#1e2736' },
    energetic: { bg: '#1c1412', accent: '#cf8a6a', text: '#e5d8d0', subtle: '#2a1e1a', card: '#362820' },
    reflective: { bg: '#18141c', accent: '#a68acf', text: '#ddd0e5', subtle: '#241a2a', card: '#2e2236' },
    grateful: { bg: '#121c16', accent: '#6acf8a', text: '#d0e5d8', subtle: '#1a2a1e', card: '#203628' },
    creative: { bg: '#1c1a12', accent: '#cfba6a', text: '#e5e0d0', subtle: '#2a281a', card: '#363220' },
    calm: { bg: '#141c18', accent: '#6acfba', text: '#d0e5e0', subtle: '#1a2a26', card: '#203630' },
    inspired: { bg: '#1a1418', accent: '#cf6aa6', text: '#e5d0dd', subtle: '#2a1a24', card: '#36202e' },
    cozy: { bg: '#1a1814', accent: '#cfaa6a', text: '#e5ddd0', subtle: '#2a2620', card: '#363020' },
  };

  const theme = themes[selectedMood] || themes.peaceful;

  const formatDate = (date) => {
    if (!date) return '';
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) return 'Today';
    if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  };

  // ============================================
  // UI COMPONENTS
  // ============================================

  const NavBar = () => (
    <nav style={{
      position: 'fixed',
      bottom: 0,
      left: 0,
      right: 0,
      background: `linear-gradient(to top, ${theme.bg} 0%, ${theme.bg}dd 100%)`,
      borderTop: `1px solid ${theme.subtle}`,
      padding: '14px 0 30px 0',
      display: 'flex',
      justifyContent: 'space-around',
      backdropFilter: 'blur(20px)',
      zIndex: 100,
    }}>
      {[
        { id: 'home', icon: '‚óê', label: 'today' },
        { id: 'goals', icon: '‚óé', label: 'goals' },
        { id: 'history', icon: '‚ó´', label: 'history' },
        { id: 'wrapped', icon: '‚ú¶', label: 'wrapped' },
      ].map(item => (
        <button
          key={item.id}
          onClick={() => { setCurrentView(item.id); setSelectedHistoryDay(null); }}
          style={{
            background: currentView === item.id ? theme.card : 'transparent',
            border: 'none',
            cursor: 'pointer',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            gap: '6px',
            opacity: currentView === item.id ? 1 : 0.5,
            transition: 'all 0.3s ease',
            padding: '10px 20px',
            borderRadius: '12px',
          }}
        >
          <span style={{ 
            fontSize: '18px', 
            color: currentView === item.id ? theme.accent : theme.text,
          }}>{item.icon}</span>
          <span style={{
            fontFamily: '"Fira Code", monospace',
            fontSize: '10px',
            color: theme.text,
            letterSpacing: '0.02em',
          }}>{item.label}</span>
        </button>
      ))}
    </nav>
  );

  const Header = () => (
    <div style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      background: `linear-gradient(to bottom, ${theme.bg} 0%, ${theme.bg}00 100%)`,
      padding: '16px 20px',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      zIndex: 200,
      fontFamily: '"Fira Code", monospace',
    }}>
      <div style={{ fontSize: '14px', color: theme.text, opacity: 0.8 }}>
        ‚ú¶ nocturne
      </div>
      {user ? (
        <button
          onClick={signOut}
          style={{
            background: theme.card,
            border: `1px solid ${theme.subtle}`,
            borderRadius: '8px',
            padding: '8px 14px',
            fontSize: '11px',
            color: theme.text,
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: '8px',
          }}
        >
          <img 
            src={user.photoURL} 
            alt="" 
            style={{ width: '18px', height: '18px', borderRadius: '50%' }}
          />
          Sign out
        </button>
      ) : (
        <button
          onClick={signIn}
          style={{
            background: theme.accent,
            border: 'none',
            borderRadius: '8px',
            padding: '8px 14px',
            fontSize: '11px',
            color: theme.bg,
            cursor: 'pointer',
            fontWeight: 500,
          }}
        >
          Sign in
        </button>
      )}
    </div>
  );

  const Chip = ({ text, onClick }) => (
    <button
      onClick={onClick}
      style={{
        background: theme.card,
        border: `1px solid ${theme.subtle}`,
        borderRadius: '8px',
        padding: '10px 14px',
        fontFamily: '"Fira Code", monospace',
        fontSize: '12px',
        color: theme.text,
        opacity: 0.8,
        cursor: 'pointer',
        whiteSpace: 'nowrap',
        transition: 'all 0.2s ease',
      }}
    >
      {text}
    </button>
  );

  const MoodSelector = () => (
    <div style={{ marginBottom: '16px' }}>
      <p style={{
        fontFamily: '"Fira Code", monospace',
        fontSize: '12px',
        color: theme.text,
        opacity: 0.5,
        margin: '0 0 10px 0',
      }}>How are you feeling?</p>
      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
        {moodOptions.map(mood => (
          <button
            key={mood}
            onClick={() => setSelectedMood(mood)}
            style={{
              background: selectedMood === mood ? `${themes[mood].accent}30` : theme.subtle,
              border: `1px solid ${selectedMood === mood ? themes[mood].accent : 'transparent'}`,
              borderRadius: '8px',
              padding: '8px 14px',
              fontFamily: '"Fira Code", monospace',
              fontSize: '12px',
              color: selectedMood === mood ? themes[mood].accent : theme.text,
              cursor: 'pointer',
              transition: 'all 0.2s ease',
            }}
          >
            {mood}
          </button>
        ))}
      </div>
    </div>
  );

  // ============================================
  // VIEW COMPONENTS
  // ============================================

  const AuthScreen = () => (
    <div style={{
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      minHeight: '100vh',
      padding: '40px 20px',
      fontFamily: '"Fira Code", monospace',
      textAlign: 'center',
    }}>
      <span style={{ fontSize: '60px', marginBottom: '24px' }}>‚ú¶</span>
      <h1 style={{
        fontSize: '28px',
        fontWeight: 500,
        color: theme.text,
        margin: '0 0 12px 0',
      }}>nocturne</h1>
      <p style={{
        fontSize: '14px',
        color: theme.text,
        opacity: 0.6,
        margin: '0 0 40px 0',
        maxWidth: '280px',
        lineHeight: 1.6,
      }}>
        Capture your dreams, reflect on your days, and discover patterns in your inner world.
      </p>
      <button
        onClick={signIn}
        style={{
          background: theme.accent,
          color: theme.bg,
          border: 'none',
          borderRadius: '12px',
          padding: '16px 32px',
          fontSize: '14px',
          fontWeight: 500,
          cursor: 'pointer',
          fontFamily: '"Fira Code", monospace',
          display: 'flex',
          alignItems: 'center',
          gap: '10px',
        }}
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Continue with Google
      </button>
    </div>
  );

  const LoadingScreen = () => (
    <div style={{
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      minHeight: '100vh',
      fontFamily: '"Fira Code", monospace',
    }}>
      <div style={{
        width: '40px',
        height: '40px',
        border: `3px solid ${theme.subtle}`,
        borderTopColor: theme.accent,
        borderRadius: '50%',
        animation: 'spin 1s linear infinite',
      }}/>
      <p style={{ marginTop: '20px', color: theme.text, opacity: 0.6 }}>Loading...</p>
    </div>
  );

  const HomeView = () => {
    const greeting = timeOfDay === 'morning' 
      ? { symbol: '‚òÄÔ∏è', text: 'Good morning', sub: 'Capture your dreams before they fade' }
      : timeOfDay === 'afternoon'
      ? { symbol: 'üå§', text: 'Good afternoon', sub: "How's your day going?" }
      : { symbol: 'üåô', text: 'Good evening', sub: 'Time to reflect on your day' };

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
        {/* Header */}
        <div style={{ textAlign: 'center', paddingTop: '70px', fontFamily: '"Fira Code", monospace' }}>
          <span style={{ 
            fontSize: '40px', 
            display: 'block', 
            marginBottom: '16px',
          }}>{greeting.symbol}</span>
          <h1 style={{
            fontSize: '22px',
            fontWeight: 500,
            color: theme.text,
            margin: '0 0 8px 0',
            letterSpacing: '-0.01em',
          }}>{greeting.text}{user?.displayName ? `, ${user.displayName.split(' ')[0]}` : ''}</h1>
          <p style={{
            fontSize: '13px',
            color: theme.text,
            opacity: 0.5,
            margin: '0 0 24px 0',
          }}>{greeting.sub}</p>
          <div style={{
            display: 'inline-flex',
            alignItems: 'center',
            gap: '8px',
            background: theme.card,
            border: `1px solid ${theme.subtle}`,
            borderRadius: '10px',
            padding: '10px 18px',
          }}>
            <span style={{ fontSize: '16px' }}>üî•</span>
            <span style={{ fontSize: '14px', color: theme.accent, fontWeight: 500 }}>
              {streak} day streak
            </span>
          </div>
        </div>

        {/* Morning: Dream Journal */}
        {timeOfDay === 'morning' && (
          <div style={{
            background: theme.card,
            borderRadius: '16px',
            padding: '24px',
            border: `1px solid ${theme.subtle}`,
          }}>
            {!dreamSubmitted ? (
              <>
                <h2 style={{
                  fontFamily: '"Fira Code", monospace',
                  fontSize: '15px',
                  fontWeight: 500,
                  color: theme.text,
                  margin: '0 0 4px 0',
                }}>What did you dream about?</h2>
                <p style={{
                  fontFamily: '"Fira Code", monospace',
                  fontSize: '12px',
                  color: theme.text,
                  opacity: 0.4,
                  margin: '0 0 16px 0',
                }}>Even fragments help you remember better</p>
                <textarea
                  ref={dreamRef}
                  placeholder="I dreamed that..."
                  rows={4}
                  style={{
                    width: '100%',
                    padding: '16px',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '12px',
                    fontFamily: '"Fira Code", monospace',
                    fontSize: '14px',
                    lineHeight: 1.7,
                    color: theme.text,
                    background: theme.bg,
                    resize: 'none',
                    outline: 'none',
                    boxSizing: 'border-box',
                  }}
                />
                <div style={{ display: 'flex', gap: '8px', marginTop: '14px', flexWrap: 'wrap' }}>
                  <Chip text="I was flying..." onClick={() => { if(dreamRef.current) dreamRef.current.value = 'I was flying...'; }} />
                  <Chip text="I felt..." onClick={() => { if(dreamRef.current) dreamRef.current.value = 'I felt...'; }} />
                  <Chip text="Can't remember" onClick={() => { if(dreamRef.current) dreamRef.current.value = "Can't remember any dreams today."; }} />
                </div>
                <button
                  onClick={handleDreamSubmit}
                  disabled={saving}
                  style={{
                    marginTop: '20px',
                    width: '100%',
                    padding: '16px',
                    background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`,
                    color: theme.bg,
                    border: 'none',
                    borderRadius: '12px',
                    fontFamily: '"Fira Code", monospace',
                    fontSize: '14px',
                    fontWeight: 500,
                    cursor: saving ? 'wait' : 'pointer',
                    opacity: saving ? 0.7 : 1,
                    transition: 'all 0.2s ease',
                  }}
                >
                  {saving ? 'Saving...' : 'Lock it in ‚Üí'}
                </button>
              </>
            ) : (
              <div style={{ textAlign: 'center', padding: '20px 0', fontFamily: '"Fira Code", monospace' }}>
                <span style={{ fontSize: '40px', display: 'block', marginBottom: '16px' }}>‚ú®</span>
                <h2 style={{
                  fontSize: '18px',
                  fontWeight: 500,
                  color: theme.text,
                  margin: '0 0 8px 0',
                }}>Dream captured!</h2>
                <p style={{
                  fontSize: '13px',
                  color: theme.text,
                  opacity: 0.5,
                  margin: '0 0 20px 0',
                }}>
                  The more you record, the more you'll remember
                </p>
                <div style={{
                  background: theme.bg,
                  border: `1px solid ${theme.subtle}`,
                  borderRadius: '12px',
                  padding: '16px',
                  textAlign: 'left',
                  color: theme.text,
                  fontSize: '13px',
                  lineHeight: 1.6,
                  opacity: 0.8,
                }}>
                  {dreamText}
                </div>
                <button
                  onClick={() => setDreamSubmitted(false)}
                  style={{
                    marginTop: '16px',
                    background: 'transparent',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '10px',
                    padding: '10px 20px',
                    fontSize: '13px',
                    color: theme.text,
                    opacity: 0.7,
                    cursor: 'pointer',
                    fontFamily: '"Fira Code", monospace',
                  }}
                >
                  Edit
                </button>
              </div>
            )}
          </div>
        )}

        {/* Afternoon: Suggestions */}
        {timeOfDay === 'afternoon' && (
          <div style={{
            background: theme.card,
            borderRadius: '16px',
            padding: '24px',
            border: `1px solid ${theme.subtle}`,
            fontFamily: '"Fira Code", monospace',
          }}>
            {!showAISuggestions ? (
              <div style={{ textAlign: 'center', padding: '20px 0' }}>
                <span style={{ fontSize: '40px', display: 'block', marginBottom: '16px' }}>‚ú®</span>
                <h2 style={{
                  fontSize: '17px',
                  fontWeight: 500,
                  color: theme.text,
                  margin: '0 0 8px 0',
                }}>Get personalized ideas</h2>
                <p style={{ 
                  fontSize: '13px', 
                  color: theme.text, 
                  opacity: 0.5, 
                  margin: '0 0 24px 0',
                  lineHeight: 1.6,
                  maxWidth: '280px',
                  marginLeft: 'auto',
                  marginRight: 'auto',
                }}>
                  We'll look at your dreams, reflections, and notes to suggest ideas for today
                </p>
                <button
                  onClick={() => {
                    setShowAISuggestions(true);
                    generateAISuggestions();
                  }}
                  style={{
                    background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`,
                    color: theme.bg,
                    border: 'none',
                    borderRadius: '12px',
                    padding: '16px 32px',
                    fontSize: '14px',
                    fontWeight: 500,
                    cursor: 'pointer',
                    fontFamily: '"Fira Code", monospace',
                  }}
                >
                  Show me ‚Üí
                </button>
              </div>
            ) : aiLoading ? (
              <div style={{ textAlign: 'center', padding: '40px 0' }}>
                <div style={{
                  width: '40px',
                  height: '40px',
                  border: `3px solid ${theme.subtle}`,
                  borderTopColor: theme.accent,
                  borderRadius: '50%',
                  margin: '0 auto 20px',
                  animation: 'spin 1s linear infinite',
                }}/>
                <p style={{ fontSize: '13px', color: theme.text, opacity: 0.6 }}>
                  Looking through your journal...
                </p>
              </div>
            ) : aiSuggestions && (
              <>
                <div style={{
                  background: `${theme.accent}12`,
                  borderRadius: '12px',
                  padding: '18px',
                  marginBottom: '20px',
                  borderLeft: `3px solid ${theme.accent}`,
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>
                    <span style={{ fontSize: '14px' }}>üîÆ</span>
                    <span style={{ fontSize: '11px', color: theme.accent, textTransform: 'uppercase', letterSpacing: '0.08em' }}>
                      Pattern noticed
                    </span>
                  </div>
                  <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>
                    {aiSuggestions.insight}
                  </p>
                </div>

                <h3 style={{ fontSize: '13px', color: theme.text, margin: '0 0 14px 0', opacity: 0.6 }}>
                  Ideas for today
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', marginBottom: '24px' }}>
                  {aiSuggestions.goals.map((goal, i) => (
                    <div
                      key={i}
                      onClick={() => setSelectedGoal(selectedGoal === i ? null : i)}
                      style={{
                        background: selectedGoal === i ? `${theme.accent}15` : theme.subtle,
                        border: `1px solid ${selectedGoal === i ? theme.accent : theme.card}`,
                        borderRadius: '12px',
                        padding: '16px',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                      }}
                    >
                      <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                        <span style={{ fontSize: '20px' }}>{goal.icon}</span>
                        <div style={{ flex: 1 }}>
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '6px' }}>
                            <h4 style={{ fontSize: '14px', color: theme.text, margin: 0, fontWeight: 500 }}>
                              {goal.title}
                            </h4>
                            {selectedGoal === i && (
                              <span style={{
                                background: theme.accent,
                                color: theme.bg,
                                fontSize: '10px',
                                padding: '4px 10px',
                                borderRadius: '6px',
                              }}>Today's goal</span>
                            )}
                          </div>
                          <p style={{ fontSize: '12px', color: theme.text, opacity: 0.7, margin: '0 0 8px 0', lineHeight: 1.5 }}>
                            {goal.description}
                          </p>
                          <p style={{ fontSize: '11px', color: theme.accent, margin: 0, opacity: 0.8 }}>
                            üí° {goal.why}
                          </p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                <h3 style={{ fontSize: '13px', color: theme.text, margin: '0 0 14px 0', opacity: 0.6 }}>
                  Questions to ponder
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '20px' }}>
                  {aiSuggestions.reflection_prompts.map((prompt, i) => (
                    <div
                      key={i}
                      style={{
                        background: theme.subtle,
                        borderRadius: '10px',
                        padding: '14px 16px',
                        fontSize: '13px',
                        color: theme.text,
                        opacity: 0.8,
                        lineHeight: 1.5,
                        fontStyle: 'italic',
                      }}
                    >
                      "{prompt}"
                    </div>
                  ))}
                </div>

                <button
                  onClick={() => generateAISuggestions()}
                  style={{
                    width: '100%',
                    background: 'transparent',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '10px',
                    padding: '14px',
                    fontSize: '13px',
                    color: theme.text,
                    opacity: 0.7,
                    cursor: 'pointer',
                    fontFamily: '"Fira Code", monospace',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                  }}
                >
                  <span>‚Üª</span> Get new ideas
                </button>
              </>
            )}
            
            {/* Quick note */}
            <div style={{ marginTop: '24px', paddingTop: '24px', borderTop: `1px solid ${theme.subtle}` }}>
              <p style={{ fontSize: '12px', color: theme.text, opacity: 0.5, margin: '0 0 12px 0' }}>
                Capture a quick thought
              </p>
              <div style={{ display: 'flex', gap: '10px' }}>
                <input
                  type="text"
                  value={quickNote}
                  onChange={(e) => setQuickNote(e.target.value)}
                  placeholder="What's on your mind..."
                  style={{
                    flex: 1,
                    padding: '14px 16px',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '10px',
                    fontFamily: '"Fira Code", monospace',
                    fontSize: '13px',
                    color: theme.text,
                    background: theme.bg,
                    outline: 'none',
                  }}
                />
                <button 
                  onClick={saveQuickNote}
                  style={{
                    background: theme.accent,
                    color: theme.bg,
                    border: 'none',
                    borderRadius: '10px',
                    padding: '14px 20px',
                    fontSize: '13px',
                    fontWeight: 500,
                    cursor: 'pointer',
                    fontFamily: '"Fira Code", monospace',
                  }}
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Evening: Reflection */}
        {timeOfDay === 'evening' && (
          <div style={{
            background: theme.card,
            borderRadius: '16px',
            padding: '24px',
            border: `1px solid ${theme.subtle}`,
          }}>
            {!eveningSubmitted ? (
              <>
                <h2 style={{
                  fontFamily: '"Fira Code", monospace',
                  fontSize: '15px',
                  fontWeight: 500,
                  color: theme.text,
                  margin: '0 0 4px 0',
                }}>How was your day?</h2>
                <p style={{
                  fontFamily: '"Fira Code", monospace',
                  fontSize: '12px',
                  color: theme.text,
                  opacity: 0.4,
                  margin: '0 0 16px 0',
                }}>Reflect on what stood out</p>
                
                <MoodSelector />
                
                <textarea
                  ref={eveningRef}
                  placeholder="Today I..."
                  rows={5}
                  style={{
                    width: '100%',
                    padding: '16px',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '12px',
                    fontFamily: '"Fira Code", monospace',
                    fontSize: '14px',
                    lineHeight: 1.7,
                    color: theme.text,
                    background: theme.bg,
                    resize: 'none',
                    outline: 'none',
                    boxSizing: 'border-box',
                  }}
                />
                <div style={{ display: 'flex', gap: '8px', marginTop: '14px', flexWrap: 'wrap' }}>
                  <Chip text="I'm grateful for..." onClick={() => { if(eveningRef.current) eveningRef.current.value = "I'm grateful for..."; }} />
                  <Chip text="Today I learned..." onClick={() => { if(eveningRef.current) eveningRef.current.value = 'Today I learned...'; }} />
                  <Chip text="A highlight was..." onClick={() => { if(eveningRef.current) eveningRef.current.value = 'A highlight was...'; }} />
                </div>
                <button
                  onClick={handleEveningSubmit}
                  disabled={saving}
                  style={{
                    marginTop: '20px',
                    width: '100%',
                    padding: '16px',
                    background: `linear-gradient(135deg, ${theme.accent} 0%, ${theme.accent}cc 100%)`,
                    color: theme.bg,
                    border: 'none',
                    borderRadius: '12px',
                    fontFamily: '"Fira Code", monospace',
                    fontSize: '14px',
                    fontWeight: 500,
                    cursor: saving ? 'wait' : 'pointer',
                    opacity: saving ? 0.7 : 1,
                    transition: 'all 0.2s ease',
                  }}
                >
                  {saving ? 'Saving...' : 'Lock it in ‚Üí'}
                </button>
              </>
            ) : (
              <div style={{ textAlign: 'center', padding: '20px 0', fontFamily: '"Fira Code", monospace' }}>
                <span style={{ fontSize: '40px', display: 'block', marginBottom: '16px' }}>üåô</span>
                <h2 style={{
                  fontSize: '18px',
                  fontWeight: 500,
                  color: theme.text,
                  margin: '0 0 8px 0',
                }}>Day complete!</h2>
                <p style={{
                  fontSize: '13px',
                  color: theme.text,
                  opacity: 0.5,
                  margin: '0 0 20px 0',
                }}>
                  Another day of growth recorded. Rest well.
                </p>
                <div style={{
                  background: theme.bg,
                  border: `1px solid ${theme.subtle}`,
                  borderRadius: '12px',
                  padding: '16px',
                  textAlign: 'left',
                  color: theme.text,
                  fontSize: '13px',
                  lineHeight: 1.6,
                  opacity: 0.8,
                }}>
                  {eveningText}
                </div>
                <div style={{
                  marginTop: '20px',
                  padding: '14px',
                  background: `${theme.accent}15`,
                  border: `1px solid ${theme.accent}30`,
                  borderRadius: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '10px',
                }}>
                  <span style={{ fontSize: '20px' }}>üî•</span>
                  <span style={{ fontSize: '15px', color: theme.accent, fontWeight: 500 }}>
                    {streak} day streak!
                  </span>
                </div>
                <button
                  onClick={() => setEveningSubmitted(false)}
                  style={{
                    marginTop: '16px',
                    background: 'transparent',
                    border: `1px solid ${theme.subtle}`,
                    borderRadius: '10px',
                    padding: '10px 20px',
                    fontSize: '13px',
                    color: theme.text,
                    opacity: 0.7,
                    cursor: 'pointer',
                    fontFamily: '"Fira Code", monospace',
                  }}
                >
                  Edit
                </button>
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  const GoalsView = () => {
    const toggleMicroGoal = async (id) => {
      const newGoals = aiMicroGoals.map(g => 
        g.id === id ? { ...g, completed: !g.completed } : g
      );
      setAiMicroGoals(newGoals);
      await saveGoals(userGoals, newGoals);
    };

    const toggleUserGoal = async (id) => {
      const newGoals = userGoals.map(g => 
        g.id === id ? { ...g, completed: !g.completed } : g
      );
      setUserGoals(newGoals);
      await saveGoals(newGoals, aiMicroGoals);
    };

    const addUserGoal = async () => {
      if (newGoalText.trim()) {
        const newGoals = [...userGoals, { id: Date.now(), text: newGoalText, completed: false }];
        setUserGoals(newGoals);
        setNewGoalText('');
        await saveGoals(newGoals, aiMicroGoals);
      }
    };

    const refreshMicroGoals = () => {
      setGeneratingGoals(true);
      setTimeout(() => {
        generateNewMicroGoals();
        setGeneratingGoals(false);
      }, 800);
    };

    const completedCount = [...aiMicroGoals, ...userGoals].filter(g => g.completed).length;
    const totalCount = aiMicroGoals.length + userGoals.length;

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '20px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{ paddingTop: '70px', textAlign: 'center' }}>
          <h1 style={{
            fontSize: '22px',
            fontWeight: 500,
            color: theme.text,
            margin: '0 0 8px 0',
          }}>Today's Goals</h1>
          <p style={{
            fontSize: '13px',
            color: theme.text,
            opacity: 0.5,
            margin: 0,
          }}>Small steps, big progress</p>
        </div>

        {totalCount > 0 && (
          <div style={{
            background: theme.card,
            borderRadius: '14px',
            padding: '18px',
            border: `1px solid ${theme.subtle}`,
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <span style={{ fontSize: '13px', color: theme.text, opacity: 0.7 }}>Progress</span>
              <span style={{ fontSize: '14px', color: theme.accent, fontWeight: 500 }}>
                {completedCount}/{totalCount}
              </span>
            </div>
            <div style={{
              background: theme.subtle,
              borderRadius: '100px',
              height: '8px',
              overflow: 'hidden',
            }}>
              <div style={{
                width: `${(completedCount / totalCount) * 100}%`,
                height: '100%',
                background: `linear-gradient(90deg, ${theme.accent} 0%, ${theme.accent}aa 100%)`,
                borderRadius: '100px',
                transition: 'width 0.3s ease',
              }} />
            </div>
          </div>
        )}

        <div style={{
          background: theme.card,
          borderRadius: '16px',
          padding: '20px',
          border: `1px solid ${theme.subtle}`,
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
            <div>
              <h3 style={{ fontSize: '14px', color: theme.text, margin: '0 0 4px 0', fontWeight: 500 }}>
                ‚ú® Suggested for you
              </h3>
              <p style={{ fontSize: '11px', color: theme.text, opacity: 0.5, margin: 0 }}>
                Based on your recent entries
              </p>
            </div>
            <button
              onClick={refreshMicroGoals}
              disabled={generatingGoals}
              style={{
                background: theme.subtle,
                border: 'none',
                borderRadius: '8px',
                padding: '8px 12px',
                fontSize: '12px',
                color: theme.accent,
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '6px',
                opacity: generatingGoals ? 0.5 : 1,
              }}
            >
              <span style={{ 
                display: 'inline-block',
                animation: generatingGoals ? 'spin 1s linear infinite' : 'none',
              }}>‚Üª</span>
              Refresh
            </button>
          </div>

          <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
            {aiMicroGoals.map((goal) => (
              <div
                key={goal.id}
                onClick={() => toggleMicroGoal(goal.id)}
                style={{
                  background: goal.completed ? `${theme.accent}15` : theme.subtle,
                  border: `1px solid ${goal.completed ? theme.accent + '40' : 'transparent'}`,
                  borderRadius: '12px',
                  padding: '14px 16px',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  transition: 'all 0.2s ease',
                }}
              >
                <div style={{
                  width: '22px',
                  height: '22px',
                  borderRadius: '6px',
                  border: `2px solid ${goal.completed ? theme.accent : theme.text + '40'}`,
                  background: goal.completed ? theme.accent : 'transparent',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  flexShrink: 0,
                  transition: 'all 0.2s ease',
                }}>
                  {goal.completed && (
                    <span style={{ color: theme.bg, fontSize: '12px' }}>‚úì</span>
                  )}
                </div>
                <span style={{ fontSize: '18px' }}>{goal.icon}</span>
                <div style={{ flex: 1 }}>
                  <span style={{
                    fontSize: '13px',
                    color: theme.text,
                    opacity: goal.completed ? 0.6 : 0.9,
                    textDecoration: goal.completed ? 'line-through' : 'none',
                    lineHeight: 1.4,
                    display: 'block',
                  }}>
                    {goal.text}
                  </span>
                  {goal.source && (
                    <span style={{ fontSize: '11px', color: theme.accent, opacity: 0.7 }}>
                      {goal.source}
                    </span>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>

        <div style={{
          background: theme.card,
          borderRadius: '16px',
          padding: '20px',
          border: `1px solid ${theme.subtle}`,
        }}>
          <h3 style={{ fontSize: '14px', color: theme.text, margin: '0 0 16px 0', fontWeight: 500 }}>
            üìã Your Goals
          </h3>

          <div style={{ display: 'flex', gap: '10px', marginBottom: userGoals.length > 0 ? '16px' : '0' }}>
            <input
              type="text"
              value={newGoalText}
              onChange={(e) => setNewGoalText(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && addUserGoal()}
              placeholder="Add a goal for today..."
              style={{
                flex: 1,
                padding: '14px 16px',
                border: `1px solid ${theme.subtle}`,
                borderRadius: '10px',
                fontFamily: '"Fira Code", monospace',
                fontSize: '13px',
                color: theme.text,
                background: theme.bg,
                outline: 'none',
              }}
            />
            <button
              onClick={addUserGoal}
              style={{
                background: theme.accent,
                color: theme.bg,
                border: 'none',
                borderRadius: '10px',
                padding: '14px 18px',
                fontSize: '16px',
                cursor: 'pointer',
              }}
            >
              +
            </button>
          </div>

          {userGoals.length > 0 && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {userGoals.map((goal) => (
                <div
                  key={goal.id}
                  onClick={() => toggleUserGoal(goal.id)}
                  style={{
                    background: goal.completed ? `${theme.accent}15` : theme.subtle,
                    border: `1px solid ${goal.completed ? theme.accent + '40' : 'transparent'}`,
                    borderRadius: '12px',
                    padding: '14px 16px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    transition: 'all 0.2s ease',
                  }}
                >
                  <div style={{
                    width: '22px',
                    height: '22px',
                    borderRadius: '6px',
                    border: `2px solid ${goal.completed ? theme.accent : theme.text + '40'}`,
                    background: goal.completed ? theme.accent : 'transparent',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    flexShrink: 0,
                  }}>
                    {goal.completed && (
                      <span style={{ color: theme.bg, fontSize: '12px' }}>‚úì</span>
                    )}
                  </div>
                  <span style={{
                    fontSize: '13px',
                    color: theme.text,
                    opacity: goal.completed ? 0.6 : 0.9,
                    textDecoration: goal.completed ? 'line-through' : 'none',
                  }}>
                    {goal.text}
                  </span>
                </div>
              ))}
            </div>
          )}

          {userGoals.length === 0 && (
            <p style={{ 
              fontSize: '12px', 
              color: theme.text, 
              opacity: 0.4, 
              margin: '12px 0 0 0',
              textAlign: 'center',
            }}>
              No goals yet. What do you want to accomplish today?
            </p>
          )}
        </div>

        {totalCount > 0 && completedCount === totalCount && (
          <div style={{
            background: `linear-gradient(135deg, ${theme.accent}20 0%, ${theme.accent}10 100%)`,
            borderRadius: '14px',
            padding: '24px',
            textAlign: 'center',
            border: `1px solid ${theme.accent}30`,
          }}>
            <span style={{ fontSize: '32px', display: 'block', marginBottom: '12px' }}>üéâ</span>
            <p style={{ fontSize: '15px', color: theme.text, margin: 0, fontWeight: 500 }}>
              All goals complete!
            </p>
            <p style={{ fontSize: '12px', color: theme.text, opacity: 0.6, margin: '8px 0 0 0' }}>
              You're crushing it today
            </p>
          </div>
        )}
      </div>
    );
  };

  const HistoryView = () => {
    // Generate calendar data from entries
    const calendarDays = useMemo(() => {
      const days = [];
      const today = new Date();
      
      for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        date.setHours(0, 0, 0, 0);
        
        const entry = entries.find(e => {
          const entryDate = new Date(e.date);
          entryDate.setHours(0, 0, 0, 0);
          return entryDate.getTime() === date.getTime();
        });
        
        days.push({
          date,
          ...entry,
          empty: !entry
        });
      }
      return days;
    }, [entries]);

    const weeks = [];
    for (let i = 0; i < calendarDays.length; i += 7) {
      weeks.push(calendarDays.slice(i, i + 7));
    }

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '24px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{ paddingTop: '70px', textAlign: 'center' }}>
          <h1 style={{
            fontSize: '22px',
            fontWeight: 500,
            color: theme.text,
            margin: '0 0 8px 0',
          }}>History</h1>
          <p style={{
            fontSize: '13px',
            color: theme.text,
            opacity: 0.5,
            margin: 0,
          }}>Tap any day to revisit</p>
        </div>

        <div style={{
          background: theme.card,
          borderRadius: '16px',
          padding: '20px',
          border: `1px solid ${theme.subtle}`,
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '14px' }}>
            {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => (
              <span key={i} style={{
                width: '38px',
                textAlign: 'center',
                fontSize: '11px',
                color: theme.text,
                opacity: 0.4,
              }}>{d}</span>
            ))}
          </div>
          
          {weeks.map((week, wi) => (
            <div key={wi} style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
              {week.map((day, di) => {
                const isToday = day.date.toDateString() === new Date().toDateString();
                const hasEntry = !day.empty;
                const dayTheme = hasEntry && day.mood ? themes[day.mood] : null;
                
                return (
                  <button
                    key={di}
                    onClick={() => hasEntry && setSelectedHistoryDay(day)}
                    disabled={day.empty}
                    style={{
                      width: '38px',
                      height: '38px',
                      borderRadius: '10px',
                      border: isToday ? `2px solid ${theme.accent}` : `1px solid transparent`,
                      background: hasEntry && dayTheme
                        ? `${dayTheme.accent}35`
                        : theme.subtle,
                      cursor: hasEntry ? 'pointer' : 'default',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '12px',
                      color: hasEntry ? theme.text : `${theme.text}40`,
                      transition: 'all 0.2s ease',
                      fontFamily: '"Fira Code", monospace',
                    }}
                  >
                    {day.date.getDate()}
                  </button>
                );
              })}
            </div>
          ))}
        </div>

        {selectedHistoryDay && (
          <div style={{
            background: theme.card,
            borderRadius: '16px',
            padding: '24px',
            border: `1px solid ${theme.accent}50`,
            animation: 'fadeIn 0.3s ease',
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h3 style={{
                fontSize: '16px',
                fontWeight: 500,
                color: theme.text,
                margin: 0,
              }}>{formatDate(selectedHistoryDay.date)}</h3>
              {selectedHistoryDay.mood && (
                <span style={{
                  background: `${themes[selectedHistoryDay.mood]?.accent || theme.accent}30`,
                  color: themes[selectedHistoryDay.mood]?.accent || theme.accent,
                  padding: '6px 12px',
                  borderRadius: '8px',
                  fontSize: '12px',
                }}>{selectedHistoryDay.mood}</span>
              )}
            </div>

            {selectedHistoryDay.dream && (
              <div style={{ marginBottom: '18px' }}>
                <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>
                  Dream
                </p>
                <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>
                  {selectedHistoryDay.dream}
                </p>
              </div>
            )}

            {selectedHistoryDay.reflection && (
              <div style={{ marginBottom: '18px' }}>
                <p style={{ fontSize: '11px', color: theme.accent, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.08em', opacity: 0.8 }}>
                  Reflection
                </p>
                <p style={{ fontSize: '13px', color: theme.text, margin: 0, lineHeight: 1.6, opacity: 0.85 }}>
                  {selectedHistoryDay.reflection}
                </p>
              </div>
            )}

            <button
              onClick={() => setSelectedHistoryDay(null)}
              style={{
                marginTop: '10px',
                background: 'transparent',
                border: `1px solid ${theme.subtle}`,
                borderRadius: '10px',
                padding: '12px 20px',
                fontSize: '13px',
                color: theme.text,
                opacity: 0.7,
                cursor: 'pointer',
                width: '100%',
                fontFamily: '"Fira Code", monospace',
              }}
            >Close</button>
          </div>
        )}

        {entries.length === 0 && (
          <div style={{
            textAlign: 'center',
            padding: '40px 20px',
            color: theme.text,
            opacity: 0.5,
          }}>
            <p>No entries yet. Start journaling to see your history!</p>
          </div>
        )}
      </div>
    );
  };

  const WrappedView = () => {
    const recentEntries = entries.slice(0, 7);
    const moodCounts = {};
    recentEntries.forEach(e => {
      if (e.mood) {
        moodCounts[e.mood] = (moodCounts[e.mood] || 0) + 1;
      }
    });
    const topMoods = Object.entries(moodCounts).sort((a, b) => b[1] - a[1]).slice(0, 3).map(m => m[0]);
    
    const dreamsRemembered = recentEntries.filter(e => e.dream).length;
    const totalWords = recentEntries.reduce((acc, e) => {
      return acc + (e.dream?.split(' ').length || 0) + (e.reflection?.split(' ').length || 0);
    }, 0);

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: '20px', fontFamily: '"Fira Code", monospace' }}>
        <div style={{
          textAlign: 'center',
          paddingTop: '70px',
          paddingBottom: '10px',
        }}>
          <p style={{
            fontSize: '12px',
            color: theme.text,
            opacity: 0.4,
            marginBottom: '8px',
            textTransform: 'uppercase',
            letterSpacing: '0.1em',
          }}>This Week</p>
          <h1 style={{
            fontSize: '28px',
            fontWeight: 500,
            color: theme.text,
            margin: '0 0 4px 0',
          }}>‚ú¶ Your Wrapped</h1>
        </div>

        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(2, 1fr)',
          gap: '12px',
        }}>
          {[
            { label: 'Days logged', value: recentEntries.length, icon: 'üìù' },
            { label: 'Dreams', value: dreamsRemembered, icon: 'üí≠' },
            { label: 'Words', value: totalWords, icon: '‚úèÔ∏è' },
            { label: 'Streak', value: streak, icon: 'üî•' },
          ].map((stat, i) => (
            <div key={i} style={{
              background: theme.card,
              borderRadius: '14px',
              padding: '20px',
              textAlign: 'center',
              border: `1px solid ${theme.subtle}`,
            }}>
              <span style={{ fontSize: '24px', display: 'block', marginBottom: '10px' }}>{stat.icon}</span>
              <p style={{
                fontSize: '28px',
                fontWeight: 500,
                color: theme.text,
                margin: '0 0 4px 0',
              }}>{stat.value}</p>
              <p style={{
                fontSize: '11px',
                color: theme.text,
                opacity: 0.5,
                margin: 0,
              }}>{stat.label}</p>
            </div>
          ))}
        </div>

        {topMoods.length > 0 && (
          <div style={{
            background: theme.card,
            borderRadius: '14px',
            padding: '20px',
            border: `1px solid ${theme.subtle}`,
          }}>
            <h3 style={{
              fontSize: '14px',
              fontWeight: 500,
              color: theme.text,
              margin: '0 0 16px 0',
            }}>Your vibes this week</h3>
            <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
              {topMoods.map((mood, i) => (
                <span key={i} style={{
                  background: `${themes[mood]?.accent || theme.accent}25`,
                  color: themes[mood]?.accent || theme.accent,
                  padding: '10px 18px',
                  borderRadius: '10px',
                  fontSize: '13px',
                  border: `1px solid ${themes[mood]?.accent || theme.accent}30`,
                }}>{mood}</span>
              ))}
            </div>
          </div>
        )}

        <div style={{
          background: `${theme.accent}12`,
          borderRadius: '14px',
          padding: '22px',
          borderLeft: `3px solid ${theme.accent}`,
        }}>
          <h3 style={{
            fontSize: '14px',
            fontWeight: 500,
            color: theme.accent,
            margin: '0 0 12px 0',
            display: 'flex',
            alignItems: 'center',
            gap: '8px',
          }}>
            <span>‚ú®</span> Weekly Insight
          </h3>
          <p style={{
            fontSize: '14px',
            color: theme.text,
            margin: 0,
            lineHeight: 1.7,
            opacity: 0.85,
          }}>
            {topMoods.length > 0 ? (
              <>You've been feeling most <span style={{ color: theme.accent, fontWeight: 500 }}>{topMoods[0]}</span> this week. 
              Your dreams have featured themes of exploration and freedom. 
              Consider: what new territory are you ready to explore?</>
            ) : (
              <>Start journaling to discover patterns in your dreams and moods!</>
            )}
          </p>
        </div>

        <div style={{
          background: `linear-gradient(135deg, ${theme.accent}20 0%, ${theme.accent}10 100%)`,
          borderRadius: '14px',
          padding: '28px',
          textAlign: 'center',
          border: `1px solid ${theme.accent}30`,
        }}>
          <span style={{ fontSize: '40px', display: 'block', marginBottom: '12px' }}>üî•</span>
          <p style={{
            fontSize: '22px',
            fontWeight: 500,
            color: theme.text,
            margin: '0 0 6px 0',
          }}>{streak} day streak!</p>
          <p style={{
            fontSize: '13px',
            color: theme.text,
            opacity: 0.6,
            margin: 0,
          }}>Keep going ‚Äî you're building something meaningful</p>
        </div>
      </div>
    );
  };

  // ============================================
  // MAIN RENDER
  // ============================================

  if (authLoading) {
    return (
      <div style={{ minHeight: '100vh', background: theme.bg }}>
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap');
          @keyframes spin { to { transform: rotate(360deg); } }
        `}</style>
        <LoadingScreen />
      </div>
    );
  }

  if (!user) {
    return (
      <div style={{ minHeight: '100vh', background: theme.bg }}>
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap');
        `}</style>
        <AuthScreen />
      </div>
    );
  }

  return (
    <div style={{
      minHeight: '100vh',
      background: theme.bg,
      fontFamily: '"SF Mono", "Fira Code", Consolas, monospace',
      transition: 'background 0.5s ease',
    }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap');
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        ::placeholder { color: ${theme.text}40; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: ${theme.bg}; }
        ::-webkit-scrollbar-thumb { background: ${theme.accent}40; border-radius: 3px; }
      `}</style>
      
      <Header />
      
      <div style={{
        maxWidth: '480px',
        margin: '0 auto',
        padding: '20px 20px 120px 20px',
      }}>
        {entriesLoading ? (
          <LoadingScreen />
        ) : (
          <>
            {currentView === 'home' && <HomeView />}
            {currentView === 'goals' && <GoalsView />}
            {currentView === 'history' && <HistoryView />}
            {currentView === 'wrapped' && <WrappedView />}
          </>
        )}
      </div>
      
      <NavBar />
    </div>
  );
};

export default DaylightJournal;